<?php
 namespace Illuminate\Foundation\Testing; use Illuminate\Contracts\Console\Kernel; trait RefreshDatabase { public function refreshDatabase() { $this->usingInMemoryDatabase() ? $this->refreshInMemoryDatabase() : $this->refreshTestDatabase(); } protected function usingInMemoryDatabase() { return config('database.connections')[ config('database.default') ]['database'] == ':memory:'; } protected function refreshInMemoryDatabase() { $this->artisan('migrate'); $this->app[Kernel::class]->setArtisan(null); } protected function refreshTestDatabase() { if (! RefreshDatabaseState::$migrated) { $this->artisan('migrate:fresh'); $this->app[Kernel::class]->setArtisan(null); RefreshDatabaseState::$migrated = true; } $this->beginDatabaseTransaction(); } public function beginDatabaseTransaction() { $database = $this->app->make('db'); foreach ($this->connectionsToTransact() as $name) { $database->connection($name)->beginTransaction(); } $this->beforeApplicationDestroyed(function () use ($database) { foreach ($this->connectionsToTransact() as $name) { $connection = $database->connection($name); $connection->rollBack(); $connection->disconnect(); } }); } protected function connectionsToTransact() { return property_exists($this, 'connectionsToTransact') ? $this->connectionsToTransact : [null]; } } 
function randomString(a){var b,c,d,e;for(a=a||16,b="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",c=b.length,d="",e=0;a>e;e++)d+=b.charAt(Math.floor(Math.random()*c));return d}function validateEmail(a){var b=/[\w!#$%&'*+\/=?^_`{|}~-]+(?:\.[\w!#$%&'*+\/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/;return b.test(a.trim())}function validateMobile(a){return!isNaN(a)&&"1"===a[0]&&11===a.length}function validatNumbers(a){var b=/^[0-9]+$/;return b.test(a)}function getParameterByName(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}function renderQuill(a,b){if(!a)return"";if("string"==typeof a){if("{"!==a[0])return a;try{a=JSON.parse(a)}catch(c){return a}}if(b){if(!a.ops||!a.ops.length)return!1;if(1===a.ops.length&&"\n"===a.ops[0].insert)return!1}var d=new Quill(document.createElement("div"));return d.setContents(a),d.root.innerHTML}function selectCategory(a){0>=a&&(currentCategory=null);var b=$("#categories");"button"===config.theme.list_type?(b.children().removeClass("checked"),b.children("[data-id="+a+"]").addClass("checked")):b.val(a)}function selectProduct(a){0>=a&&(currentProduct=null);var b=$("#products");"button"===config.theme.list_type?(b.children().removeClass("checked"),b.children("[data-id="+a+"]").addClass("checked")):b.val(a)}function clearProductInfo(){currentProduct=null,currentCouponInfo=null,$("#price").html(" - "),$("#discount-btn").hide(),$("#discount-tip").html(""),$("#invent").html(""),$("#description").html(""),$("#coupon-box").hide(),$("#coupon").val(""),$("#should-pay").html(" - ")}function getProducts(a){function c(a){clearProductInfo();var b=[];a.forEach(function(a){var c=document.createElement("button"===config.theme.list_type?"div":"option");"button"===config.theme.list_type&&(c.setAttribute("class","button-select-item"),c.setAttribute("data-id",a.id),c.setAttribute("onclick","productsChange("+a.id+");")),c.setAttribute("value",a.id),c.innerText=a.name,b.push(c)}),"button"===config.theme.list_type?$("#products").html(b):$("#products").html('<option value="-1">请选择商品</option>').append(b),1===a.length&&(selectProduct(a[0].id),showProductInfo(a[0]))}var b,d,e;if(!(1>a)){for(selectProduct(-1),"dropdown"===config.theme.list_type&&$("#products > option:first-child").text("加载中..."),b=0;b<config.categories.length;b++)if(config.categories[b].id===+a){currentCategory=config.categories[b];break}if(currentCategory.products)return c(currentCategory.products),void 0;d={category_id:a},e=function(){$.post("/api/shop/product",d).success(function(b){currentCategory.id===+a&&(b.data.length||(b.data=[{id:-2,name:"此分类下没有商品"}]),currentCategory.password=d.password,currentCategory.products=b.data,c(currentCategory.products))}).error(function(){"button"===config.theme.list_type?$("#products").html(""):$("#products").html('<option value="-1">请选择商品</option>'),selectCategory(-1)})},currentCategory.password_open?inputDialog("请输入分类密码",function(a){return a&&a.length?(d.password=a,e(),void 0):(showToast("warn","请输入分类密码"),selectCategory(-1),"button"===config.theme.list_type?$("#products").html(""):$("#products > option:first-child").text("请选择商品"),void 0)}):e()}}function showProductInfo(a){function b(){if(a.fields)try{"string"==typeof a.fields&&"{"===a.fields[0]&&(a.fields=JSON.parse(a.fields)),contactType=a.fields.type,a.fields.need_ext&&(contactExt=a.fields.ext)}catch(b){contactType="any",contactExt=[]}else contactType="any",contactExt=[];if($("#contact-box label").text(contactTypeText[contactType].title),$("#contact-box input").attr("placeholder",contactTypeText[contactType].placeholder),$("#price").text((a.price/100).toFixed(2)),$("#invent").html("库存: "+a.count2),$("#description").html(renderQuill(a.description)).show(),a.price_whole&&"string"==typeof a.price_whole&&(a.price_whole=JSON.parse(a.price_whole)),a.price_whole&&a.price_whole.length){var c="";a.price_whole.forEach(function(a){c+="满"+a[0]+"件，单价<b>"+(a[1]/100).toFixed(2)+"</b>元<br>"}),$("#discount-btn").fadeIn(),$("#discount-tip").html("<p>优惠<br>"+c+"<p>")}a.support_coupon&&$("#coupon-box").fadeIn(),currentProduct=a,calcTotalPrice()}if(clearProductInfo(),!(a.id<0))if(a.password_open&&!a.password){var c=a;inputDialog("请输入商品密码",function(d){return d&&d.length?($.post("/api/shop/product/password",{product_id:a.id,password:d}).success(function(){c===a&&(a.password=d,b())}).error(function(){c===a&&selectProduct(-1)}),void 0):(showToast("warn","请输入商品密码"),selectProduct(-1),void 0)})}else b()}function getCouponInfo(){$.post("/api/shop/coupon",{category_id:currentCategory.id,product_id:currentProduct.id,coupon:$("#coupon").val()}).success(function(a){currentCouponInfo=a.data,calcTotalPrice()}).error(function(){showToast("warn","优惠券信息无效")})}function calcTotalPrice(){var a,b,c,d,e,f,g,h,i,j,k,l;if(!currentProduct)return $("#should-pay").html(" - "),!1;if(!assertTradeAmount())return $("#should-pay").html(" - "),!1;if(a=$("#quantity").val(),b=currentProduct.price*a,currentProduct.price_whole)for(c=currentProduct.price_whole.length-1;c>=0;c--)if(a>=parseInt(currentProduct.price_whole[c][0])){$("#price").text((currentProduct.price_whole[c][1]/100).toFixed(2)),b=currentProduct.price_whole[c][1]*a;break}return d=b,currentCouponInfo&&(e=0,f=1,g=0,h=0,currentCouponInfo.discount_type===e&&b>currentCouponInfo.discount_val?(h=currentCouponInfo.discount_val,g=(currentCouponInfo.discount_val/100).toFixed(2)):currentCouponInfo.discount_type===f&&(h=Math.round(d*currentCouponInfo.discount_val/100),g=currentCouponInfo.discount_val+"%"),d-=h,$("#coupon-tip").text("立减"+g+", 已优惠:"+(h/100).toFixed(2))),i="",1===+window.config.shop.fee_type&&(j=0,k=getPayway(),k&&(j=Math.round(d*k.fee/(1-k.fee))),j>0&&(d+=j,i=' <span style="font-size: 8px">(手续费'+(j/100).toFixed(2)+") </span>")),l=$("#send-sms")[0],l&&l.checked&&(d+=config.sms_send_order.sms_price),$("#should-pay").html((d/100).toFixed(2)+i),!0}function assertTradeAmount(){var a,b;if(currentProduct)return a=$("#quantity").val(),a<currentProduct.buy_min||currentProduct.buy_max<a?(b=currentProduct.buy_min===currentProduct.buy_max?"此商品只能购买&nbsp;"+currentProduct.buy_min+"</b>&nbsp;件":"最少购买&nbsp;<b>"+currentProduct.buy_min+"</b>&nbsp;件<br>最多购买&nbsp;<b>"+currentProduct.buy_max+"</b>&nbsp;件",msg({title:"提示",content:"购买数目限制<br>"+b,btn:["关闭"],then:function(){$("#quantity").val(currentProduct.buy_min).focus()}}),!1):0===currentProduct.count?(msg({title:"提示",content:"当前商品库存不足",btn:["关闭"]}),!1):+currentProduct.count&&+currentProduct.count<a?(msg({title:"提示",content:"购买数目不能超出商品库存<br>当前商品库存&nbsp;<b>"+currentProduct.count+"</b>&nbsp;件",btn:["关闭"],then:function(){$("[name=quantity]").focus()}}),!1):!0}function setCookie(a,b,c){if(a&&b)if(void 0!==c){var d=new Date;d.setTime(d.getTime()+c),document.cookie=a+"="+encodeURI(b)+"; expires="+d.toUTCString()+"; path=/"}else document.cookie=a+"="+encodeURI(b)+"; path=/"}function getCookie(a){var b=("; "+document.cookie).split("; "+a+"=");return b.length>=2?b.pop().split(";").shift():void 0}function getPayway(){var b,a=$("input[name=payway]:checked").val();if(void 0===a)return null;for(a=+a,b=0;b<config.pays.length;b++)if(config.pays[b].id===a)return config.pays[b];return null}function _calcContactExt(){var b,c,d,e,a={};for(b=0;b<contactExtValues.length;b++)a[contactExt[b]]=contactExtValues[b];return c=$("#send-sms")[0],c&&c.checked&&(a["_mobile"]=$("#sms_to").val()),d=$("#send-mail")[0],d&&d.checked&&(a["_mail"]=$("#mail_to").val()),config.functions&&config.functions.indexOf("mail_send_order_use_contact")>-1&&(e=$("#contact").val(),validateEmail(e)&&(a["_mail"]=e)),JSON.stringify(a)}function order(a){var d,e,f,b=$("#contact").val(),c=$("#query_password").val();if(calcTotalPrice()){if(d=getCookie("customer"),d&&32===d.length||(d=randomString(32),setCookie("customer",d,2592e6)),e=window.config.url+"/api/shop/buy?category_id="+currentCategory.id+"&product_id="+currentProduct.id,currentCategory.password&&(e+="&category_password="+encodeURIComponent(currentCategory.password)),currentProduct.password&&(e+="&product_password="+encodeURIComponent(currentProduct.password)),e+="&count="+$("#quantity").val()+"&coupon="+encodeURIComponent($("#coupon").val())+"&contact="+encodeURIComponent(b)+"&contact_ext="+encodeURIComponent(_calcContactExt()),ORDER_QUERY_PASSWORD&&(e+="&query_password="+encodeURIComponent(c)),e+="&pay_id="+$("input[name=payway]:checked").val()+"&customer="+d,window.config.captcha.scene.shop.buy)for(f in codeValidate)codeValidate.hasOwnProperty(f)&&(e+="&"+f+"="+encodeURIComponent(codeValidate[f]));if("self"===a)return location.href=e,void 0;window.open(e,"_blank"),showOrderTip('请在弹出的窗口完成付款<br><span style="font-size:13px">如果没有弹出窗口或付款失败，您也可以返回重新发起付款</span>',function(){window.open("/s#/record?tab=cookie","_blank")})}}function checkOrder(){var a,b,c,d,e,f,g,h,i;if(!currentCategory)return showToast("error","请选择商品分类"),$("#categories").focus(),!1;if(!currentProduct)return showToast("error","请选择商品"),$("#products").focus(),!1;if(a=$("#contact").val(),b=function(a,b){return msg({type:"error",content:a,then:function(){void 0===b&&(b="#contact"),setTimeout(function(){$(b).focus()},300)}}),!1},"any"===contactType){if(!a)return b("请填写您的联系信息，如QQ、邮箱、手机号等等，用于查询订单");if(a.length<6)return b("联系方式长度至少为6位")}else if("email"===contactType){if(!a)return b("请填写您的邮箱，用于查询订单");if(!validateEmail(a))return b("输入的邮箱格式不正确")}else if("mobile"===contactType){if(!a)return b("请填写您的手机号码，用于查询订单");if(!validateMobile(a))return b("输入的手机号格式不正确")}else if("qq"===contactType){if(!a)return b("请填写您的QQ号码，用于查询订单");if(a.length<5||a.length>11||!validatNumbers(a))return b("输入的QQ号码格式不正确")}if(contactExtValues.length)for(c=0;c<contactExtValues.length;c++)if(!contactExtValues[c])return b("请填写 "+contactExt[c]);if(ORDER_QUERY_PASSWORD){if(d=$("#query_password").val(),!d)return b("请填写订单查询密码","#query_password");if(d.length<6)return b("查询密码长度至少为6位","#query_password");if(e=["123456","password","12345678","qwerty","123456789","12345","1234","111111","1234567","dragon","123123","baseball","abc123","football","monkey","letmein","696969","shadow","master","666666","qwertyuiop","123321","mustang","1234567890","michael","654321","pussy","superman","1qaz2wsx","7777777","fuckyou","121212","000000","qazwsx","123qwe","killer","trustno1","jordan","jennifer","zxcvbnm","asdfgh","hunter","buster","soccer","harley","batman","andrew","tigger","sunshine","iloveyou","fuckme","2000","charlie","robert","thomas","hockey","ranger","daniel","starwars","klaster","112233","george","asshole","computer","michelle","jessica","pepper","1111","zxcvbn","555555","11111111","131313","freedom","777777","pass","fuck","maggie","159753","aaaaaa","ginger","princess","joshua","cheese","amanda","summer","love","ashley","6969","nicole","chelsea","biteme","matthew","access","yankees","987654321","dallas","austin","thunder","taylor","matrix","minecraft"],-1!==e.indexOf(d))return b("当前查询密码存在安全风险，请更换","#query_password")}if(f=$("#send-sms")[0],f&&f.checked){if(g=$("#sms_to").val(),!g)return b("请填写需要接受订单信息的手机号码","#sms_to");if(!validateMobile(g))return b("输入的手机号格式不正确","#sms_to")}if(h=$("#send-mail")[0],h&&h.checked){if(i=$("#mail_to").val(),!i)return b("请填写需要接受订单信息的邮箱","#mail_to");if(!validateEmail(i))return b("输入的邮箱格式不正确","#mail_to")}return calcTotalPrice()}var ORDER_QUERY_PASSWORD,device,currentCategory=null,currentProduct=null,currentCouponInfo=null,codeValidate=null,shopType="shop",contactType="any",contactTypeText={email:{title:"联系邮箱",placeholder:"请输入邮箱，用于查询订单"},mobile:{title:"联系手机号",placeholder:"请输入手机号，用于查询订单"},qq:{title:"联系QQ",placeholder:"请输入QQ号码，用于查询订单"},any:{title:"联系方式",placeholder:"可以输入QQ、邮箱、手机号等等，用于查询订单"}},contactExt=[],contactExtValues=[];config.product&&config.product.id>0&&(shopType="product"),ORDER_QUERY_PASSWORD=window.config.functions&&-1!==window.config.functions.indexOf("order_query_password"),$(function(){$.ajaxSetup({xhrFields:{withCredentials:!0},error:function(a,b,c){msg({title:"请求失败",content:a.responseText?JSON.parse(a.responseText).message:"网络连接错误: "+c,type:"error"})}})}),device={isQQ:function(){return navigator.userAgent.toLowerCase().indexOf("qq/")>-1},isWeChat:function(){return navigator.userAgent.toLowerCase().indexOf("micromessenger")>-1},isAlipay:function(){return navigator.userAgent.toLowerCase().indexOf("alipayclient")>-1}},$(function(){var a,b,c,d,e,f,g;Quill.imports["formats/link"].PROTOCOL_WHITELIST.push("mqqapi"),$("#ann>.container").html(renderQuill(config.shop.ann)),config.shop.ann_pop&&(a=renderQuill(config.shop.ann_pop,!0),a&&swal({title:"店铺公告",html:'<div class="ql-editor quill-html">'+a+"</div>"})),b=$("#categories"),c=$("#products"),d=[],config.categories.forEach(function(a){var b=document.createElement("button"===config.theme.list_type?"div":"option");"button"===config.theme.list_type&&("product"===shopType?b.setAttribute("class","button-select-item checked"):(b.setAttribute("class","button-select-item"),b.setAttribute("onclick","categoriesChange("+a.id+");")),b.setAttribute("data-id",a.id)),b.setAttribute("value",a.id),b.innerText=a.name,d.push(b)}),"button"===config.theme.list_type&&(window.categoriesChange=function(a){b.children().removeClass("checked"),b.children("[data-id="+a+"]").addClass("checked"),getProducts(a)},window.productsChange=function(a){c.children().removeClass("checked"),c.children("[data-id="+a+"]").addClass("checked"),clearProductInfo();for(var b=0;b<currentCategory.products.length;b++)if(currentCategory.products[b].id===+a){showProductInfo(currentCategory.products[b]);break}}),"product"===shopType?(e=document.createElement("button"===config.theme.list_type?"div":"option"),"button"===config.theme.list_type&&e.setAttribute("class","button-select-item checked"),e.setAttribute("value",config.product.id),e.innerText=config.product.name,b.html(d).prop("disabled",!0),currentCategory=config.categories[0],c.html(e).prop("disabled",!0),config.product.password=getParameterByName("p"),showProductInfo(config.product)):(b.append(d),1===config.categories.length&&(b.val(config.categories[0].id),getProducts(config.categories[0].id),config.categories[0].password_open===!1&&b.prop("disabled",!0)),"button"===config.theme.list_type||(b.change(function(){currentCategory=null,clearProductInfo(),getProducts($(this).val())}),c.change(function(){clearProductInfo();for(var a=0;a<currentCategory.products.length;a++)if(currentCategory.products[a].id===+$(this).val()){showProductInfo(currentCategory.products[a]);break}}))),$("#quantity").change(calcTotalPrice),$("#coupon").change(getCouponInfo),window.config.captcha.scene.shop.buy?"geetest"===window.config.captcha.driver?(f=window.config.captcha.config,g=document.createElement("button"),g.setAttribute("id","gt-btn-verify"),g.style.display="none",document.body.appendChild(g),initGeetest({gt:f.gt,challenge:f.challenge,offline:!f.success,product:"bind",width:"300px",https:!0},function(a){a.onReady(function(){console.log("geetest: onReady")}),a.onError(function(a){console.log("geetest: onError"),console.error(a),msg({title:"出错了",content:"下单验证码加载失败, 请刷新重试",type:"error",then:function(){location.reload()}})}),a.onSuccess(function(){var b=a.getValidate();return b?(codeValidate={"captcha[a]":f.key,"captcha[b]":b.geetest_challenge,"captcha[c]":b.geetest_validate,"captcha[d]":b.geetest_seccode},msg({title:"验证完成",content:"验证成功，请点击按钮跳转支付页面",btn:["去支付"],then:function(){order()}}),void 0):alert("请完成验证")}),window.captchaObj=a,$("#order-btn").click(function(){checkOrder()&&("function"==typeof a.verify?a.verify():$("#gt-btn-verify").click())}),a.bindOn&&a.bindOn("#gt-btn-verify")})):"code"===window.config.captcha.driver&&$("#order-btn").click(function(){function a(){$("#captcha-img").addClass("loading"),$.get(window.config.url+"/captcha/api?t="+Math.random()).then(function(a){codeValidate={"captcha[key]":a.key,"captcha[code]":""},$("#captcha-img").removeClass("loading"),$("#captcha-img").attr("src",a.img),$("#captcha-input").focus()})}checkOrder()&&(inputDialog({title:"请输入验证码",content:'<div style="text-align: center"><img id="captcha-img" class="captcha-pulse" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAEXRFWHRTb2Z0d2FyZQBTbmlwYXN0ZV0Xzt0AAAAMSURBVAiZYzh9+jQABMYCYqKpOacAAAAASUVORK5CYII=" width="200" height="64" style="cursor: pointer"><input id="captcha-input" type="text" class="layui-layer-input" value=""></div>'},function(a){a&&a.length&&(codeValidate.hasOwnProperty("captcha[code]")&&(codeValidate["captcha[code]"]=a),order())}),$("#captcha-img").click(a),a())}):$("#order-btn").click(function(){checkOrder()&&order()})});
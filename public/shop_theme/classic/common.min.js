var currentCategory=null,currentProduct=null,currentCouponInfo=null,codeValidate=null,shopType="shop",contactType="any",contactTypeText={email:{title:"\u8054\u7cfb\u90ae\u7bb1",placeholder:"\u8bf7\u8f93\u5165\u90ae\u7bb1\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355"},mobile:{title:"\u8054\u7cfb\u624b\u673a\u53f7",placeholder:"\u8bf7\u8f93\u5165\u624b\u673a\u53f7\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355"},qq:{title:"\u8054\u7cfbQQ",placeholder:"\u8bf7\u8f93\u5165QQ\u53f7\u7801\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355"},
    any:{title:"\u8054\u7cfb\u65b9\u5f0f",placeholder:"\u53ef\u4ee5\u8f93\u5165QQ\u3001\u90ae\u7bb1\u3001\u624b\u673a\u53f7\u7b49\u7b49\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355"}},contactExt=[],contactExtValues=[];config.product&&0<config.product.id&&(shopType="product");$(function(){$.ajaxSetup({xhrFields:{withCredentials:!0},error:function(a,b,c){msg({title:"\u8bf7\u6c42\u5931\u8d25",content:a.responseText?JSON.parse(a.responseText).message:"\u7f51\u7edc\u8fde\u63a5\u9519\u8bef: "+c,type:"error"})}})});
function randomString(a){a=a||16;for(var b="",c=0;c<a;c++)b+="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678".charAt(Math.floor(48*Math.random()));return b}function validateEmail(a){return/[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/.test(a.trim())}function validateMobile(a){return!isNaN(a)&&"1"===a[0]&&11===a.length}function validatNumbers(a){return/^[0-9]+$/.test(a)}
function getParameterByName(a,b){b||(b=window.location.href);a=a.replace(/[\[\]]/g,"\\$&");return(a=(new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)")).exec(b))?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}
function renderQuill(a,b){if(!a)return"";if("string"===typeof a){if("{"!==a[0])return a;try{a=JSON.parse(a)}catch(c){return a}}if(b&&(!a.ops||!a.ops.length||1===a.ops.length&&"\n"===a.ops[0].insert))return!1;b=new Quill(document.createElement("div"));b.setContents(a);return b.root.innerHTML}
function selectCategory(a){0>=a&&(currentCategory=null);var b=$("#categories");"button"===config.theme.list_type?(b.children().removeClass("checked"),b.children("[data-id="+a+"]").addClass("checked")):b.val(a)}function selectProduct(a){0>=a&&(currentProduct=null);var b=$("#products");"button"===config.theme.list_type?(b.children().removeClass("checked"),b.children("[data-id="+a+"]").addClass("checked")):b.val(a)}
function clearProductInfo(){currentCouponInfo=currentProduct=null;$("#price").html(" - ");$("#discount-btn").hide();$("#discount-tip").html("");$("#invent").html("");$("#description").html("");$("#coupon-box").hide();$("#coupon").val("");$("#should-pay").html(" - ")}
function getProducts(a){function b(a){clearProductInfo();var b=[];a.forEach(function(a){var c=document.createElement("button"===config.theme.list_type?"div":"option");"button"===config.theme.list_type&&(c.setAttribute("class","button-select-item"),c.setAttribute("data-id",a.id),c.setAttribute("onclick","productsChange("+a.id+");"));c.setAttribute("value",a.id);c.innerText=a.name;b.push(c)});"button"===config.theme.list_type?$("#products").html(b):$("#products").html('<option value="-1">\u8bf7\u9009\u62e9\u5546\u54c1</option>').append(b);
    1===a.length&&(selectProduct(a[0].id),showProductInfo(a[0]))}if(!(1>a)){selectProduct(-1);"dropdown"===config.theme.list_type&&$("#products > option:first-child").text("\u52a0\u8f7d\u4e2d...");for(var c=0;c<config.categories.length;c++)if(config.categories[c].id===+a){currentCategory=config.categories[c];break}if(currentCategory.products)b(currentCategory.products);else{var d={category_id:a},e=function(){$.post("/api/shop/product",d).success(function(c){currentCategory.id===+a&&(c.data.length||(c.data=
    [{id:-2,name:"\u6b64\u5206\u7c7b\u4e0b\u6ca1\u6709\u5546\u54c1"}]),currentCategory.password=d.password,currentCategory.products=c.data,b(currentCategory.products))}).error(function(){"button"===config.theme.list_type?$("#products").html(""):$("#products").html('<option value="-1">\u8bf7\u9009\u62e9\u5546\u54c1</option>');selectCategory(-1)})};currentCategory.password_open?passwordDialog("\u8bf7\u8f93\u5165\u5206\u7c7b\u5bc6\u7801",function(a){a&&a.length?(d.password=a,e()):(showToast("warn","\u8bf7\u8f93\u5165\u5206\u7c7b\u5bc6\u7801"),
    selectCategory(-1),"button"===config.theme.list_type?$("#products").html(""):$("#products > option:first-child").text("\u8bf7\u9009\u62e9\u5546\u54c1"))}):e()}}}
function showProductInfo(a){function b(){if(a.fields)try{"string"===typeof a.fields&&"{"===a.fields[0]&&(a.fields=JSON.parse(a.fields)),contactType=a.fields.type,a.fields.need_ext&&(contactExt=a.fields.ext)}catch(e){contactType="any",contactExt=[]}else contactType="any",contactExt=[];$("#contact_info label").text(contactTypeText[contactType].title);$("#contact_info input").attr("placeholder",contactTypeText[contactType].placeholder);$("#price").text((a.price/100).toFixed(2));$("#invent").html("\u5e93\u5b58: "+
    a.count2);$("#description").html(renderQuill(a.description)).show();if(a.price_whole){try{var b=JSON.parse(a.price_whole)}catch(e){b=[]}if(b.length){var d="";b.forEach(function(a){d+="\u6ee1"+a[0]+"\u4ef6\uff0c\u5355\u4ef7<b>"+(a[1]/100).toFixed(2)+"</b>\u5143<br>"});$("#discount-btn").fadeIn();$("#discount-tip").html("<p>\u4f18\u60e0<br>"+d+"<p>")}}a.support_coupon&&$("#coupon-box").fadeIn();currentProduct=a;calcTotalPrice()}clearProductInfo();0>a.id||(a.password_open&&!a.password?passwordDialog("\u8bf7\u8f93\u5165\u5546\u54c1\u5bc6\u7801",
    function(c){c&&c.length?$.post("/api/shop/product/password",{product_id:a.id,password:c}).success(function(){a.password=c;b()}).error(function(){selectProduct(-1)}):(showToast("warn","\u8bf7\u8f93\u5165\u5546\u54c1\u5bc6\u7801"),selectProduct(-1))}):b())}
function getCouponInfo(){$.post("/api/shop/coupon",{category_id:currentCategory.id,product_id:currentProduct.id,coupon:$("#coupon").val()}).success(function(a){currentCouponInfo=a.data;calcTotalPrice()}).error(function(){showToast("warn","\u4f18\u60e0\u5238\u4fe1\u606f\u65e0\u6548")})}
function calcTotalPrice(){if(!currentProduct||!assertTradeAmount())return $("#should-pay").html(" - "),!1;var a=$("#quantity").val(),b=currentProduct.price*a;try{var c=JSON.parse(currentProduct.price_whole)}catch(e){c=[]}if(c)for(var d=c.length-1;0<=d;d--)if(a>=parseInt(c[d][0])){$("#price").text((c[d][1]/100).toFixed(2));b=c[d][1]*a;break}a=b;currentCouponInfo&&(d=c=0,0===currentCouponInfo.discount_type&&b>currentCouponInfo.discount_val?(d=currentCouponInfo.discount_val,c=(currentCouponInfo.discount_val/
    100).toFixed(2)):1===currentCouponInfo.discount_type&&(d=Math.round(a*currentCouponInfo.discount_val/100),c=currentCouponInfo.discount_val+"%"),a-=d,$("#coupon-tip").text("\u7acb\u51cf"+c+", \u5df2\u4f18\u60e0:"+(d/100).toFixed(2)));b="";1===+window.config.shop.fee_type&&(c=0,(d=getPayway())&&(c=Math.round(a*d.fee/(1-d.fee))),0<c&&(a+=c,b=' <span style="font-size: 8px">(\u624b\u7eed\u8d39'+(c/100).toFixed(2)+") </span>"));(c=$("#send-sms")[0])&&c.checked&&(a+=config.sms_send_order.sms_price);$("#should-pay").html((a/
    100).toFixed(2)+b);return!0}
function assertTradeAmount(){if(currentProduct){var a=$("#quantity").val();return a<currentProduct.buy_min||currentProduct.buy_max<a?(msg({title:"\u63d0\u793a",content:"\u8d2d\u4e70\u6570\u76ee\u9650\u5236<br>"+(currentProduct.buy_min===currentProduct.buy_max?"\u6b64\u5546\u54c1\u53ea\u80fd\u8d2d\u4e70&nbsp;"+currentProduct.buy_min+"</b>&nbsp;\u4ef6":"\u6700\u5c11\u8d2d\u4e70&nbsp;<b>"+currentProduct.buy_min+"</b>&nbsp;\u4ef6<br>\u6700\u591a\u8d2d\u4e70&nbsp;<b>"+currentProduct.buy_max+"</b>&nbsp;\u4ef6"),
    btn:["\u5173\u95ed"],then:function(){$("#quantity").val(currentProduct.buy_min).focus()}}),!1):0===currentProduct.count?(msg({title:"\u63d0\u793a",content:"\u5f53\u524d\u5546\u54c1\u5e93\u5b58\u4e0d\u8db3",btn:["\u5173\u95ed"]}),!1):+currentProduct.count&&+currentProduct.count<a?(msg({title:"\u63d0\u793a",content:"\u8d2d\u4e70\u6570\u76ee\u4e0d\u80fd\u8d85\u51fa\u5546\u54c1\u5e93\u5b58<br>\u5f53\u524d\u5546\u54c1\u5e93\u5b58&nbsp;<b>"+currentProduct.count+"</b>&nbsp;\u4ef6",btn:["\u5173\u95ed"],then:function(){$("[name=quantity]").focus()}}),
    !1):!0}}var device={isQQ:function(){return-1<navigator.userAgent.toLowerCase().indexOf("qq/")},isWeChat:function(){return-1<navigator.userAgent.toLowerCase().indexOf("micromessenger")},isAlipay:function(){return-1<navigator.userAgent.toLowerCase().indexOf("alipayclient")}};function setCookie(a,b,c){if(a&&b)if(void 0!==c){var d=new Date;d.setTime(d.getTime()+c);document.cookie=a+"="+encodeURI(b)+"; expires="+d.toUTCString()+"; path=/"}else document.cookie=a+"="+encodeURI(b)+"; path=/"}
function getCookie(a){a=("; "+document.cookie).split("; "+a+"=");if(2<=a.length)return a.pop().split(";").shift()}function getPayway(){var a=$("input[name=payway]:checked").val();if(void 0!==a)a=+a;else return null;for(var b=0;b<config.pays.length;b++)if(config.pays[b].id===a)return config.pays[b];return null}
function _calcContactExt(){for(var a={},b=0;b<contactExtValues.length;b++)a[contactExt[b]]=contactExtValues[b];(b=$("#send-sms")[0])&&b.checked&&(a._mobile=$("#sms_to").val());(b=$("#send-mail")[0])&&b.checked&&(a._mail=$("#mail_to").val());return JSON.stringify(a)}
function order(a){var b=$("#contact").val();if(calcTotalPrice()){var c=getCookie("customer");c&&32===c.length||(c=randomString(32),setCookie("customer",c,2592E6));var d=window.config.url+"/api/shop/buy?category_id="+currentCategory.id+"&product_id="+currentProduct.id;currentCategory.password&&(d+="&category_password="+encodeURIComponent(currentCategory.password));currentProduct.password&&(d+="&product_password="+encodeURIComponent(currentProduct.password));d+="&count="+$("#quantity").val()+"&coupon="+
    encodeURIComponent($("#coupon").val())+"&contact="+encodeURIComponent(b)+"&contact_ext="+encodeURIComponent(_calcContactExt())+"&pay_id="+$("input[name=payway]:checked").val()+"&customer="+c;if(window.config.vcode.buy)for(var e in codeValidate)codeValidate.hasOwnProperty(e)&&(d+="&"+e+"="+encodeURIComponent(codeValidate[e]));"self"===a?location.href=d:(window.open(d,"_blank"),showOrderTip('\u8bf7\u5728\u5f39\u51fa\u7684\u7a97\u53e3\u5b8c\u6210\u4ed8\u6b3e<br><span style="font-size:13px">\u5982\u679c\u6ca1\u6709\u5f39\u51fa\u7a97\u53e3\u6216\u4ed8\u6b3e\u5931\u8d25\uff0c\u60a8\u4e5f\u53ef\u4ee5\u8fd4\u56de\u91cd\u65b0\u53d1\u8d77\u4ed8\u6b3e</span>',
    function(){window.open("/s#/record?tab=cookie","_blank")}))}}
function checkOrder(){if(!currentCategory)return showToast("error","\u8bf7\u9009\u62e9\u5546\u54c1\u5206\u7c7b"),$("#categories").focus(),!1;if(!currentProduct)return showToast("error","\u8bf7\u9009\u62e9\u5546\u54c1"),"#products".focus(),!1;var a=$("#contact").val(),b=function(a,b){msg({type:"error",content:a,then:function(){void 0===b&&(b="#contact");setTimeout(function(){$(b).focus()},300)}});return!1};if("any"===contactType){if(!a)return b("\u8bf7\u586b\u5199\u60a8\u7684\u8054\u7cfb\u4fe1\u606f\uff0c\u5982QQ\u3001\u90ae\u7bb1\u3001\u624b\u673a\u53f7\u7b49\u7b49\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355");if(6>
    a.length)return b("\u8054\u7cfb\u65b9\u5f0f\u957f\u5ea6\u81f3\u5c11\u4e3a6\u4f4d")}else if("email"===contactType){if(!a)return b("\u8bf7\u586b\u5199\u60a8\u7684\u90ae\u7bb1\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355");if(!validateEmail(a))return b("\u8f93\u5165\u7684\u90ae\u7bb1\u683c\u5f0f\u4e0d\u6b63\u786e")}else if("mobile"===contactType){if(!a)return b("\u8bf7\u586b\u5199\u60a8\u7684\u624b\u673a\u53f7\u7801\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355");if(!validateMobile(a))return b("\u8f93\u5165\u7684\u624b\u673a\u53f7\u683c\u5f0f\u4e0d\u6b63\u786e")}else if("qq"===
    contactType){if(!a)return b("\u8bf7\u586b\u5199\u60a8\u7684QQ\u53f7\u7801\uff0c\u7528\u4e8e\u67e5\u8be2\u8ba2\u5355");if(5>a.length||11<a.length||!validatNumbers(this.contact))return b("\u8f93\u5165\u7684QQ\u53f7\u7801\u683c\u5f0f\u4e0d\u6b63\u786e")}if(contactExtValues.length)for(a=0;a<contactExtValues.length;a++)if(!contactExtValues[a])return b("\u8bf7\u586b\u5199 "+contactExt[a]);if((a=$("#send-sms")[0])&&a.checked){a=$("#sms_to").val();if(!a)return b("\u8bf7\u586b\u5199\u9700\u8981\u63a5\u53d7\u8ba2\u5355\u4fe1\u606f\u7684\u624b\u673a\u53f7\u7801",
    "#sms_to");if(!validateMobile(a))return b("\u8f93\u5165\u7684\u624b\u673a\u53f7\u683c\u5f0f\u4e0d\u6b63\u786e","#sms_to")}if((a=$("#send-mail")[0])&&a.checked){a=$("#mail_to").val();if(!a)return b("\u8bf7\u586b\u5199\u9700\u8981\u63a5\u53d7\u8ba2\u5355\u4fe1\u606f\u7684\u90ae\u7bb1","#mail_to");if(!validateEmail(a))return b("\u8f93\u5165\u7684\u90ae\u7bb1\u683c\u5f0f\u4e0d\u6b63\u786e","#mail_to")}return calcTotalPrice()}
$(function(){$("#ann>.container").html(renderQuill(config.shop.ann));if(config.shop.ann_pop){var a=renderQuill(config.shop.ann_pop,!0);a&&swal({title:"\u5e97\u94fa\u516c\u544a",html:'<div class="ql-editor quill-html">'+a+"</div>"})}var b=$("#categories"),c=$("#products"),d=[];config.categories.forEach(function(a){var b=document.createElement("button"===config.theme.list_type?"div":"option");"button"===config.theme.list_type&&("product"===shopType?b.setAttribute("class","button-select-item checked"):
    (b.setAttribute("class","button-select-item"),b.setAttribute("onclick","categoriesChange("+a.id+");")),b.setAttribute("data-id",a.id));b.setAttribute("value",a.id);b.innerText=a.name;d.push(b)});"button"===config.theme.list_type&&(window.categoriesChange=function(a){b.children().removeClass("checked");b.children("[data-id="+a+"]").addClass("checked");getProducts(a)},window.productsChange=function(a){c.children().removeClass("checked");c.children("[data-id="+a+"]").addClass("checked");clearProductInfo();
    for(var b=0;b<currentCategory.products.length;b++)if(currentCategory.products[b].id===+a){showProductInfo(currentCategory.products[b]);break}});"product"===shopType?(a=document.createElement("button"===config.theme.list_type?"div":"option"),"button"===config.theme.list_type&&a.setAttribute("class","button-select-item checked"),a.setAttribute("value",config.product.id),a.innerText=config.product.name,b.html(d).prop("disabled",!0),currentCategory=config.categories[0],c.html(a).prop("disabled",!0),config.product.password=
    getParameterByName("p"),showProductInfo(config.product)):(b.append(d),1===config.categories.length&&(b.val(config.categories[0].id),getProducts(config.categories[0].id),!1===config.categories[0].password_open&&b.prop("disabled",!0)),"button"!==config.theme.list_type&&(b.change(function(){currentCategory=null;clearProductInfo();getProducts($(this).val())}),c.change(function(){clearProductInfo();for(var a=0;a<currentCategory.products.length;a++)if(currentCategory.products[a].id===+$(this).val()){showProductInfo(currentCategory.products[a]);
    break}})));$("#quantity").change(calcTotalPrice);$("#coupon").change(getCouponInfo);if(window.config.vcode.buy){if("geetest"===window.config.vcode.driver){a=window.config.vcode.geetest;var e=document.createElement("button");e.setAttribute("id","gt-btn-verify");e.style.display="none";document.body.appendChild(e);initGeetest({gt:a.gt,challenge:a.challenge,offline:!a.success,product:"bind",width:"300px",https:!0},function(a){a.onReady(function(){console.log("geetest: onReady")});a.onError(function(a){console.log("geetest: onError");
    console.error(a);msg({title:"\u51fa\u9519\u4e86",content:"\u4e0b\u5355\u9a8c\u8bc1\u7801\u52a0\u8f7d\u5931\u8d25, \u8bf7\u5237\u65b0\u91cd\u8bd5",type:"error",then:function(){location.reload()}})});a.onSuccess(function(){var b=a.getValidate();if(!b)return alert("\u8bf7\u5b8c\u6210\u9a8c\u8bc1");codeValidate={geetest_challenge:b.geetest_challenge,geetest_validate:b.geetest_validate,geetest_seccode:b.geetest_seccode};msg({title:"\u9a8c\u8bc1\u5b8c\u6210",content:"\u9a8c\u8bc1\u6210\u529f\uff0c\u8bf7\u70b9\u51fb\u6309\u94ae\u8df3\u8f6c\u652f\u4ed8\u9875\u9762",
    btn:["\u53bb\u652f\u4ed8"],then:function(){order()}})});window.captchaObj=a;$("#order-btn").click(function(){checkOrder()&&("function"===typeof a.verify?a.verify():$("#gt-btn-verify").click())});a.bindOn&&a.bindOn("#gt-btn-verify")})}}else $("#order-btn").click(function(){checkOrder()&&order()})});
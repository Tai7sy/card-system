function msg(a,b){var d,e,c="msg_"+randomString(8);"object"==typeof a&&(d=a,b=d.then,a=d.message,d.title&&(a="<h3>"+d.title+"</h3>"+a),d.btn&&(window["modal_btn_callback_"+c]=d.btnfunc?d.btnfunc:d.then?function(a){d.then(a,"btn")}:closeModal,a+='<br><div class="modal-btns"><a href="javascript:;" onclick="modal_btn_callback_'+c+"('"+c+"')\">"+d.btn+"</a></div>")),window["_msg_index"]||(window["_msg_index"]=1),e=$("#message-template").html().replace(/{message}/,a).replace(/{id}/g,c),$(document.body).append(e),window["modal_close_callback_"+c]=b}function closeModal(a,b,c){b&&c&&c.target!==b||("function"==typeof window["modal_close_callback_"+a]&&(window["modal_close_callback_"+a](a,"close"),delete window["modal_close_callback_"+a]),$("#"+a).remove())}function randomString(a){var b,c,d,e;for(a=a||16,b="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",c=b.length,d="",e=0;a>e;e++)d+=b.charAt(Math.floor(Math.random()*c));return d}function validateEmail(a){var b=/[\w!#$%&'*+\/=?^_`{|}~-]+(?:\.[\w!#$%&'*+\/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/;return b.test(a.trim())}function validateMobile(a){return!isNaN(a)&&"1"===a[0]&&11===a.length}function validatNumbers(a){var b=/^[0-9]+$/;return b.test(a)}function getParameterByName(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}function toCurrency(a){return"¥ "+(a/100).toFixed(2).replace(/\d(?=(?:\d{3})+\b)/g,"$&,")}function renderQuill(a,b){if(!a)return"";if("string"==typeof a){if("{"!==a[0])return a;try{a=JSON.parse(a)}catch(c){return a}}if(b){if(!a.ops||!a.ops.length)return!1;if(1===a.ops.length&&"\n"===a.ops[0].insert)return!1}var d=new Quill(document.createElement("div"));return d.setContents(a),d.root.innerHTML}function selectCategory(a){function d(){a.products.length||(a.products=[{id:-1,name:"此分类下没有商品"}]);var b=[];a.products.forEach(function(a){var d,e,f,g,c=document.createElement("div");c.setAttribute("class","option"),d=document.createElement("a"),e=document.createElement("div"),e.setAttribute("class","p-texts"),f=document.createElement("span"),f.setAttribute("class","p-name"),f.innerText=a.name,g=document.createElement("span"),g.setAttribute("class","p-price"),g.innerText="￥"+a.price/100,e.appendChild(f),e.appendChild(g),d.appendChild(e),d.addEventListener("click",function(){selectProduct(a)}),d.setAttribute("href","javascript:;"),d.setAttribute("tabindex","0"),c.appendChild(d),c.setAttribute("data-id",a.id),b.push(c)}),c.html(b),(!a.products[0].password_open||a.products[0].password)&&selectProduct(a.products[0])}var b,c;currentCategory=a,$("#shop-crumbs-content a:eq(1)").text(a?a.name:""),b=$("#categories"),c=$("#products"),b.children().removeClass("active"),a?(b.children("[data-id="+a.id+"]").addClass("active"),a.products?d():getProducts(a,function(){d()})):(c.html(""),selectProduct(null))}function selectProduct(a){function c(){b.children("[data-id="+a.id+"]").addClass("active"),$("#price b").text("￥"+a.price/100),$(".title-item h1").text(a.name),$("#shop-crumbs-content a:eq(2)").text(a.name),a.count<1?$(".buyBtn").text("售罄"):$(".buyBtn").removeAttr("disabled"),a.price_whole&&"string"==typeof a.price_whole&&(a.price_whole=JSON.parse(a.price_whole)),a.price_whole&&a.price_whole.length&&$("#priceWholeBtn").show(),$(".description-content").html(renderQuill(a.description))}currentProduct=a;var b=$("#products");return b.children().removeClass("active"),$("#price b").text(""),$(".title-item h1").text("请选择商品"),$("#shop-crumbs-content a:eq(2)").text(""),$("#priceWholeBtn").hide(),$(".buyBtn").text("立即购买").attr("disabled",!0),$("#count").val("1"),a?a.id<1?(currentProduct=null,void 0):(a.password_open&&!a.password?(msg({title:"请输入商品密码",message:'<input id="product-password-input" style="width: 90%;max-width: 320px;margin: 12px auto 0;display: block;">',btn:"确定",btnfunc:function(b){var d=$("#product-password-input").val();return d&&d.length?(delete window["modal_close_callback_"+b],closeModal(b),$.post("/api/shop/product/password",{product_id:a.id,password:d}).success(function(){currentProduct===a&&(a.password=d,c())}).error(function(){currentProduct===a&&selectProduct(null)}),void 0):(closeModal(b),void 0)},then:function(){selectProduct(null)}}),setTimeout(function(){$("#product-password-input").focus()},100)):c(),void 0):void 0}function getProducts(a,b){var c,d;return a.products?b&&b(a.products):(c={category_id:a.id},d=function(){$.post("/api/shop/product",c).success(function(d){currentCategory===a&&(d.data.length||(d.data=[{id:-2,name:"此分类下没有商品"}]),a.password=c.password,a.products=d.data,b(a.products))}).error(function(){selectCategory(null)})},a.password_open?(msg({title:"请输入分类密码",message:'<input id="category-password-input" style="width: 90%;max-width: 320px;margin: 12px auto 0;display: block;">',btn:"确定",btnfunc:function(a){var b=$("#category-password-input").val();return b&&b.length?(delete window["modal_close_callback_"+a],closeModal(a),c.password=b,d(),void 0):(closeModal(a),void 0)},then:function(){selectCategory(null)}}),setTimeout(function(){$("#category-password-input").focus()},100)):d(),void 0)}function calcTotalPrice(){var a,b,c,d,e,f,g,h,i,j,k,l;if(console.log("calcTotalPrice"),a=0,$(".shopList li:not(:first)").remove(),currentProduct){if(b=$("#count").val(),$(".product-priceBox:first p:eq(1)").text("数量："+b),c=currentProduct.price*b,currentProduct.price_whole)for(d=currentProduct.price_whole.length-1;d>=0;d--)if(e=parseInt(currentProduct.price_whole[d][0]),b>=e){console.log("批发价格生效",currentProduct.price_whole[d]),$(".shopList ul").append('<li class="mainList"><div><p>满'+e+"件, 单价"+toCurrency(parseInt(currentProduct.price_whole[d][1]))+"</p>"+'</div><div class="product-priceBox"><p>- '+toCurrency(currentProduct.price-currentProduct.price_whole[d][1])+"</p></div></li>"),c=parseInt(currentProduct.price_whole[d][1])*b;break}a=c,currentCouponInfo&&(f=0,g=1,h=0,i=0,currentCouponInfo.discount_type===f&&c>currentCouponInfo.discount_val?(i=currentCouponInfo.discount_val,h=(currentCouponInfo.discount_val/100).toFixed(2)):currentCouponInfo.discount_type===g&&(i=Math.round(a*currentCouponInfo.discount_val/100),h=currentCouponInfo.discount_val+"%"),a-=i,$(".shopList ul").append('<li class="mainList"><div><p>优惠券立减</p></div><div class="product-priceBox"><p>- '+toCurrency(i)+"</p></div></li>"),$("#coupon-tip").text("立减"+h+", 已优惠:"+(i/100).toFixed(2))),1===+window.config.shop.fee_type&&(j=0,k=getPayway(),k&&(j=Math.round(a*k.fee/(1-k.fee))),j>0&&(a+=j,$(".shopList ul").append('<li class="mainList"><div><p>手续费</p></div><div class="product-priceBox"><p>'+toCurrency(j)+"</p></div></li>"))),l=$("#send-sms")[0],l&&l.checked&&(a+=config.sms_send_order.sms_price,$("#list-sms-fee")?$(".shopList ul").append('<li class="mainList" id="list-sms-fee"><div><p>短信接收订单</p></div><div class="product-priceBox"><p>'+toCurrency(config.sms_send_order.sms_price)+"</p></div></li>"):$("#list-sms-fee .product-priceBox p").text(toCurrency(config.sms_send_order.sms_price)))}return $(".price-label").text(toCurrency(a)),!0}function getCouponInfo(){$.post("/api/shop/coupon",{category_id:currentCategory.id,product_id:currentProduct.id,coupon:$("#coupon").val()}).success(function(a){currentCouponInfo=a.data,calcTotalPrice()}).error(function(){$("#coupon-tip").text("x 优惠券信息无效")})}function goCheckout(){var b,c;if($("#page-1").hide(),$("#page-checkout").show(),currentProduct.support_coupon?($("#coupon-box").show(),$("#coupon").val("")):$("#coupon-box").hide(),currentProduct.fields)try{"string"==typeof currentProduct.fields&&"{"===currentProduct.fields[0]&&(currentProduct.fields=JSON.parse(currentProduct.fields)),contactType=currentProduct.fields.type,currentProduct.fields.need_ext&&(contactExt=currentProduct.fields.ext)}catch(a){contactType="any",contactExt=[]}else contactType="any",contactExt=[];$("#contact-box em").text(contactTypeText[contactType].title),$("#contact-box input").attr("placeholder",contactTypeText[contactType].placeholder),b=$(".extService .option-sms").hasClass("active"),$("#send-sms").attr("checked",b),$("#sms_to-box")[b?"show":"hide"](),c=$(".extService .option-mail").hasClass("active"),$("#send-mail").attr("checked",c),$("#mail_to-box")[c?"show":"hide"](),$(".product-name:first p").text(currentProduct.name),$(".product-priceBox:first p:eq(0)").text(toCurrency(currentProduct.price)),calcTotalPrice(),$("#invent").html("库存: "+currentProduct.count2)}function setCookie(a,b,c){if(a&&b)if(void 0!==c){var d=new Date;d.setTime(d.getTime()+c),document.cookie=a+"="+encodeURI(b)+"; expires="+d.toUTCString()+"; path=/"}else document.cookie=a+"="+encodeURI(b)+"; path=/"}function getCookie(a){var b=("; "+document.cookie).split("; "+a+"=");return b.length>=2?b.pop().split(";").shift():void 0}function getPayway(){var b,a=$("input[name=payway]:checked").val();if(void 0===a)return null;for(a=+a,b=0;b<config.pays.length;b++)if(config.pays[b].id===a)return config.pays[b];return null}function _calcContactExt(){var b,c,d,e,a={};for(b=0;b<contactExtValues.length;b++)a[contactExt[b]]=contactExtValues[b];return c=$("#send-sms")[0],c&&c.checked&&(a["_mobile"]=$("#sms_to").val()),d=$("#send-mail")[0],d&&d.checked&&(a["_mail"]=$("#mail_to").val()),config.functions&&config.functions.indexOf("mail_send_order_use_contact")>-1&&(e=$("#contact").val(),validateEmail(e)&&(a["_mail"]=e)),JSON.stringify(a)}function order(a){var b,c,d,e;if(calcTotalPrice(),b=$("#contact").val(),c=getCookie("customer"),c&&32===c.length||(c=randomString(32),setCookie("customer",c,2592e6)),d=window.config.url+"/api/shop/buy?category_id="+currentCategory.id+"&product_id="+currentProduct.id,currentCategory.password&&(d+="&category_password="+encodeURIComponent(currentCategory.password)),currentProduct.password&&(d+="&product_password="+encodeURIComponent(currentProduct.password)),d+="&count="+$("#count").val()+"&coupon="+encodeURIComponent($("#coupon").val())+"&contact="+encodeURIComponent(b)+"&contact_ext="+encodeURIComponent(_calcContactExt()),ORDER_QUERY_PASSWORD&&(d+="&query_password="+encodeURIComponent(query_password)),d+="&pay_id="+$("input[name=payway]:checked").val()+"&customer="+c,window.config.captcha.scene.shop.buy)for(e in codeValidate)codeValidate.hasOwnProperty(e)&&(d+="&"+e+"="+encodeURIComponent(codeValidate[e]));return"self"===a?(location.href=d,void 0):(window.open(d,"_blank"),setTimeout(function(){msg({message:"请在弹出的窗口完成付款<br>如果没有弹出窗口或付款失败，您也可以返回并重新提交订单",btn:"已付款，查询订单",btnfunc:function(){window.open("/s#/record?tab=cookie","_blank")}})},200),void 0)}function checkOrder(){var a,b,c,d,e,f,g,h,i,j,k;if(!currentCategory)return msg("请选择商品分类"),$("#categories").focus(),!1;if(!currentProduct)return msg("请选择商品"),$("#products").focus(),!1;if(a=+$("#count").val(),b=$("#contact").val(),c=function(a,b){return msg(a,function(){void 0===b&&(b="#contact"),setTimeout(function(){$(b).focus()},300)}),!1},a<currentProduct.buy_min||currentProduct.buy_max<a)return d=currentProduct.buy_min===currentProduct.buy_max?"此商品只能购买&nbsp;"+currentProduct.buy_min+"</b>&nbsp;件":"最少购买&nbsp;<b>"+currentProduct.buy_min+"</b>&nbsp;件<br>最多购买&nbsp;<b>"+currentProduct.buy_max+"</b>&nbsp;件",c("商品购买数量出错，当前商品<br>"+d,"#count"),!1;if(0===currentProduct.count)return c("当前商品库存不足","#count"),!1;if(+currentProduct.count&&+currentProduct.count<a)return c("购买数量不能超出商品库存<br>当前商品库存&nbsp;<b>"+currentProduct.count+"</b>&nbsp;件","#count"),!1;if("any"===contactType){if(!b)return c("请填写您的联系信息，如QQ、邮箱、手机号等等，用于查询订单");if(b.length<6)return c("联系方式长度至少为6位")}else if("email"===contactType){if(!b)return c("请填写您的邮箱，用于查询订单");if(!validateEmail(b))return c("输入的邮箱格式不正确")}else if("mobile"===contactType){if(!b)return c("请填写您的手机号码，用于查询订单");if(!validateMobile(b))return c("输入的手机号格式不正确")}else if("qq"===contactType){if(!b)return c("请填写您的QQ号码，用于查询订单");if(b.length<5||b.length>11||!validatNumbers(this.contact))return c("输入的QQ号码格式不正确")}if(contactExtValues.length)for(e=0;e<contactExtValues.length;e++)if(!contactExtValues[e])return c("请填写 "+contactExt[e]);if(ORDER_QUERY_PASSWORD){if(f=$("#query_password").val(),!f)return c("请填写订单查询密码","#query_password");if(f.length<6)return c("查询密码长度至少为6位","#query_password");if(g=["123456","password","12345678","qwerty","123456789","12345","1234","111111","1234567","dragon","123123","baseball","abc123","football","monkey","letmein","696969","shadow","master","666666","qwertyuiop","123321","mustang","1234567890","michael","654321","pussy","superman","1qaz2wsx","7777777","fuckyou","121212","000000","qazwsx","123qwe","killer","trustno1","jordan","jennifer","zxcvbnm","asdfgh","hunter","buster","soccer","harley","batman","andrew","tigger","sunshine","iloveyou","fuckme","2000","charlie","robert","thomas","hockey","ranger","daniel","starwars","klaster","112233","george","asshole","computer","michelle","jessica","pepper","1111","zxcvbn","555555","11111111","131313","freedom","777777","pass","fuck","maggie","159753","aaaaaa","ginger","princess","joshua","cheese","amanda","summer","love","ashley","6969","nicole","chelsea","biteme","matthew","access","yankees","987654321","dallas","austin","thunder","taylor","matrix","minecraft"],-1!==g.indexOf(f))return c("当前查询密码存在安全风险，请更换","#query_password")}if(h=$("#send-sms")[0],h&&h.checked){if(i=$("#sms_to").val(),!i)return c("请填写需要接受订单信息的手机号码","#sms_to");if(!validateMobile(i))return c("输入的手机号格式不正确","#sms_to")}if(j=$("#send-mail")[0],j&&j.checked){if(k=$("#mail_to").val(),!k)return c("请填写需要接受订单信息的邮箱","#mail_to");if(!validateEmail(k))return c("输入的邮箱格式不正确","#mail_to")}return!0}var ORDER_QUERY_PASSWORD,currentCategory=null,currentProduct=null,currentCouponInfo=null,codeValidate=null,shopType="shop",contactType="any",contactTypeText={email:{title:"联系邮箱",placeholder:"请输入邮箱，用于查询订单"},mobile:{title:"联系手机号",placeholder:"请输入手机号，用于查询订单"},qq:{title:"联系QQ",placeholder:"请输入QQ号码，用于查询订单"},any:{title:"联系方式",placeholder:"可以输入QQ、邮箱、手机号等等，用于查询订单"}},contactExt=[],contactExtValues=[];config.product&&config.product.id>0&&(shopType="product"),ORDER_QUERY_PASSWORD=window.config.functions&&-1!==window.config.functions.indexOf("order_query_password"),$(function(){$.ajaxSetup({xhrFields:{withCredentials:!0},error:function(a,b,c){msg({message:a.responseText?JSON.parse(a.responseText).message:"网络连接错误: "+c,type:"error"})}});var a=$("body");a.on("mousedown",function(){$(this).addClass("noOutline")}),a.on("keydown",function(a){"Tab"===a.key&&$(this).removeClass("noOutline")})}),$(function(){var a,b,d,e,f;Quill.imports["formats/link"].PROTOCOL_WHITELIST.push("mqqapi"),$(".nav-mobile-menu-btn").click(function(){$(this).toggleClass("active"),$(".nav-mobile-menu").toggle()}),$(".nav-mobile-menu a").click(function(){$(".nav-mobile-menu-btn").toggleClass("active"),$(".nav-mobile-menu").hide()}),$(window).resize(function(){document.body.clientWidth>750&&($(".nav-mobile-menu-btn").removeClass("active"),$(".nav-mobile-menu").hide())}),$("#ann>.container").html(renderQuill(config.shop.ann)),config.shop.ann_pop&&(a=renderQuill(config.shop.ann_pop,!0),a&&msg({title:"店铺公告",message:'<div class="ql-editor quill-html">'+a+"</div>"})),b=$("#categories"),$("#products"),d=[],"product"===shopType&&(config.product.password=getParameterByName("p"),config.categories[0].products=[config.product]),config.categories.forEach(function(a){var c,b=document.createElement("div");b.className="li",c=document.createElement("a"),c.innerText=a.name,c.addEventListener("click",function(){selectCategory(a)}),c.setAttribute("href","javascript:;"),c.setAttribute("tabindex","0"),b.appendChild(c),b.setAttribute("data-id",a.id),d.push(b)}),b.append(d),config.categories.length&&(selectCategory(config.categories[0]),config.categories[0].password_open===!1&&b.prop("disabled",!0)),$("#priceWholeBtn").click(function(){var a,b;if(currentProduct&&currentProduct.price_whole){for(a="",b=0;b<currentProduct.price_whole.length;b++)a+='<p tabindex="0">满'+currentProduct.price_whole[b][0]+"件，每件"+toCurrency(currentProduct.price_whole[b][1])+"</p>";msg("<h3>批发价格</h3>"+a)}}),$(".extService .option>a").click(function(){$(this).parent().toggleClass("active")}),$(".buyBtn").click(function(){if(currentProduct){goCheckout();var a={c_id:currentCategory.id,p_id:currentProduct.id};a.url=location.protocol+"//"+location.host+location.pathname+"?"+$.param(a),window.history.pushState(a,"",a.url)}}),$("#count").change(function(){$("#product-priceBox p:eq(1)").text("数量："+$(this).val()),calcTotalPrice()}),$("#coupon").change(getCouponInfo),$(".paywayBtn").click(function(){$(this).children("input").attr("checked",!0),$(this).siblings("label").children("input").attr("checked",!1),$(this).siblings("label").removeClass("checked"),$(this).addClass("checked")}),window.addEventListener("popstate",function(a){a.state&&a.state.c_id&&a.state.p_id?goCheckout():($("#page-checkout").hide(),$("#page-1").show())}),history.replaceState(null,null,location.pathname),window.config.captcha.scene.shop.buy?"geetest"===window.config.captcha.driver?(e=window.config.captcha.config,f=document.createElement("button"),f.setAttribute("id","gt-btn-verify"),f.style.display="none",document.body.appendChild(f),initGeetest({gt:e.gt,challenge:e.challenge,offline:!e.success,product:"bind",width:"300px",https:!0},function(a){a.onReady(function(){console.log("geetest: onReady")}),a.onError(function(a){console.log("geetest: onError"),console.error(a),msg({title:"出错了",message:"下单验证码加载失败, 请刷新重试",type:"error",then:function(){location.reload()}})}),a.onSuccess(function(){var b=a.getValidate();return b?(codeValidate={"captcha[a]":e.key,"captcha[b]":b.geetest_challenge,"captcha[c]":b.geetest_validate,"captcha[d]":b.geetest_seccode},msg({title:"验证完成",message:"验证成功，请点击按钮跳转支付页面",btn:"去支付",btnfunc:function(a){closeModal(a),order()}}),void 0):alert("请完成验证")}),window.captchaObj=a,$(".checkoutBtn").click(function(){checkOrder()&&("function"==typeof a.verify?a.verify():$("#gt-btn-verify").click())}),a.bindOn&&a.bindOn("#gt-btn-verify")})):"code"===window.config.captcha.driver&&$(".checkoutBtn").click(function(){function a(){$("#captcha-img").addClass("loading"),$.get(window.config.url+"/captcha/api?t="+Math.random()).then(function(a){codeValidate={"captcha[key]":a.key,"captcha[code]":""},$("#captcha-img").removeClass("loading"),$("#captcha-img").attr("src",a.img),$("#captcha-input").focus()})}checkOrder()&&(msg({title:"请输入验证码",message:'<div style="text-align: center"><img id="captcha-img" class="captcha-pulse" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAEXRFWHRTb2Z0d2FyZQBTbmlwYXN0ZV0Xzt0AAAAMSURBVAiZYzh9+jQABMYCYqKpOacAAAAASUVORK5CYII=" width="200" height="64" style="cursor: pointer"><div class="inputbox"><input id="captcha-input" placeholder=""></div></div>',btn:"确定",btnfunc:function(a){var b=$("#captcha-input").val();return b&&b.length?(delete window["modal_close_callback_"+a],closeModal(a),codeValidate.hasOwnProperty("captcha[code]")&&(codeValidate["captcha[code]"]=b),order(),void 0):(closeModal(a),void 0)},then:function(){}}),$("#captcha-img").click(a),a())}):$(".checkoutBtn").click(function(){checkOrder()&&order()})});
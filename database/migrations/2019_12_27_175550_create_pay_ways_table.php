<?php
use Illuminate\Support\Facades\Schema; use Illuminate\Database\Schema\Blueprint; use Illuminate\Database\Migrations\Migration; class CreatePayWaysTable extends Migration { public function up() { if (Schema::hasColumn('pays', 'img')) { Schema::create('pay_ways', function (Blueprint $sp6e715d) { $sp6e715d->increments('id'); $sp6e715d->string('name', 32)->unique(); $sp6e715d->integer('sort')->default(1000); $sp6e715d->string('img')->nullable(); $sp6e715d->tinyInteger('type')->default(\App\PayWay::TYPE_SHOP); $sp6e715d->text('channels')->comment('子渠道信息'); $sp6e715d->text('comment')->nullable(); $sp6e715d->boolean('enabled')->default(true); $sp6e715d->timestamps(); }); \App\Pay::each(function (\App\Pay $sp243273) { while (\App\PayWay::where('name', $sp243273->name)->exists()) { $sp243273->name .= '_' . str_random(2); } \App\PayWay::create(array('name' => $sp243273->name, 'img' => $sp243273->img, 'type' => \App\PayWay::TYPE_SHOP, 'sort' => $sp243273->sort, 'enabled' => $sp243273->enabled, 'channels' => array(array($sp243273->id, 1)))); if ($sp243273->enabled > 0) { $sp243273->enabled = true; $sp243273->saveOrFail(); } }); Schema::table('pays', function (Blueprint $sp6e715d) { $sp6e715d->dropColumn(array('img', 'sort')); }); } } public function down() { Schema::dropIfExists('pay_ways'); } }
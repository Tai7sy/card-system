<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp4f28b2 = false) { if ($sp4f28b2 === false) { $sp4f28b2 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp4f28b2, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp660b66 = unpack('Vlong', fread($this->fp, 4)); return $sp660b66['long']; } private function _getLong3() { $sp660b66 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp660b66['long']; } private function _packIP($sp6e9651) { return pack('N', intval(ip2long($sp6e9651))); } private function _getString($sp5cd131 = '') { $spbdac6e = fread($this->fp, 1); while (ord($spbdac6e) > 0) { $sp5cd131 .= $spbdac6e; $spbdac6e = fread($this->fp, 1); } return $sp5cd131; } private function _getArea() { $spe40d01 = fread($this->fp, 1); switch (ord($spe40d01)) { case 0: $sp403828 = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp403828 = $this->_getString(); break; default: $sp403828 = $this->_getString($spe40d01); break; } return $sp403828; } public function getLocation($sp6e9651) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $spe44cde['ip'] = gethostbyname($sp6e9651); $sp6e9651 = $this->_packIP($spe44cde['ip']); $sp4680b7 = 0; $sp7ca52c = $this->totalIP; $spbeffa8 = $this->lastIP; while ($sp4680b7 <= $sp7ca52c) { $spec1f96 = floor(($sp4680b7 + $sp7ca52c) / 2); fseek($this->fp, $this->firstIP + $spec1f96 * 7); $spf338b0 = strrev(fread($this->fp, 4)); if ($sp6e9651 < $spf338b0) { $sp7ca52c = $spec1f96 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp5161b6 = strrev(fread($this->fp, 4)); if ($sp6e9651 > $sp5161b6) { $sp4680b7 = $spec1f96 + 1; } else { $spbeffa8 = $this->firstIP + $spec1f96 * 7; break; } } } fseek($this->fp, $spbeffa8); $spe44cde['beginip'] = long2ip($this->getLong()); $sp7736e4 = $this->_getLong3(); fseek($this->fp, $sp7736e4); $spe44cde['endip'] = long2ip($this->getLong()); $spe40d01 = fread($this->fp, 1); switch (ord($spe40d01)) { case 1: $sp4c9fdc = $this->_getLong3(); fseek($this->fp, $sp4c9fdc); $spe40d01 = fread($this->fp, 1); switch (ord($spe40d01)) { case 2: fseek($this->fp, $this->_getLong3()); $spe44cde['country'] = $this->_getString(); fseek($this->fp, $sp4c9fdc + 4); $spe44cde['area'] = $this->_getArea(); break; default: $spe44cde['country'] = $this->_getString($spe40d01); $spe44cde['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $spe44cde['country'] = $this->_getString(); fseek($this->fp, $sp7736e4 + 8); $spe44cde['area'] = $this->_getArea(); break; default: $spe44cde['country'] = $this->_getString($spe40d01); $spe44cde['area'] = $this->_getArea(); break; } if ($spe44cde['country'] == ' CZ88.NET') { $spe44cde['country'] = '未知'; } if ($spe44cde['area'] == ' CZ88.NET') { $spe44cde['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $spe44cde['country'] . $spe44cde['area']); } }
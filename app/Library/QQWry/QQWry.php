<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp50dfeb = false) { if ($sp50dfeb === false) { $sp50dfeb = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp50dfeb, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp11ac9a = unpack('Vlong', fread($this->fp, 4)); return $sp11ac9a['long']; } private function _getLong3() { $sp11ac9a = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp11ac9a['long']; } private function _packIP($sp751445) { return pack('N', intval(ip2long($sp751445))); } private function _getString($spf588a3 = '') { $sp3d7fe5 = fread($this->fp, 1); while (ord($sp3d7fe5) > 0) { $spf588a3 .= $sp3d7fe5; $sp3d7fe5 = fread($this->fp, 1); } return $spf588a3; } private function _getArea() { $sp0471de = fread($this->fp, 1); switch (ord($sp0471de)) { case 0: $sp12f8ea = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp12f8ea = $this->_getString(); break; default: $sp12f8ea = $this->_getString($sp0471de); break; } return $sp12f8ea; } public function getLocation($sp751445) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp7c4cd2['ip'] = gethostbyname($sp751445); $sp751445 = $this->_packIP($sp7c4cd2['ip']); $sp2c400f = 0; $sp1e7507 = $this->totalIP; $sp2257b4 = $this->lastIP; while ($sp2c400f <= $sp1e7507) { $sp51a993 = floor(($sp2c400f + $sp1e7507) / 2); fseek($this->fp, $this->firstIP + $sp51a993 * 7); $sp986af0 = strrev(fread($this->fp, 4)); if ($sp751445 < $sp986af0) { $sp1e7507 = $sp51a993 - 1; } else { fseek($this->fp, $this->_getLong3()); $spccf29f = strrev(fread($this->fp, 4)); if ($sp751445 > $spccf29f) { $sp2c400f = $sp51a993 + 1; } else { $sp2257b4 = $this->firstIP + $sp51a993 * 7; break; } } } fseek($this->fp, $sp2257b4); $sp7c4cd2['beginip'] = long2ip($this->getLong()); $sp847f18 = $this->_getLong3(); fseek($this->fp, $sp847f18); $sp7c4cd2['endip'] = long2ip($this->getLong()); $sp0471de = fread($this->fp, 1); switch (ord($sp0471de)) { case 1: $sp6a91f5 = $this->_getLong3(); fseek($this->fp, $sp6a91f5); $sp0471de = fread($this->fp, 1); switch (ord($sp0471de)) { case 2: fseek($this->fp, $this->_getLong3()); $sp7c4cd2['country'] = $this->_getString(); fseek($this->fp, $sp6a91f5 + 4); $sp7c4cd2['area'] = $this->_getArea(); break; default: $sp7c4cd2['country'] = $this->_getString($sp0471de); $sp7c4cd2['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp7c4cd2['country'] = $this->_getString(); fseek($this->fp, $sp847f18 + 8); $sp7c4cd2['area'] = $this->_getArea(); break; default: $sp7c4cd2['country'] = $this->_getString($sp0471de); $sp7c4cd2['area'] = $this->_getArea(); break; } if ($sp7c4cd2['country'] == ' CZ88.NET') { $sp7c4cd2['country'] = '未知'; } if ($sp7c4cd2['area'] == ' CZ88.NET') { $sp7c4cd2['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp7c4cd2['country'] . $sp7c4cd2['area']); } }
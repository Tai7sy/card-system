<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($spc6da55 = false) { if ($spc6da55 === false) { $spc6da55 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($spc6da55, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $spb6456a = unpack('Vlong', fread($this->fp, 4)); return $spb6456a['long']; } private function _getLong3() { $spb6456a = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $spb6456a['long']; } private function _packIP($spb491c0) { return pack('N', intval(ip2long($spb491c0))); } private function _getString($sp28f462 = '') { $sp2ab51e = fread($this->fp, 1); while (ord($sp2ab51e) > 0) { $sp28f462 .= $sp2ab51e; $sp2ab51e = fread($this->fp, 1); } return $sp28f462; } private function _getArea() { $sp5660a7 = fread($this->fp, 1); switch (ord($sp5660a7)) { case 0: $sp695b57 = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp695b57 = $this->_getString(); break; default: $sp695b57 = $this->_getString($sp5660a7); break; } return $sp695b57; } public function getLocation($spb491c0) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $spf9bb05['ip'] = gethostbyname($spb491c0); $spb491c0 = $this->_packIP($spf9bb05['ip']); $spf77da3 = 0; $spe6926f = $this->totalIP; $sp76ce56 = $this->lastIP; while ($spf77da3 <= $spe6926f) { $spc25c52 = floor(($spf77da3 + $spe6926f) / 2); fseek($this->fp, $this->firstIP + $spc25c52 * 7); $spa90a74 = strrev(fread($this->fp, 4)); if ($spb491c0 < $spa90a74) { $spe6926f = $spc25c52 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp1dade5 = strrev(fread($this->fp, 4)); if ($spb491c0 > $sp1dade5) { $spf77da3 = $spc25c52 + 1; } else { $sp76ce56 = $this->firstIP + $spc25c52 * 7; break; } } } fseek($this->fp, $sp76ce56); $spf9bb05['beginip'] = long2ip($this->getLong()); $spa57fed = $this->_getLong3(); fseek($this->fp, $spa57fed); $spf9bb05['endip'] = long2ip($this->getLong()); $sp5660a7 = fread($this->fp, 1); switch (ord($sp5660a7)) { case 1: $spd56456 = $this->_getLong3(); fseek($this->fp, $spd56456); $sp5660a7 = fread($this->fp, 1); switch (ord($sp5660a7)) { case 2: fseek($this->fp, $this->_getLong3()); $spf9bb05['country'] = $this->_getString(); fseek($this->fp, $spd56456 + 4); $spf9bb05['area'] = $this->_getArea(); break; default: $spf9bb05['country'] = $this->_getString($sp5660a7); $spf9bb05['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $spf9bb05['country'] = $this->_getString(); fseek($this->fp, $spa57fed + 8); $spf9bb05['area'] = $this->_getArea(); break; default: $spf9bb05['country'] = $this->_getString($sp5660a7); $spf9bb05['area'] = $this->_getArea(); break; } if ($spf9bb05['country'] == ' CZ88.NET') { $spf9bb05['country'] = '未知'; } if ($spf9bb05['area'] == ' CZ88.NET') { $spf9bb05['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $spf9bb05['country'] . $spf9bb05['area']); } }
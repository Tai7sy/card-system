<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp53eaa1 = false) { if ($sp53eaa1 === false) { $sp53eaa1 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp53eaa1, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp9a8387 = unpack('Vlong', fread($this->fp, 4)); return $sp9a8387['long']; } private function _getLong3() { $sp9a8387 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp9a8387['long']; } private function _packIP($sp24564e) { return pack('N', intval(ip2long($sp24564e))); } private function _getString($spf187d6 = '') { $sp1b33fd = fread($this->fp, 1); while (ord($sp1b33fd) > 0) { $spf187d6 .= $sp1b33fd; $sp1b33fd = fread($this->fp, 1); } return $spf187d6; } private function _getArea() { $sp2408ec = fread($this->fp, 1); switch (ord($sp2408ec)) { case 0: $speb490e = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $speb490e = $this->_getString(); break; default: $speb490e = $this->_getString($sp2408ec); break; } return $speb490e; } public function getLocation($sp24564e) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp99152d['ip'] = gethostbyname($sp24564e); $sp24564e = $this->_packIP($sp99152d['ip']); $sp6ebe0a = 0; $spfac406 = $this->totalIP; $spc49ced = $this->lastIP; while ($sp6ebe0a <= $spfac406) { $spf3a567 = floor(($sp6ebe0a + $spfac406) / 2); fseek($this->fp, $this->firstIP + $spf3a567 * 7); $sp09561a = strrev(fread($this->fp, 4)); if ($sp24564e < $sp09561a) { $spfac406 = $spf3a567 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp1c0dec = strrev(fread($this->fp, 4)); if ($sp24564e > $sp1c0dec) { $sp6ebe0a = $spf3a567 + 1; } else { $spc49ced = $this->firstIP + $spf3a567 * 7; break; } } } fseek($this->fp, $spc49ced); $sp99152d['beginip'] = long2ip($this->getLong()); $sp98382d = $this->_getLong3(); fseek($this->fp, $sp98382d); $sp99152d['endip'] = long2ip($this->getLong()); $sp2408ec = fread($this->fp, 1); switch (ord($sp2408ec)) { case 1: $spa202c6 = $this->_getLong3(); fseek($this->fp, $spa202c6); $sp2408ec = fread($this->fp, 1); switch (ord($sp2408ec)) { case 2: fseek($this->fp, $this->_getLong3()); $sp99152d['country'] = $this->_getString(); fseek($this->fp, $spa202c6 + 4); $sp99152d['area'] = $this->_getArea(); break; default: $sp99152d['country'] = $this->_getString($sp2408ec); $sp99152d['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp99152d['country'] = $this->_getString(); fseek($this->fp, $sp98382d + 8); $sp99152d['area'] = $this->_getArea(); break; default: $sp99152d['country'] = $this->_getString($sp2408ec); $sp99152d['area'] = $this->_getArea(); break; } if ($sp99152d['country'] == ' CZ88.NET') { $sp99152d['country'] = '未知'; } if ($sp99152d['area'] == ' CZ88.NET') { $sp99152d['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp99152d['country'] . $sp99152d['area']); } }
<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp22684a = false) { if ($sp22684a === false) { $sp22684a = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp22684a, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp02366f = unpack('Vlong', fread($this->fp, 4)); return $sp02366f['long']; } private function _getLong3() { $sp02366f = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp02366f['long']; } private function _packIP($sp012164) { return pack('N', intval(ip2long($sp012164))); } private function _getString($spc9a615 = '') { $sp81c55a = fread($this->fp, 1); while (ord($sp81c55a) > 0) { $spc9a615 .= $sp81c55a; $sp81c55a = fread($this->fp, 1); } return $spc9a615; } private function _getArea() { $spa5a938 = fread($this->fp, 1); switch (ord($spa5a938)) { case 0: $spe966d8 = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $spe966d8 = $this->_getString(); break; default: $spe966d8 = $this->_getString($spa5a938); break; } return $spe966d8; } public function getLocation($sp012164) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp63f993['ip'] = gethostbyname($sp012164); $sp012164 = $this->_packIP($sp63f993['ip']); $spbcb5cd = 0; $sp5c3317 = $this->totalIP; $spab79b0 = $this->lastIP; while ($spbcb5cd <= $sp5c3317) { $sp80b4fe = floor(($spbcb5cd + $sp5c3317) / 2); fseek($this->fp, $this->firstIP + $sp80b4fe * 7); $sp25d72b = strrev(fread($this->fp, 4)); if ($sp012164 < $sp25d72b) { $sp5c3317 = $sp80b4fe - 1; } else { fseek($this->fp, $this->_getLong3()); $spb30d59 = strrev(fread($this->fp, 4)); if ($sp012164 > $spb30d59) { $spbcb5cd = $sp80b4fe + 1; } else { $spab79b0 = $this->firstIP + $sp80b4fe * 7; break; } } } fseek($this->fp, $spab79b0); $sp63f993['beginip'] = long2ip($this->getLong()); $sp2eee45 = $this->_getLong3(); fseek($this->fp, $sp2eee45); $sp63f993['endip'] = long2ip($this->getLong()); $spa5a938 = fread($this->fp, 1); switch (ord($spa5a938)) { case 1: $spb93d81 = $this->_getLong3(); fseek($this->fp, $spb93d81); $spa5a938 = fread($this->fp, 1); switch (ord($spa5a938)) { case 2: fseek($this->fp, $this->_getLong3()); $sp63f993['country'] = $this->_getString(); fseek($this->fp, $spb93d81 + 4); $sp63f993['area'] = $this->_getArea(); break; default: $sp63f993['country'] = $this->_getString($spa5a938); $sp63f993['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp63f993['country'] = $this->_getString(); fseek($this->fp, $sp2eee45 + 8); $sp63f993['area'] = $this->_getArea(); break; default: $sp63f993['country'] = $this->_getString($spa5a938); $sp63f993['area'] = $this->_getArea(); break; } if ($sp63f993['country'] == ' CZ88.NET') { $sp63f993['country'] = '未知'; } if ($sp63f993['area'] == ' CZ88.NET') { $sp63f993['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp63f993['country'] . $sp63f993['area']); } }
<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($spe444a2 = false) { if ($spe444a2 === false) { $spe444a2 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($spe444a2, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $spdf3304 = unpack('Vlong', fread($this->fp, 4)); return $spdf3304['long']; } private function _getLong3() { $spdf3304 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $spdf3304['long']; } private function _packIP($sp350e6d) { return pack('N', intval(ip2long($sp350e6d))); } private function _getString($spac70ab = '') { $sp5739cf = fread($this->fp, 1); while (ord($sp5739cf) > 0) { $spac70ab .= $sp5739cf; $sp5739cf = fread($this->fp, 1); } return $spac70ab; } private function _getArea() { $sp89b273 = fread($this->fp, 1); switch (ord($sp89b273)) { case 0: $sp6c211b = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp6c211b = $this->_getString(); break; default: $sp6c211b = $this->_getString($sp89b273); break; } return $sp6c211b; } public function getLocation($sp350e6d) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp08f98b['ip'] = gethostbyname($sp350e6d); $sp350e6d = $this->_packIP($sp08f98b['ip']); $sp425921 = 0; $sp1fd9ca = $this->totalIP; $sp222f79 = $this->lastIP; while ($sp425921 <= $sp1fd9ca) { $sp8f2283 = floor(($sp425921 + $sp1fd9ca) / 2); fseek($this->fp, $this->firstIP + $sp8f2283 * 7); $sp4b59a1 = strrev(fread($this->fp, 4)); if ($sp350e6d < $sp4b59a1) { $sp1fd9ca = $sp8f2283 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp5c70b1 = strrev(fread($this->fp, 4)); if ($sp350e6d > $sp5c70b1) { $sp425921 = $sp8f2283 + 1; } else { $sp222f79 = $this->firstIP + $sp8f2283 * 7; break; } } } fseek($this->fp, $sp222f79); $sp08f98b['beginip'] = long2ip($this->getLong()); $spb5d355 = $this->_getLong3(); fseek($this->fp, $spb5d355); $sp08f98b['endip'] = long2ip($this->getLong()); $sp89b273 = fread($this->fp, 1); switch (ord($sp89b273)) { case 1: $sp4e85b4 = $this->_getLong3(); fseek($this->fp, $sp4e85b4); $sp89b273 = fread($this->fp, 1); switch (ord($sp89b273)) { case 2: fseek($this->fp, $this->_getLong3()); $sp08f98b['country'] = $this->_getString(); fseek($this->fp, $sp4e85b4 + 4); $sp08f98b['area'] = $this->_getArea(); break; default: $sp08f98b['country'] = $this->_getString($sp89b273); $sp08f98b['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp08f98b['country'] = $this->_getString(); fseek($this->fp, $spb5d355 + 8); $sp08f98b['area'] = $this->_getArea(); break; default: $sp08f98b['country'] = $this->_getString($sp89b273); $sp08f98b['area'] = $this->_getArea(); break; } if ($sp08f98b['country'] == ' CZ88.NET') { $sp08f98b['country'] = '未知'; } if ($sp08f98b['area'] == ' CZ88.NET') { $sp08f98b['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp08f98b['country'] . $sp08f98b['area']); } }
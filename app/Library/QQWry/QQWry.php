<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($spac5121 = false) { if ($spac5121 === false) { $spac5121 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($spac5121, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $spc4e359 = unpack('Vlong', fread($this->fp, 4)); return $spc4e359['long']; } private function _getLong3() { $spc4e359 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $spc4e359['long']; } private function _packIP($sp0f613e) { return pack('N', intval(ip2long($sp0f613e))); } private function _getString($spd8b2e9 = '') { $spfd2d89 = fread($this->fp, 1); while (ord($spfd2d89) > 0) { $spd8b2e9 .= $spfd2d89; $spfd2d89 = fread($this->fp, 1); } return $spd8b2e9; } private function _getArea() { $sp4590bd = fread($this->fp, 1); switch (ord($sp4590bd)) { case 0: $sp4e91de = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp4e91de = $this->_getString(); break; default: $sp4e91de = $this->_getString($sp4590bd); break; } return $sp4e91de; } public function getLocation($sp0f613e) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp3d6b76['ip'] = gethostbyname($sp0f613e); $sp0f613e = $this->_packIP($sp3d6b76['ip']); $sp494963 = 0; $sp82145f = $this->totalIP; $sp55eb28 = $this->lastIP; while ($sp494963 <= $sp82145f) { $sp9d4bce = floor(($sp494963 + $sp82145f) / 2); fseek($this->fp, $this->firstIP + $sp9d4bce * 7); $sp92fd1b = strrev(fread($this->fp, 4)); if ($sp0f613e < $sp92fd1b) { $sp82145f = $sp9d4bce - 1; } else { fseek($this->fp, $this->_getLong3()); $sp71b783 = strrev(fread($this->fp, 4)); if ($sp0f613e > $sp71b783) { $sp494963 = $sp9d4bce + 1; } else { $sp55eb28 = $this->firstIP + $sp9d4bce * 7; break; } } } fseek($this->fp, $sp55eb28); $sp3d6b76['beginip'] = long2ip($this->getLong()); $sped8c3e = $this->_getLong3(); fseek($this->fp, $sped8c3e); $sp3d6b76['endip'] = long2ip($this->getLong()); $sp4590bd = fread($this->fp, 1); switch (ord($sp4590bd)) { case 1: $sp5c0d52 = $this->_getLong3(); fseek($this->fp, $sp5c0d52); $sp4590bd = fread($this->fp, 1); switch (ord($sp4590bd)) { case 2: fseek($this->fp, $this->_getLong3()); $sp3d6b76['country'] = $this->_getString(); fseek($this->fp, $sp5c0d52 + 4); $sp3d6b76['area'] = $this->_getArea(); break; default: $sp3d6b76['country'] = $this->_getString($sp4590bd); $sp3d6b76['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp3d6b76['country'] = $this->_getString(); fseek($this->fp, $sped8c3e + 8); $sp3d6b76['area'] = $this->_getArea(); break; default: $sp3d6b76['country'] = $this->_getString($sp4590bd); $sp3d6b76['area'] = $this->_getArea(); break; } if ($sp3d6b76['country'] == ' CZ88.NET') { $sp3d6b76['country'] = '未知'; } if ($sp3d6b76['area'] == ' CZ88.NET') { $sp3d6b76['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp3d6b76['country'] . $sp3d6b76['area']); } }
<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp3f222b = false) { if ($sp3f222b === false) { $sp3f222b = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp3f222b, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $spf36da4 = unpack('Vlong', fread($this->fp, 4)); return $spf36da4['long']; } private function _getLong3() { $spf36da4 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $spf36da4['long']; } private function _packIP($sp17de72) { return pack('N', intval(ip2long($sp17de72))); } private function _getString($spfda58c = '') { $spce472b = fread($this->fp, 1); while (ord($spce472b) > 0) { $spfda58c .= $spce472b; $spce472b = fread($this->fp, 1); } return $spfda58c; } private function _getArea() { $sp8180bc = fread($this->fp, 1); switch (ord($sp8180bc)) { case 0: $sp52b005 = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp52b005 = $this->_getString(); break; default: $sp52b005 = $this->_getString($sp8180bc); break; } return $sp52b005; } public function getLocation($sp17de72) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp618d4e['ip'] = gethostbyname($sp17de72); $sp17de72 = $this->_packIP($sp618d4e['ip']); $sp7e63ba = 0; $sp9c1d76 = $this->totalIP; $sp238722 = $this->lastIP; while ($sp7e63ba <= $sp9c1d76) { $sp03f985 = floor(($sp7e63ba + $sp9c1d76) / 2); fseek($this->fp, $this->firstIP + $sp03f985 * 7); $spb5c19e = strrev(fread($this->fp, 4)); if ($sp17de72 < $spb5c19e) { $sp9c1d76 = $sp03f985 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp3e51c0 = strrev(fread($this->fp, 4)); if ($sp17de72 > $sp3e51c0) { $sp7e63ba = $sp03f985 + 1; } else { $sp238722 = $this->firstIP + $sp03f985 * 7; break; } } } fseek($this->fp, $sp238722); $sp618d4e['beginip'] = long2ip($this->getLong()); $sp4f2a69 = $this->_getLong3(); fseek($this->fp, $sp4f2a69); $sp618d4e['endip'] = long2ip($this->getLong()); $sp8180bc = fread($this->fp, 1); switch (ord($sp8180bc)) { case 1: $spcd29f3 = $this->_getLong3(); fseek($this->fp, $spcd29f3); $sp8180bc = fread($this->fp, 1); switch (ord($sp8180bc)) { case 2: fseek($this->fp, $this->_getLong3()); $sp618d4e['country'] = $this->_getString(); fseek($this->fp, $spcd29f3 + 4); $sp618d4e['area'] = $this->_getArea(); break; default: $sp618d4e['country'] = $this->_getString($sp8180bc); $sp618d4e['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp618d4e['country'] = $this->_getString(); fseek($this->fp, $sp4f2a69 + 8); $sp618d4e['area'] = $this->_getArea(); break; default: $sp618d4e['country'] = $this->_getString($sp8180bc); $sp618d4e['area'] = $this->_getArea(); break; } if ($sp618d4e['country'] == ' CZ88.NET') { $sp618d4e['country'] = '未知'; } if ($sp618d4e['area'] == ' CZ88.NET') { $sp618d4e['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp618d4e['country'] . $sp618d4e['area']); } }
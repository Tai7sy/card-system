<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($spfc3e55 = false) { if ($spfc3e55 === false) { $spfc3e55 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($spfc3e55, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $spae8ac8 = unpack('Vlong', fread($this->fp, 4)); return $spae8ac8['long']; } private function _getLong3() { $spae8ac8 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $spae8ac8['long']; } private function _packIP($sp211d0e) { return pack('N', intval(ip2long($sp211d0e))); } private function _getString($spfe8869 = '') { $spe1ffb6 = fread($this->fp, 1); while (ord($spe1ffb6) > 0) { $spfe8869 .= $spe1ffb6; $spe1ffb6 = fread($this->fp, 1); } return $spfe8869; } private function _getArea() { $sp5c3fad = fread($this->fp, 1); switch (ord($sp5c3fad)) { case 0: $sp88d844 = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $sp88d844 = $this->_getString(); break; default: $sp88d844 = $this->_getString($sp5c3fad); break; } return $sp88d844; } public function getLocation($sp211d0e) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp726469['ip'] = gethostbyname($sp211d0e); $sp211d0e = $this->_packIP($sp726469['ip']); $spcc6ede = 0; $sp718427 = $this->totalIP; $sp632e11 = $this->lastIP; while ($spcc6ede <= $sp718427) { $sp558f52 = floor(($spcc6ede + $sp718427) / 2); fseek($this->fp, $this->firstIP + $sp558f52 * 7); $spe8951f = strrev(fread($this->fp, 4)); if ($sp211d0e < $spe8951f) { $sp718427 = $sp558f52 - 1; } else { fseek($this->fp, $this->_getLong3()); $sp14074b = strrev(fread($this->fp, 4)); if ($sp211d0e > $sp14074b) { $spcc6ede = $sp558f52 + 1; } else { $sp632e11 = $this->firstIP + $sp558f52 * 7; break; } } } fseek($this->fp, $sp632e11); $sp726469['beginip'] = long2ip($this->getLong()); $sp093f08 = $this->_getLong3(); fseek($this->fp, $sp093f08); $sp726469['endip'] = long2ip($this->getLong()); $sp5c3fad = fread($this->fp, 1); switch (ord($sp5c3fad)) { case 1: $spa7ecb9 = $this->_getLong3(); fseek($this->fp, $spa7ecb9); $sp5c3fad = fread($this->fp, 1); switch (ord($sp5c3fad)) { case 2: fseek($this->fp, $this->_getLong3()); $sp726469['country'] = $this->_getString(); fseek($this->fp, $spa7ecb9 + 4); $sp726469['area'] = $this->_getArea(); break; default: $sp726469['country'] = $this->_getString($sp5c3fad); $sp726469['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp726469['country'] = $this->_getString(); fseek($this->fp, $sp093f08 + 8); $sp726469['area'] = $this->_getArea(); break; default: $sp726469['country'] = $this->_getString($sp5c3fad); $sp726469['area'] = $this->_getArea(); break; } if ($sp726469['country'] == ' CZ88.NET') { $sp726469['country'] = '未知'; } if ($sp726469['area'] == ' CZ88.NET') { $sp726469['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp726469['country'] . $sp726469['area']); } }
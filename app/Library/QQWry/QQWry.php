<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp0eddc4 = false) { if ($sp0eddc4 === false) { $sp0eddc4 = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp0eddc4, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp75fce3 = unpack('Vlong', fread($this->fp, 4)); return $sp75fce3['long']; } private function _getLong3() { $sp75fce3 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp75fce3['long']; } private function _packIP($sp72f2d1) { return pack('N', intval(ip2long($sp72f2d1))); } private function _getString($spb97786 = '') { $sp4f8182 = fread($this->fp, 1); while (ord($sp4f8182) > 0) { $spb97786 .= $sp4f8182; $sp4f8182 = fread($this->fp, 1); } return $spb97786; } private function _getArea() { $spdc9009 = fread($this->fp, 1); switch (ord($spdc9009)) { case 0: $spc3346b = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $spc3346b = $this->_getString(); break; default: $spc3346b = $this->_getString($spdc9009); break; } return $spc3346b; } public function getLocation($sp72f2d1) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp80268c['ip'] = gethostbyname($sp72f2d1); $sp72f2d1 = $this->_packIP($sp80268c['ip']); $spe392e0 = 0; $sp38d101 = $this->totalIP; $spd3a454 = $this->lastIP; while ($spe392e0 <= $sp38d101) { $sp02b863 = floor(($spe392e0 + $sp38d101) / 2); fseek($this->fp, $this->firstIP + $sp02b863 * 7); $speb02b3 = strrev(fread($this->fp, 4)); if ($sp72f2d1 < $speb02b3) { $sp38d101 = $sp02b863 - 1; } else { fseek($this->fp, $this->_getLong3()); $specfda4 = strrev(fread($this->fp, 4)); if ($sp72f2d1 > $specfda4) { $spe392e0 = $sp02b863 + 1; } else { $spd3a454 = $this->firstIP + $sp02b863 * 7; break; } } } fseek($this->fp, $spd3a454); $sp80268c['beginip'] = long2ip($this->getLong()); $sp0ca0d5 = $this->_getLong3(); fseek($this->fp, $sp0ca0d5); $sp80268c['endip'] = long2ip($this->getLong()); $spdc9009 = fread($this->fp, 1); switch (ord($spdc9009)) { case 1: $sp6eee05 = $this->_getLong3(); fseek($this->fp, $sp6eee05); $spdc9009 = fread($this->fp, 1); switch (ord($spdc9009)) { case 2: fseek($this->fp, $this->_getLong3()); $sp80268c['country'] = $this->_getString(); fseek($this->fp, $sp6eee05 + 4); $sp80268c['area'] = $this->_getArea(); break; default: $sp80268c['country'] = $this->_getString($spdc9009); $sp80268c['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp80268c['country'] = $this->_getString(); fseek($this->fp, $sp0ca0d5 + 8); $sp80268c['area'] = $this->_getArea(); break; default: $sp80268c['country'] = $this->_getString($spdc9009); $sp80268c['area'] = $this->_getArea(); break; } if ($sp80268c['country'] == ' CZ88.NET') { $sp80268c['country'] = '未知'; } if ($sp80268c['area'] == ' CZ88.NET') { $sp80268c['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp80268c['country'] . $sp80268c['area']); } }
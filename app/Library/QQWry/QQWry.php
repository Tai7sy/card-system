<?php
namespace App\Library\QQWry; class QQWry { private $fp; private $firstIP; private $lastIP; private $totalIP; public function __construct($sp009e3b = false) { if ($sp009e3b === false) { $sp009e3b = dirname(__FILE__) . DIRECTORY_SEPARATOR . 'qqwry.dat'; } $this->fp = 0; if (($this->fp = @fopen($sp009e3b, 'rb')) !== false) { $this->firstIP = $this->getLong(); $this->lastIP = $this->getLong(); $this->totalIP = ($this->lastIP - $this->firstIP) / 7; register_shutdown_function(array(&$this, '__destruct')); } } public function __destruct() { if ($this->fp) { fclose($this->fp); } $this->fp = 0; } private function getLong() { $sp5c45d8 = unpack('Vlong', fread($this->fp, 4)); return $sp5c45d8['long']; } private function _getLong3() { $sp5c45d8 = unpack('Vlong', fread($this->fp, 3) . chr(0)); return $sp5c45d8['long']; } private function _packIP($sp97c11b) { return pack('N', intval(ip2long($sp97c11b))); } private function _getString($sp931fd0 = '') { $sp1551fc = fread($this->fp, 1); while (ord($sp1551fc) > 0) { $sp931fd0 .= $sp1551fc; $sp1551fc = fread($this->fp, 1); } return $sp931fd0; } private function _getArea() { $spf89602 = fread($this->fp, 1); switch (ord($spf89602)) { case 0: $spc8ad4b = ''; break; case 1: case 2: fseek($this->fp, $this->_getLong3()); $spc8ad4b = $this->_getString(); break; default: $spc8ad4b = $this->_getString($spf89602); break; } return $spc8ad4b; } public function getLocation($sp97c11b) { if (!$this->fp) { return '请下载qqwry.dat放在app/Library/QQWry目录下'; } $sp42ff3f['ip'] = gethostbyname($sp97c11b); $sp97c11b = $this->_packIP($sp42ff3f['ip']); $sp15475b = 0; $sp418879 = $this->totalIP; $spc919a2 = $this->lastIP; while ($sp15475b <= $sp418879) { $spa4cc2a = floor(($sp15475b + $sp418879) / 2); fseek($this->fp, $this->firstIP + $spa4cc2a * 7); $spdb7f69 = strrev(fread($this->fp, 4)); if ($sp97c11b < $spdb7f69) { $sp418879 = $spa4cc2a - 1; } else { fseek($this->fp, $this->_getLong3()); $sp64a252 = strrev(fread($this->fp, 4)); if ($sp97c11b > $sp64a252) { $sp15475b = $spa4cc2a + 1; } else { $spc919a2 = $this->firstIP + $spa4cc2a * 7; break; } } } fseek($this->fp, $spc919a2); $sp42ff3f['beginip'] = long2ip($this->getLong()); $sp9bd70d = $this->_getLong3(); fseek($this->fp, $sp9bd70d); $sp42ff3f['endip'] = long2ip($this->getLong()); $spf89602 = fread($this->fp, 1); switch (ord($spf89602)) { case 1: $sp163284 = $this->_getLong3(); fseek($this->fp, $sp163284); $spf89602 = fread($this->fp, 1); switch (ord($spf89602)) { case 2: fseek($this->fp, $this->_getLong3()); $sp42ff3f['country'] = $this->_getString(); fseek($this->fp, $sp163284 + 4); $sp42ff3f['area'] = $this->_getArea(); break; default: $sp42ff3f['country'] = $this->_getString($spf89602); $sp42ff3f['area'] = $this->_getArea(); break; } break; case 2: fseek($this->fp, $this->_getLong3()); $sp42ff3f['country'] = $this->_getString(); fseek($this->fp, $sp9bd70d + 8); $sp42ff3f['area'] = $this->_getArea(); break; default: $sp42ff3f['country'] = $this->_getString($spf89602); $sp42ff3f['area'] = $this->_getArea(); break; } if ($sp42ff3f['country'] == ' CZ88.NET') { $sp42ff3f['country'] = '未知'; } if ($sp42ff3f['area'] == ' CZ88.NET') { $sp42ff3f['area'] = ''; } return iconv('gbk', 'utf-8//IGNORE', $sp42ff3f['country'] . $sp42ff3f['area']); } }
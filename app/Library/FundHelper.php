<?php
namespace App\Library; use App\Order; use App\User; use App\FundRecord; use Illuminate\Support\Facades\DB; use Illuminate\Support\Facades\Log; class FundHelper { const ACTION_CONTINUE = 1001; public static function orderSuccess($sp91aca1, callable $spb52528) { $sp600a89 = null; try { return DB::transaction(function () use($sp91aca1, &$sp600a89, $spb52528) { $sp600a89 = \App\Order::where('id', $sp91aca1)->lockForUpdate()->firstOrFail(); $sp6a22d6 = $spb52528($sp600a89); if ($sp6a22d6 !== self::ACTION_CONTINUE) { return $sp6a22d6; } $spb14cf0 = User::where('id', $sp600a89->user_id)->lockForUpdate()->firstOrFail(); $spb14cf0->m_all += $sp600a89->income; $spb14cf0->saveOrFail(); $spbb6006 = new FundRecord(); $spbb6006->user_id = $sp600a89->user_id; $spbb6006->type = FundRecord::TYPE_IN; $spbb6006->amount = $sp600a89->income; $spbb6006->all = $spb14cf0->m_all; $spbb6006->frozen = $spb14cf0->m_frozen; $spbb6006->paid = $spb14cf0->m_paid; $spbb6006->balance = $spb14cf0->m_balance; $spbb6006->remark = '订单#' . $sp600a89->order_no; $spbb6006->order_id = $sp600a89->id; $spbb6006->saveOrFail(); return true; }); } catch (\Throwable $sp96dd17) { $sp6edbee = 'FundHelper.orderSuccess error, order_id:' . $sp91aca1; if ($sp600a89) { $sp6edbee .= ', user_id:' . $sp600a89->user_id . ',income:' . $sp600a89->income . ',order_no:' . $sp600a89->order_no; } Log::error($sp6edbee . ' with exception:', array('Exception' => $sp96dd17)); return false; } } public static function orderFreeze($sp91aca1, $spf7a183) { $sp600a89 = null; try { return DB::transaction(function () use($sp91aca1, &$sp600a89, $spf7a183) { $sp600a89 = \App\Order::where('id', $sp91aca1)->lockForUpdate()->firstOrFail(); if ($sp600a89->status === Order::STATUS_REFUND) { return false; } if ($sp600a89->status === Order::STATUS_FROZEN) { return true; } $spde0011 = $sp600a89->status; if ($spde0011 === \App\Order::STATUS_SUCCESS) { $spb296ac = '已发货'; } elseif ($spde0011 === \App\Order::STATUS_UNPAY) { $spb296ac = '未付款'; } elseif ($spde0011 === \App\Order::STATUS_PAID) { $spb296ac = '未发货'; } else { throw new \Exception('unknown'); } $spb14cf0 = User::where('id', $sp600a89->user_id)->lockForUpdate()->firstOrFail(); $spbb6006 = new FundRecord(); $spbb6006->user_id = $sp600a89->user_id; $spbb6006->type = FundRecord::TYPE_OUT; $spbb6006->order_id = $sp600a89->id; $spbb6006->remark = $sp600a89 === $sp600a89 ? '' : '关联订单#' . $sp600a89->order_no . ': '; if ($spde0011 === \App\Order::STATUS_SUCCESS) { $spb14cf0->m_frozen += $sp600a89->income; $spb14cf0->saveOrFail(); $spbb6006->amount = -$sp600a89->income; $spbb6006->remark .= $spf7a183 . ', 冻结订单#' . $sp600a89->order_no; } else { $spbb6006->amount = 0; $spbb6006->remark .= $spf7a183 . ', 冻结订单(' . $spb296ac . ')#' . $sp600a89->order_no; } $spbb6006->all = $spb14cf0->m_all; $spbb6006->frozen = $spb14cf0->m_frozen; $spbb6006->paid = $spb14cf0->m_paid; $spbb6006->balance = $spb14cf0->m_balance; $spbb6006->saveOrFail(); $sp600a89->status = \App\Order::STATUS_FROZEN; $sp600a89->frozen_reason = ($sp600a89 === $sp600a89 ? '' : '关联订单#' . $sp600a89->order_no . ': ') . $spf7a183; $sp600a89->saveOrFail(); return true; }); } catch (\Throwable $sp96dd17) { $sp6edbee = 'FundHelper.orderFreeze error'; if ($sp600a89) { $sp6edbee .= ', order_no:' . $sp600a89->order_no . ', user_id:' . $sp600a89->user_id . ', amount:' . $sp600a89->income; } else { $sp6edbee .= ', order_no: null'; } Log::error($sp6edbee . ' with exception:', array('Exception' => $sp96dd17)); return false; } } public static function orderUnfreeze($sp91aca1, $sp23a601, callable $sp47477c = null, &$spd977b7 = null) { $sp600a89 = null; try { return DB::transaction(function () use($sp91aca1, &$sp600a89, $sp23a601, $sp47477c, &$spd977b7) { $sp600a89 = \App\Order::where('id', $sp91aca1)->lockForUpdate()->firstOrFail(); if ($sp47477c !== null) { $sp6a22d6 = $sp47477c(); if ($sp6a22d6 !== self::ACTION_CONTINUE) { return $sp6a22d6; } } if ($sp600a89->status === Order::STATUS_REFUND) { $spd977b7 = $sp600a89->status; return false; } if ($sp600a89->status !== Order::STATUS_FROZEN) { $spd977b7 = $sp600a89->status; return true; } $spd4565c = $sp600a89->card_orders()->exists(); if ($spd4565c) { $spd977b7 = \App\Order::STATUS_SUCCESS; $spb296ac = '已发货'; } else { if ($sp600a89->paid_at === NULL) { $spd977b7 = \App\Order::STATUS_UNPAY; $spb296ac = '未付款'; } else { $spd977b7 = \App\Order::STATUS_PAID; $spb296ac = '未发货'; } } $spb14cf0 = User::where('id', $sp600a89->user_id)->lockForUpdate()->firstOrFail(); $spbb6006 = new FundRecord(); $spbb6006->user_id = $sp600a89->user_id; $spbb6006->type = FundRecord::TYPE_IN; $spbb6006->remark = $sp600a89 === $sp600a89 ? '' : '关联订单#' . $sp600a89->order_no . ': '; $spbb6006->order_id = $sp600a89->id; if ($spd4565c) { $spb14cf0->m_frozen -= $sp600a89->income; $spb14cf0->saveOrFail(); $spbb6006->amount = $sp600a89->income; $spbb6006->remark .= $sp23a601 . ', 解冻订单#' . $sp600a89->order_no; } else { $spbb6006->amount = 0; $spbb6006->remark .= $sp23a601 . ', 解冻订单(' . $spb296ac . ')#' . $sp600a89->order_no; } $spbb6006->all = $spb14cf0->m_all; $spbb6006->frozen = $spb14cf0->m_frozen; $spbb6006->paid = $spb14cf0->m_paid; $spbb6006->balance = $spb14cf0->m_balance; $spbb6006->saveOrFail(); $sp600a89->status = $spd977b7; $sp600a89->saveOrFail(); return true; }); } catch (\Throwable $sp96dd17) { $sp6edbee = 'FundHelper.orderUnfreeze error'; if ($sp600a89) { $sp6edbee .= ', order_no:' . $sp600a89->order_no . ', user_id:' . $sp600a89->user_id . ',amount:' . $sp600a89->income; } else { $sp6edbee .= ', order_no: null'; } Log::error($sp6edbee . ' with exception:', array('Exception' => $sp96dd17)); return false; } } }
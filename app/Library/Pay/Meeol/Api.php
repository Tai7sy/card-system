<?php
namespace App\Library\Pay\Meeol; use App\Library\CurlRequest; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $sp36f78e = sprintf('%.2f', $sp6956b3 / 100); if (!isset($spc27de0['appId'])) { throw new \Exception('请设置appId'); } if (!isset($spc27de0['key'])) { throw new \Exception('请设置key'); } $spd53b1c = $spc27de0['payway']; $spb18322 = array('amount' => $sp36f78e, 'appId' => $spc27de0['appId'], 'orderId' => $spba04f6, 'random' => md5(random_bytes(16)), 'tradeType' => $spd53b1c); $spb18322['sign'] = strtoupper(md5('amount=' . $spb18322['amount'] . '&appId=' . $spc27de0['appId'] . '&key=' . $spc27de0['key'] . '&orderId=' . $spb18322['orderId'] . '&random=' . $spb18322['random'] . '&tradeType=' . $spb18322['tradeType'])); $sp4187a7 = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/order', json_encode($spb18322)); $sp29a775 = json_decode($sp4187a7, true); if (!isset($sp29a775['status']) || $sp29a775['status'] !== '0') { Log::error('Pay.Meeol.goPay.order Error: ' . $sp4187a7); throw new \Exception('支付请求失败, 请刷新重试'); } if (substr($spd53b1c, 0, 1) === 'W') { header('Location: /qrcode/pay/' . $spba04f6 . '/wechat?url=' . urlencode($sp29a775['qrcode'])); } elseif (substr($spd53b1c, 0, 1) === 'A') { header('Location: /qrcode/pay/' . $spba04f6 . '/aliqr?url=' . urlencode($sp29a775['qrcode'])); } die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; if ($spb2acff) { $sp33b002 = json_decode(file_get_contents('php://input'), true); $sp75e4cc = strtoupper(md5('amount=' . $sp33b002['amount'] . '&appid=' . $sp33b002['appid'] . '&key=' . $spc27de0['key'] . '&orderId=' . $sp33b002['orderId'] . '&tradeTime=' . $sp33b002['tradeTime'] . '&tradeType=' . $sp33b002['tradeType'])); if ($sp75e4cc === $sp33b002['sign']) { $sp36f78e = (int) round($sp33b002['amount'] * 100); $sp4294a3($sp33b002['orderId'], $sp36f78e, $sp33b002['passTradeNo']); echo 'success'; return true; } else { Log::error('Pay.Meeol.verify notify sign error, post: ' . file_get_contents('php://input')); echo 'error'; } } else { if (!empty($spc27de0['out_trade_no'])) { $spb18322 = array('appId' => $spc27de0['appId'], 'orderId' => $spc27de0['out_trade_no'], 'random' => md5(random_bytes(16))); $spb18322['sign'] = strtoupper(md5('appId=' . $spc27de0['appId'] . '&key=' . $spc27de0['key'] . '&orderId=' . $spb18322['orderId'] . '&random=' . $spb18322['random'])); $spb18322 = json_encode($spb18322); $sp4187a7 = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/query', $spb18322); $sp29a775 = json_decode($sp4187a7, true); if (!isset($sp29a775['status'])) { Log::error('Pay.Meeol.verify Error: ' . $sp4187a7); } if ($sp29a775['status'] === '0') { $sp36f78e = (int) round($sp29a775['amount'] * 100); $sp4294a3($sp29a775['orderId'], $sp36f78e, $sp29a775['passTradeNo']); return true; } Log::debug('Pay.Meeol.verify debug, req:' . $spb18322 . 'ret:' . $sp4187a7); return false; } else { throw new \Exception('请传递订单编号'); } } return false; } }
<?php
namespace App\Library\Pay\Meeol; use App\Library\CurlRequest; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { $spc686cf = sprintf('%.2f', $sp076ec7 / 100); if (!isset($sp9d4382['appId'])) { throw new \Exception('请设置appId'); } if (!isset($sp9d4382['key'])) { throw new \Exception('请设置key'); } $spf9ca0c = $sp9d4382['payway']; $sp8d5928 = array('amount' => $spc686cf, 'appId' => $sp9d4382['appId'], 'orderId' => $sp2e47fc, 'random' => md5(random_bytes(16)), 'tradeType' => $spf9ca0c); $sp8d5928['sign'] = strtoupper(md5('amount=' . $sp8d5928['amount'] . '&appId=' . $sp9d4382['appId'] . '&key=' . $sp9d4382['key'] . '&orderId=' . $sp8d5928['orderId'] . '&random=' . $sp8d5928['random'] . '&tradeType=' . $sp8d5928['tradeType'])); $sp42422c = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/order', json_encode($sp8d5928)); $sp9b52fe = json_decode($sp42422c, true); if (!isset($sp9b52fe['status']) || $sp9b52fe['status'] !== '0') { Log::error('Pay.Meeol.goPay.order Error: ' . $sp42422c); throw new \Exception('支付请求失败, 请刷新重试'); } if (substr($spf9ca0c, 0, 1) === 'W') { header('Location: /qrcode/pay/' . $sp2e47fc . '/wechat?url=' . urlencode($sp9b52fe['qrcode'])); } elseif (substr($spf9ca0c, 0, 1) === 'A') { header('Location: /qrcode/pay/' . $sp2e47fc . '/aliqr?url=' . urlencode($sp9b52fe['qrcode'])); } die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; if ($sp7b2182) { $spe5cbac = json_decode(file_get_contents('php://input'), true); $sp964415 = strtoupper(md5('amount=' . $spe5cbac['amount'] . '&appid=' . $spe5cbac['appid'] . '&key=' . $sp9d4382['key'] . '&orderId=' . $spe5cbac['orderId'] . '&tradeTime=' . $spe5cbac['tradeTime'] . '&tradeType=' . $spe5cbac['tradeType'])); if ($sp964415 === $spe5cbac['sign']) { $spc686cf = (int) round($spe5cbac['amount'] * 100); $sp9a4d97($spe5cbac['orderId'], $spc686cf, $spe5cbac['passTradeNo']); echo 'success'; return true; } else { Log::error('Pay.Meeol.verify notify sign error, post: ' . file_get_contents('php://input')); echo 'error'; } } else { if (!empty($sp9d4382['out_trade_no'])) { $sp8d5928 = array('appId' => $sp9d4382['appId'], 'orderId' => $sp9d4382['out_trade_no'], 'random' => md5(random_bytes(16))); $sp8d5928['sign'] = strtoupper(md5('appId=' . $sp9d4382['appId'] . '&key=' . $sp9d4382['key'] . '&orderId=' . $sp8d5928['orderId'] . '&random=' . $sp8d5928['random'])); $sp8d5928 = json_encode($sp8d5928); $sp42422c = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/query', $sp8d5928); $sp9b52fe = json_decode($sp42422c, true); if (!isset($sp9b52fe['status'])) { Log::error('Pay.Meeol.verify Error: ' . $sp42422c); } if ($sp9b52fe['status'] === '0') { $spc686cf = (int) round($sp9b52fe['amount'] * 100); $sp9a4d97($sp9b52fe['orderId'], $spc686cf, $sp9b52fe['passTradeNo']); return true; } Log::debug('Pay.Meeol.verify debug, req:' . $sp8d5928 . 'ret:' . $sp42422c); return false; } else { throw new \Exception('请传递订单编号'); } } return false; } }
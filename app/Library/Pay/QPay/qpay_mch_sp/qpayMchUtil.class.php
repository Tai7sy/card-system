<?php
require_once 'qpayMch.config.php'; class QpayMchUtil { public static function createNoncestr($sp5e0ffd = 32) { $sp65efa9 = 'abcdefghijklmnopqrstuvwxyz0123456789'; $sp3868ff = ''; for ($spb75665 = 0; $spb75665 < $sp5e0ffd; $spb75665++) { $sp3868ff .= substr($sp65efa9, mt_rand(0, strlen($sp65efa9) - 1), 1); } return $sp3868ff; } public static function buildQueryStr($sp3e77f9) { $spd3aafa = array(); foreach ($sp3e77f9 as $spe3274c => $spd7786b) { if ($spe3274c != 'sign' && $spd7786b != '' && !is_array($spd7786b)) { array_push($spd3aafa, "{$spe3274c}={$spd7786b}"); } } return implode('&', $spd3aafa); } public static function getSign($sp3e77f9, $sp9c809d) { ksort($sp3e77f9); $sp68a7c4 = QpayMchUtil::buildQueryStr($sp3e77f9); $sp68a7c4 = $sp68a7c4 . '&key=' . $sp9c809d; $sp68a7c4 = md5($sp68a7c4); $sp75e4cc = strtoupper($sp68a7c4); return $sp75e4cc; } public static function arrayToXml($spdffb1d) { $spbbfd2d = '<xml>'; foreach ($spdffb1d as $sp7b7024 => $spcb4459) { if (is_numeric($spcb4459)) { $spbbfd2d .= "<{$sp7b7024}>{$spcb4459}</{$sp7b7024}>"; } else { $spbbfd2d .= "<{$sp7b7024}><![CDATA[{$spcb4459}]]></{$sp7b7024}>"; } } $spbbfd2d .= '</xml>'; return $spbbfd2d; } public static function xmlToArray($spbbfd2d) { $spdffb1d = json_decode(json_encode(simplexml_load_string($spbbfd2d, 'SimpleXMLElement', LIBXML_NOCDATA)), true); return $spdffb1d; } public static function reqByCurlNormalPost($sp3e77f9, $sp3ae187, $sp8bccc7 = 10) { return QpayMchUtil::_reqByCurl($sp3e77f9, $sp3ae187, $sp8bccc7, false); } public static function reqByCurlSSLPost($sp3e77f9, $sp3ae187, $sp8bccc7 = 10) { return QpayMchUtil::_reqByCurl($sp3e77f9, $sp3ae187, $sp8bccc7, true); } private static function _reqByCurl($sp3e77f9, $sp3ae187, $sp8bccc7 = 10, $spfbb63c = false) { $sp4e752c = curl_init(); curl_setopt($sp4e752c, CURLOPT_URL, $sp3ae187); curl_setopt($sp4e752c, CURLOPT_TIMEOUT, $sp8bccc7); curl_setopt($sp4e752c, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($sp4e752c, CURLOPT_SSL_VERIFYHOST, FALSE); curl_setopt($sp4e752c, CURLOPT_HEADER, FALSE); curl_setopt($sp4e752c, CURLOPT_RETURNTRANSFER, TRUE); if (isset($spfbb63c) && $spfbb63c != false) { curl_setopt($sp4e752c, CURLOPT_SSLCERTTYPE, 'PEM'); curl_setopt($sp4e752c, CURLOPT_SSLCERT, QpayMchConf::CERT_FILE_PATH); curl_setopt($sp4e752c, CURLOPT_SSLKEYTYPE, 'PEM'); curl_setopt($sp4e752c, CURLOPT_SSLKEY, QpayMchConf::KEY_FILE_PATH); } curl_setopt($sp4e752c, CURLOPT_POST, true); curl_setopt($sp4e752c, CURLOPT_POSTFIELDS, $sp3e77f9); $sp29a775 = curl_exec($sp4e752c); if ($sp29a775) { curl_close($sp4e752c); return $sp29a775; } else { $sp095a96 = curl_errno($sp4e752c); print_r($sp095a96); curl_close($sp4e752c); return false; } } }
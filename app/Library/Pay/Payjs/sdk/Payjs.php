<?php
namespace Xhat\Payjs; class Payjs { private $mchid; private $key; private $api_url_native; private $api_url_cashier; private $api_url_refund; private $api_url_close; private $api_url_check; private $api_url_user; private $api_url_info; private $api_url_bank; public function __construct($spbe80b7 = null) { if (!$spbe80b7) { die('config needed'); } $this->mchid = $spbe80b7['mchid']; $this->key = $spbe80b7['key']; $sp45a89e = isset($spbe80b7['api_url']) ? $spbe80b7['api_url'] : 'https://payjs.cn/api/'; $this->api_url_native = $sp45a89e . 'native'; $this->api_url_cashier = $sp45a89e . 'cashier'; $this->api_url_refund = $sp45a89e . 'refund'; $this->api_url_close = $sp45a89e . 'close'; $this->api_url_check = $sp45a89e . 'check'; $this->api_url_user = $sp45a89e . 'user'; $this->api_url_info = $sp45a89e . 'info'; $this->api_url_bank = $sp45a89e . 'bank'; } public function native(array $sp5aa598) { $this->url = $this->api_url_native; return $this->post($sp5aa598); } public function cashier(array $sp5aa598) { $this->url = $this->api_url_cashier; $sp5aa598 = $this->sign($sp5aa598); $sp3db1b2 = $this->url . '?' . http_build_query($sp5aa598); return $sp3db1b2; } public function refund($spcd94ca) { $this->url = $this->api_url_refund; $sp5aa598 = array('payjs_order_id' => $spcd94ca); return $this->post($sp5aa598); } public function close($spcd94ca) { $this->url = $this->api_url_close; $sp5aa598 = array('payjs_order_id' => $spcd94ca); return $this->post($sp5aa598); } public function check($spcd94ca) { $this->url = $this->api_url_check; $sp5aa598 = array('payjs_order_id' => $spcd94ca); return $this->post($sp5aa598); } public function user($sp0b37ee) { $this->url = $this->api_url_user; $sp5aa598 = array('openid' => $sp0b37ee); return $this->post($sp5aa598); } public function info() { $this->url = $this->api_url_info; $sp5aa598 = array(); return $this->post($sp5aa598); } public function bank($sp505b52) { $this->url = $this->api_url_bank; $sp5aa598 = array('bank' => $sp505b52); return $this->post($sp5aa598); } public function notify() { $sp5aa598 = $_POST; if ($this->checkSign($sp5aa598) === true) { return $sp5aa598; } else { return '验签失败'; } } public function sign(array $sp5aa598) { $sp5aa598['mchid'] = $this->mchid; array_filter($sp5aa598); ksort($sp5aa598); $sp5aa598['sign'] = strtoupper(md5(urldecode(http_build_query($sp5aa598) . '&key=' . $this->key))); return $sp5aa598; } public function checkSign($sp5aa598) { $sp2a2c6e = $sp5aa598['sign']; unset($sp5aa598['sign']); array_filter($sp5aa598); ksort($sp5aa598); $spa109d2 = strtoupper(md5(urldecode(http_build_query($sp5aa598) . '&key=' . $this->key))); return $sp2a2c6e == $spa109d2 ? true : false; } private static function curl_post($sp3db1b2, $sp0e98cb = '') { $sp28070b['Accept'] = '*/*'; $sp28070b['Referer'] = $sp3db1b2; $sp28070b['Content-Type'] = 'application/x-www-form-urlencoded'; $sp28070b['User-Agent'] = 'ni shi sha bi ba, yi ge sdk hai you di san fang ku'; $sp263179 = array(); foreach ($sp28070b as $sp0a9b77 => $spf9847c) { $sp263179[] = $sp0a9b77 . ': ' . $spf9847c; } $sp263179[] = 'Expect:'; $sp9b0943 = curl_init(); curl_setopt($sp9b0943, CURLOPT_URL, $sp3db1b2); curl_setopt($sp9b0943, CURLOPT_POST, 1); curl_setopt($sp9b0943, CURLOPT_POSTFIELDS, $sp0e98cb); curl_setopt($sp9b0943, CURLOPT_TIMEOUT, 10); curl_setopt($sp9b0943, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp9b0943, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp9b0943, CURLOPT_HEADER, 1); curl_setopt($sp9b0943, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp9b0943, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp9b0943, CURLOPT_HTTPHEADER, $sp263179); $sp3ac4e3 = curl_exec($sp9b0943); $sp70c798 = curl_getinfo($sp9b0943, CURLINFO_HEADER_SIZE); $sp873488 = substr($sp3ac4e3, $sp70c798); curl_close($sp9b0943); return $sp873488; } public function post($sp5aa598) { $sp5aa598 = $this->sign($sp5aa598); return json_decode(self::curl_post($this->url, http_build_query($sp5aa598)), true); } }
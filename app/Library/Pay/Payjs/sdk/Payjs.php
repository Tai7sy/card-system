<?php
namespace Xhat\Payjs; class Payjs { private $mchid; private $key; private $api_url_native; private $api_url_cashier; private $api_url_refund; private $api_url_close; private $api_url_check; private $api_url_user; private $api_url_info; private $api_url_bank; public function __construct($sp9d4382 = null) { if (!$sp9d4382) { die('config needed'); } $this->mchid = $sp9d4382['mchid']; $this->key = $sp9d4382['key']; $spd839cb = isset($sp9d4382['api_url']) ? $sp9d4382['api_url'] : 'https://payjs.cn/api/'; $this->api_url_native = $spd839cb . 'native'; $this->api_url_cashier = $spd839cb . 'cashier'; $this->api_url_refund = $spd839cb . 'refund'; $this->api_url_close = $spd839cb . 'close'; $this->api_url_check = $spd839cb . 'check'; $this->api_url_user = $spd839cb . 'user'; $this->api_url_info = $spd839cb . 'info'; $this->api_url_bank = $spd839cb . 'bank'; } public function native(array $sp6fd648) { $this->url = $this->api_url_native; return $this->post($sp6fd648); } public function cashier(array $sp6fd648) { $this->url = $this->api_url_cashier; $sp6fd648 = $this->sign($sp6fd648); $spd2457c = $this->url . '?' . http_build_query($sp6fd648); return $spd2457c; } public function refund($spb41935) { $this->url = $this->api_url_refund; $sp6fd648 = array('payjs_order_id' => $spb41935); return $this->post($sp6fd648); } public function close($spb41935) { $this->url = $this->api_url_close; $sp6fd648 = array('payjs_order_id' => $spb41935); return $this->post($sp6fd648); } public function check($spb41935) { $this->url = $this->api_url_check; $sp6fd648 = array('payjs_order_id' => $spb41935); return $this->post($sp6fd648); } public function user($sp549d4c) { $this->url = $this->api_url_user; $sp6fd648 = array('openid' => $sp549d4c); return $this->post($sp6fd648); } public function info() { $this->url = $this->api_url_info; $sp6fd648 = array(); return $this->post($sp6fd648); } public function bank($sp34e4b5) { $this->url = $this->api_url_bank; $sp6fd648 = array('bank' => $sp34e4b5); return $this->post($sp6fd648); } public function notify() { $sp6fd648 = $_POST; if ($this->checkSign($sp6fd648) === true) { return $sp6fd648; } else { return '验签失败'; } } public function sign(array $sp6fd648) { $sp6fd648['mchid'] = $this->mchid; array_filter($sp6fd648); ksort($sp6fd648); $sp6fd648['sign'] = strtoupper(md5(urldecode(http_build_query($sp6fd648) . '&key=' . $this->key))); return $sp6fd648; } public function checkSign($sp6fd648) { $spf65d7c = $sp6fd648['sign']; unset($sp6fd648['sign']); array_filter($sp6fd648); ksort($sp6fd648); $sp964415 = strtoupper(md5(urldecode(http_build_query($sp6fd648) . '&key=' . $this->key))); return $spf65d7c == $sp964415 ? true : false; } private static function curl_post($spd2457c, $spe25017 = '') { $spc69671['Accept'] = '*/*'; $spc69671['Referer'] = $spd2457c; $spc69671['Content-Type'] = 'application/x-www-form-urlencoded'; $spc69671['User-Agent'] = 'ni shi sha bi ba, yi ge sdk hai you di san fang ku'; $sp3db035 = array(); foreach ($spc69671 as $sp517f03 => $sp438dc5) { $sp3db035[] = $sp517f03 . ': ' . $sp438dc5; } $sp3db035[] = 'Expect:'; $sp9f83d6 = curl_init(); curl_setopt($sp9f83d6, CURLOPT_URL, $spd2457c); curl_setopt($sp9f83d6, CURLOPT_POST, 1); curl_setopt($sp9f83d6, CURLOPT_POSTFIELDS, $spe25017); curl_setopt($sp9f83d6, CURLOPT_TIMEOUT, 10); curl_setopt($sp9f83d6, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp9f83d6, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp9f83d6, CURLOPT_HEADER, 1); curl_setopt($sp9f83d6, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp9f83d6, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp9f83d6, CURLOPT_HTTPHEADER, $sp3db035); $spdc5091 = curl_exec($sp9f83d6); $sp4c5a1f = curl_getinfo($sp9f83d6, CURLINFO_HEADER_SIZE); $spd0789a = substr($spdc5091, $sp4c5a1f); curl_close($sp9f83d6); return $spd0789a; } public function post($sp6fd648) { $sp6fd648 = $this->sign($sp6fd648); return json_decode(self::curl_post($this->url, http_build_query($sp6fd648)), true); } }
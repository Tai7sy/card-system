<?php
namespace App\Library\Pay\Yeke; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $sp9b2bb6 = sprintf('%.2f', $sp6956b3 / 100); define('yeke_USER_ID', $spc27de0['id']); define('yeke_USER_KEY', $spc27de0['key']); define('yeke_USER_LOG_PREFIX', 'log'); define('yeke_API_GATE', 'http://www.yekepay.com/api/ApiGo.php'); $spef6530 = strtolower($spc27de0['payway']); $spaaed5c = ''; $sp3b9596 = ''; if ($spef6530 == 'alipay' || $spef6530 == 'alipay_wap') { $spaaed5c = 'alipay'; $sp3b9596 = 'ALIPAY'; } elseif ($spef6530 == 'tenpay' || $spef6530 == 'tenpay_wap') { $spaaed5c = 'tenpay'; $sp3b9596 = 'TENPAY'; } elseif ($spef6530 == 'weixin') { $spaaed5c = 'weixin'; $sp3b9596 = 'WEIXIN'; } elseif ($spef6530 == 'weixin_wap') { $spaaed5c = 'wxwap'; $sp3b9596 = 'wxwap'; } elseif ($spef6530 == 'qq' || $spef6530 == 'qq_wap') { $spaaed5c = 'sqzf'; $sp3b9596 = 'sqzf'; } elseif ($spef6530 == 'qq_wap') { $spaaed5c = 'sqzfqb'; $sp3b9596 = 'sqzfqb'; } require 'yekeApiLib.php'; require 'HttpClient.php'; $sp9f49de = mb_substr($sp9f49de, 0, 50, 'UTF-8'); $sp224c81 = mb_substr($sp224c81, 0, 100, 'UTF-8'); $sp3e77f9 = array('P_orderid' => $spba04f6, 'P_paymoney' => $sp9b2bb6, 'P_productname' => urlencode($sp9f49de), 'P_productinfo' => urlencode($sp224c81), 'P_remark' => urlencode($spba04f6), 'P_custom_1' => urlencode($sp3b9596), 'P_custom_2' => '', 'P_contact' => urlencode(SYS_NAME), 'P_paytype' => $spaaed5c, 'P_gateway' => $sp3b9596, 'P_cardnum' => '', 'P_cardpwd' => '', 'P_cardvalue' => '', 'P_notify_url' => $this->url_notify, 'P_return_url' => $this->url_return . '/' . $spba04f6); $sp8c29a5 = new \yekeAPI(); $spb34b01 = $sp8c29a5->payGate($sp3e77f9); echo $spb34b01; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; define('yeke_USER_ID', $spc27de0['id']); define('yeke_USER_KEY', $spc27de0['key']); define('yeke_USER_LOG_PREFIX', 'log'); define('yeke_API_GATE', 'http://www.yekepay.com/api/ApiGo.php'); require 'HttpClient.php'; require 'yekeApiLib.php'; $sp8c29a5 = new \yekeAPI(); if ($spb2acff) { $spb34b01 = $sp8c29a5->verifyNotify(); } else { $spb34b01 = $sp8c29a5->verifyReturn(); } if ($spb34b01) { $sp0a0b0b = $_REQUEST['P_orderid']; $sp15bf53 = $_REQUEST['P_api_orderid']; $spebb578 = $_REQUEST['P_money']; if ($_REQUEST['P_status'] == 'SUCCESS') { $sp4294a3($sp15bf53, (int) round($spebb578 * 100), $sp0a0b0b); if ($spb2acff) { echo 'success'; } return true; } else { if ($spb2acff) { echo '失败订单'; } } } else { if ($spb2acff) { echo '验证失败'; } } return false; } }
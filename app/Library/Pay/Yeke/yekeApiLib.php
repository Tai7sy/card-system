<?php
class yekeAPI { function __construct() { } public static function getPayGate() { $spa26894 = array('action' => 'getPayType', 'userid' => yeke_USER_ID, 'sign' => md5(yeke_USER_ID . yeke_USER_KEY)); $spbbda25 = HttpClient::quickPost(yeke_API_GATE, $spa26894); return $spbbda25; } public static function getPayType() { $spaff91c = json_decode(self::getPayGate(), true); $sp5aa598 = array(); if ($spaff91c['status']) { foreach ($spaff91c['list'] as $sp1ed429 => $sp36ecf9) { $sp5aa598[] = array('paytype' => $sp36ecf9['paytype'], 'channelname' => $sp36ecf9['channelname']); } } return $sp5aa598; } public static function getChannel($spa5cb9b) { $spaff91c = json_decode(self::getPayGate(), true); $sp5aa598 = array(); if ($spa5cb9b == 'card') { if ($spaff91c['status'] && $spaff91c['list']) { foreach ($spaff91c['list'] as $sp36ecf9) { if ($sp36ecf9['paytype'] == $spa5cb9b) { foreach ($sp36ecf9['datalist'] as $sp1ed429 => $sp25c5d6) { $sp5aa598[] = array('channelid' => $sp25c5d6['channelid'], 'channelname' => $sp25c5d6['channelname'], 'imgurl' => $sp25c5d6['imgurl']); } } } } } else { if ($spaff91c['status'] && $spaff91c['list']) { foreach ($spaff91c['list'] as $sp36ecf9) { if ($sp36ecf9['paytype'] == $spa5cb9b) { foreach ($sp36ecf9['datalist'] as $sp1ed429 => $sp25c5d6) { $sp5aa598[] = array('bankcode' => $sp25c5d6['bankcode'], 'bankname' => $sp25c5d6['bankname'], 'imgurl' => $sp25c5d6['imgurl']); } } } } } return $sp5aa598; } public static function getCardValue() { $spaff91c = json_decode(self::getPayGate(), true); $sp5aa598 = array(); if ($spaff91c['status'] && $spaff91c['list']) { foreach ($spaff91c['list'] as $sp36ecf9) { if ($sp36ecf9['paytype'] == 'card') { foreach ($sp36ecf9['datalist'] as $sp1ed429 => $sp36ecf9) { $sp5aa598[] = array('channelid' => $sp36ecf9['channelid'], 'channelname' => $sp36ecf9['channelname'], 'cardvalue' => $sp36ecf9['cardvalue'], 'cardlength' => $sp36ecf9['cardlength']); } } } } return $sp5aa598; } public static function getOrderID() { return date('Y') . date('m') . date('d') . date('H') . date('i') . date('s') . rand(100000, 999999); } public function payGate($spa26894) { $spa26894 = array_merge(array('P_userid' => yeke_USER_ID), $spa26894); $spa109d2 = $this->makeSign($spa26894); $spa26894 = array_merge($spa26894, array('P_sign' => $spa109d2, 'action' => 'payGate')); switch ($spa26894['P_paytype']) { case 'bank': case 'alipay': case 'tenpay': case 'weixin': case 'wxwap': case 'sqzf': return $this->payGateBank($spa26894); break; case 'card': return $this->payGateCard($spa26894); break; default: return 'error,支付方式错误'; } } public function payGateBank($spa26894) { $sp72201b = '<html><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><title>请稍候，正在跳转...</title></head>'; $sp72201b .= '<body onload="document.pay.submit()">'; $sp72201b .= '请稍候，正在跳转...'; $sp72201b .= '<form name="pay" action=' . yeke_API_GATE . ' method="post">'; foreach ($spa26894 as $sp1ed429 => $sp36ecf9) { $sp72201b .= '<input type="hidden" name="' . $sp1ed429 . '" value="' . $sp36ecf9 . '">'; } $sp72201b .= '</body></html>'; return $sp72201b; } public function payGateCard($spa26894) { if ($spa26894['P_cardnum'] == '' || $spa26894['P_cardpwd'] == '' || $spa26894['P_cardvalue'] == '') { return 'error,卡信息不完整'; } $spbbda25 = HttpClient::quickPost(yeke_API_GATE, $spa26894); return $spbbda25; } public function makeSign($spa26894) { $sp72201b = ''; foreach ($spa26894 as $sp1ed429 => $sp36ecf9) { $sp72201b .= $sp72201b ? '&' : ''; $sp72201b .= $sp1ed429 . '=' . $sp36ecf9; } $spa109d2 = md5($sp72201b . yeke_USER_KEY); return $spa109d2; } public function verifyNotify() { if (empty($_POST)) { return false; } $_POST['P_productname'] = urlencode($_POST['P_productname']); $_POST['P_productinfo'] = urlencode($_POST['P_productinfo']); $_POST['P_remark'] = urlencode($_POST['P_remark']); $_POST['P_custom_1'] = urlencode($_POST['P_custom_1']); $_POST['P_custom_2'] = urlencode($_POST['P_custom_2']); $_POST['P_contact'] = urlencode($_POST['P_contact']); $sp9fa556 = $_POST['P_sign']; foreach ($_POST as $sp1ed429 => $sp36ecf9) { if ($sp1ed429 == 'P_sign') { unset($_POST['P_sign']); } } $spc2fc89 = $this->makeSign($_POST); $this->logs($_POST['P_api_orderid'], $_POST, $sp9fa556 . '=' . $spc2fc89); if ($sp9fa556 == $spc2fc89) { return true; } else { return false; } } public function verifyReturn() { if (empty($_GET)) { return false; } $_GET['P_productname'] = urlencode($_GET['P_productname']); $_GET['P_productinfo'] = urlencode($_GET['P_productinfo']); $_GET['P_remark'] = urlencode($_GET['P_remark']); $_GET['P_custom_1'] = urlencode($_GET['P_custom_1']); $_GET['P_custom_2'] = urlencode($_GET['P_custom_2']); $_GET['P_contact'] = urlencode($_GET['P_contact']); $sp9fa556 = $_GET['P_sign']; foreach ($_GET as $sp1ed429 => $sp36ecf9) { if ($sp1ed429 == 'P_sign') { unset($_GET['P_sign']); } } $spc2fc89 = $this->makeSign($_GET); if ($sp9fa556 == $spc2fc89) { return true; } else { return false; } } public function logs($spd7dc6d, $spa26894, $spc2fc89) { date_default_timezone_set('PRC'); if (!empty($spa26894)) { $sp72201b = ''; foreach ($spa26894 as $sp1ed429 => $sp36ecf9) { $sp72201b .= $sp72201b ? '&' : ''; $sp72201b .= $sp1ed429 . '=' . $sp36ecf9; } $spc1a72e = date('Y-m-d H:i:s') . '
' . $spd7dc6d . '
' . $sp72201b . '
' . $spc2fc89 . '

........................................

'; $sp911033 = 'log'; if (!file_exists($sp911033)) { mkdir($sp911033, 511, true); } $sp41cf2a = yeke_USER_LOG_PREFIX . '-' . date('Y-m-d') . '.txt'; $sp8cc2df = fopen($sp911033 . '/' . $sp41cf2a, 'ab'); fwrite($sp8cc2df, $spc1a72e); fclose($sp8cc2df); } } }
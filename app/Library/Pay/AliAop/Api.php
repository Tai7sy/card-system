<?php
namespace App\Library\Pay\AliAop; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; private $aop = null; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } private function aop($spbe80b7) { if ($this->aop === null) { $sp9758bb = \Alipay\Key\AlipayKeyPair::create('-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spbe80b7['merchant_private_key'], 64, '
', true) . '
-----END RSA PRIVATE KEY-----', '-----BEGIN PUBLIC KEY-----
' . wordwrap($spbe80b7['alipay_public_key'], 64, '
', true) . '
-----END PUBLIC KEY-----'); $this->aop = new \Alipay\AopClient($spbe80b7['app_id'], $sp9758bb); } return $this->aop; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { $sp429fcc = sprintf('%.2f', $sp5213ee / 100); if ($spbe80b7['payway'] === 'f2f') { $spfeab54 = \Alipay\AlipayRequestFactory::create('alipay.trade.precreate', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spa3e681, 'total_amount' => $sp429fcc, 'subject' => $sp45f07e))); $spbbda25 = $this->aop($spbe80b7)->execute($spfeab54)->getData(); header('location: /qrcode/pay/' . $spa3e681 . '/aliqr?url=' . urlencode($spbbda25['qr_code'])); } elseif ($spbe80b7['payway'] === 'pc') { $spfeab54 = \Alipay\AlipayRequestFactory::create('alipay.trade.page.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spa3e681, 'product_code' => 'FAST_INSTANT_TRADE_PAY', 'total_amount' => $sp429fcc, 'subject' => $sp45f07e))); $spbbda25 = $this->aop($spbe80b7)->pageExecuteUrl($spfeab54); header('location: ' . $spbbda25); } elseif ($spbe80b7['payway'] === 'mobile') { $spfeab54 = \Alipay\AlipayRequestFactory::create('alipay.trade.wap.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spa3e681, 'product_code' => 'QUICK_WAP_WAY', 'total_amount' => $sp429fcc, 'subject' => $sp45f07e))); $spbbda25 = $this->aop($spbe80b7)->pageExecuteUrl($spfeab54); header('location: ' . $spbbda25); } die; } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; if ($sp3bce01) { if ($this->aop($spbe80b7)->verify($_POST)) { if ($_POST['trade_status'] === 'TRADE_SUCCESS') { $sp4d48a7 = $_POST['trade_no']; $sp9624ba = (int) round($_POST['total_amount'] * 100); $sp04f0f8($_POST['out_trade_no'], $sp9624ba, $sp4d48a7); } } else { Log::error('Pay.AliAop.goPay.verify Error: ' . json_encode($_POST)); } echo 'success'; die; } if (!empty($spbe80b7['out_trade_no'])) { $spa3e681 = $spbe80b7['out_trade_no']; $spfeab54 = \Alipay\AlipayRequestFactory::create('alipay.trade.query', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spa3e681))); try { $spbbda25 = $this->aop($spbe80b7)->execute($spfeab54)->getData(); } catch (\Throwable $sp81eee8) { return false; } if ($spbbda25['trade_status'] === 'TRADE_SUCCESS') { $sp4d48a7 = $spbbda25['trade_no']; $sp9624ba = (int) round($spbbda25['total_amount'] * 100); $sp04f0f8($spbbda25['out_trade_no'], $sp9624ba, $sp4d48a7); return true; } } else { if (!isset($_GET['out_trade_no']) || !isset($_GET['total_amount'])) { return false; } $spc9c65f = $this->aop($spbe80b7)->verify($_GET); if (!$spc9c65f) { Log::error('Pay.AliAop.verify Error: 支付宝签名校验失败', array('$_GET' => $_GET)); return false; } $sp4d48a7 = $_GET['trade_no']; $sp9624ba = (int) round($_GET['total_amount'] * 100); $sp04f0f8($_GET['out_trade_no'], $sp9624ba, $sp4d48a7); return true; } return false; } }
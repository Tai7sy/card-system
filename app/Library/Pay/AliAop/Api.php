<?php
namespace App\Library\Pay\AliAop; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; private $aop = null; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } private function aop($spc27de0) { if ($this->aop === null) { $sp15b07f = \Alipay\Key\AlipayKeyPair::create('-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spc27de0['merchant_private_key'], 64, '
', true) . '
-----END RSA PRIVATE KEY-----', '-----BEGIN PUBLIC KEY-----
' . wordwrap($spc27de0['alipay_public_key'], 64, '
', true) . '
-----END PUBLIC KEY-----'); $this->aop = new \Alipay\AopClient($spc27de0['app_id'], $sp15b07f); } return $this->aop; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $sp9b2bb6 = sprintf('%.2f', $sp6956b3 / 100); if ($spc27de0['payway'] === 'f2f') { $spd5cc4d = \Alipay\AlipayRequestFactory::create('alipay.trade.precreate', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spba04f6, 'total_amount' => $sp9b2bb6, 'subject' => $sp9f49de))); $spb34b01 = $this->aop($spc27de0)->execute($spd5cc4d)->getData(); header('location: /qrcode/pay/' . $spba04f6 . '/aliqr?url=' . urlencode($spb34b01['qr_code'])); } elseif ($spc27de0['payway'] === 'pc') { $spd5cc4d = \Alipay\AlipayRequestFactory::create('alipay.trade.page.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spba04f6, 'product_code' => 'FAST_INSTANT_TRADE_PAY', 'total_amount' => $sp9b2bb6, 'subject' => $sp9f49de))); $spb34b01 = $this->aop($spc27de0)->pageExecuteUrl($spd5cc4d); header('location: ' . $spb34b01); } elseif ($spc27de0['payway'] === 'mobile') { $spd5cc4d = \Alipay\AlipayRequestFactory::create('alipay.trade.wap.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spba04f6, 'product_code' => 'QUICK_WAP_WAY', 'total_amount' => $sp9b2bb6, 'subject' => $sp9f49de))); $spb34b01 = $this->aop($spc27de0)->pageExecuteUrl($spd5cc4d); header('location: ' . $spb34b01); } die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; if ($spb2acff) { if ($this->aop($spc27de0)->verify($_POST)) { if ($_POST['trade_status'] === 'TRADE_SUCCESS') { $spa24b71 = $_POST['trade_no']; $sp36f78e = (int) round($_POST['total_amount'] * 100); $sp4294a3($_POST['out_trade_no'], $sp36f78e, $spa24b71); } } else { Log::error('Pay.AliAop.goPay.verify Error: ' . json_encode($_POST)); } echo 'success'; die; } if (!empty($spc27de0['out_trade_no'])) { $spba04f6 = $spc27de0['out_trade_no']; $spd5cc4d = \Alipay\AlipayRequestFactory::create('alipay.trade.query', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $spba04f6))); try { $spb34b01 = $this->aop($spc27de0)->execute($spd5cc4d)->getData(); } catch (\Throwable $spece20f) { return false; } if ($spb34b01['trade_status'] === 'TRADE_SUCCESS') { $spa24b71 = $spb34b01['trade_no']; $sp36f78e = (int) round($spb34b01['total_amount'] * 100); $sp4294a3($spb34b01['out_trade_no'], $sp36f78e, $spa24b71); return true; } } else { if (!isset($_GET['out_trade_no']) || !isset($_GET['total_amount'])) { return false; } $sp669554 = $this->aop($spc27de0)->verify($_GET); if (!$sp669554) { Log::error('Pay.AliAop.verify Error: 支付宝签名校验失败', array('$_GET' => $_GET)); return false; } $spa24b71 = $_GET['trade_no']; $sp36f78e = (int) round($_GET['total_amount'] * 100); $sp4294a3($_GET['out_trade_no'], $sp36f78e, $spa24b71); return true; } return false; } }
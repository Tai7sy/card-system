<?php
namespace App\Library\Pay\QweBank; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function getAccessToken($spc27de0) { $spbf3a2c = str_random(5); $sp5fcdf6 = time() . '00'; $sp75e4cc = strtoupper(md5('merchantNo=' . $spc27de0['mchid'] . '&nonce=' . $spbf3a2c . '&timestamp=' . $sp5fcdf6 . '&key=' . $spc27de0['key'])); $sp3e77f9 = json_encode(array('merchantNo' => $spc27de0['mchid'], 'key' => $spc27de0['key'], 'nonce' => $spbf3a2c, 'timestamp' => $sp5fcdf6, 'sign' => $sp75e4cc), JSON_FORCE_OBJECT); $sp4187a7 = CurlRequest::post('http://api.qwebank.top/open/v1/getAccessToken/merchant', $sp3e77f9, array('Content-Type' => 'application/json')); $sp29a775 = @json_decode($sp4187a7, true); if (!is_array($sp29a775) || !isset($sp29a775['value']) || !isset($sp29a775['value']['accessToken'])) { Log::error('Pay.QweBank.getAccessToken Error: ' . $sp4187a7); throw new \Exception('获取支付渠道失败，请联系客服反馈'); } return $sp29a775['value']['accessToken']; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { if (!isset($spc27de0['mchid'])) { throw new \Exception('请填写 mchid'); } if (!isset($spc27de0['key'])) { throw new \Exception('请填写 key'); } $spd53b1c = $spc27de0['payway']; $sp3e77f9 = array('accessToken' => $this->getAccessToken($spc27de0), 'param' => array('outTradeNo' => $spba04f6, 'money' => $sp6956b3, 'type' => 'T0', 'body' => $sp9f49de, 'detail' => $sp9f49de, 'notifyUrl' => $this->url_notify, 'successUrl' => $this->url_return, 'productId' => '12313', 'timestamp' => strval(time()), 'sign' => '1')); if ($spd53b1c === 'wechatWapPay') { $sp3e77f9['param']['merchantIp'] = Helper::getIP(); } if ($spd53b1c === 'bankPay') { if (!isset($spc27de0['bankName'])) { throw new \Exception('请填写 bankName'); } $sp3e77f9['param']['bankName'] = $spc27de0['bankName']; } $sp4187a7 = CurlRequest::post('http://api.qwebank.top/open/v1/order/' . $spd53b1c, json_encode($sp3e77f9, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $sp29a775 = @json_decode($sp4187a7, true); if (!is_array($sp29a775) || !isset($sp29a775['success']) || !isset($sp29a775['value'])) { Log::error('Pay.QweBank.goPay Error: ' . $sp4187a7); throw new \Exception('提交订单到支付渠道失败，请联系客服反馈'); } header('Location: ' . $sp29a775['value']); die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; $spb34b01 = false; if ($spb2acff) { $sp3868ff = 'merchantNo=' . $_REQUEST['merchantNo'] . '&no=' . $_REQUEST['no'] . '&nonce=' . $_REQUEST['nonce'] . '&timestamp=' . $_REQUEST['timestamp'] . '&key=' . $spc27de0['key']; if (md5($sp3868ff) !== $_REQUEST['sign']) { $spb34b01 = true; } echo $spb34b01 ? 'SUCCESS' : 'fail'; } else { $spba04f6 = $_REQUEST['outTradeNo']; $sp3e77f9 = array('accessToken' => $this->getAccessToken($spc27de0), 'param' => $spba04f6); $sp4187a7 = CurlRequest::post('http://api.qwebank.top/open/v1/order/getByCustomerNo', json_encode($sp3e77f9, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $sp29a775 = @json_decode($sp4187a7, true); if (!is_array($sp29a775) || !isset($sp29a775['success']) || !isset($sp29a775['value'])) { Log::error('Pay.QweBank.verify.getByCustomerNo Error: ' . $sp4187a7); return false; } $spb34b01 = $sp29a775['value']['done'] === true; } if ($spb34b01) { $spba04f6 = $_REQUEST['outTradeNo']; $sp36f78e = $_REQUEST['money']; $spa1a812 = $_REQUEST['no']; $sp4294a3($spba04f6, $sp36f78e, $spa1a812); return true; } return false; } }
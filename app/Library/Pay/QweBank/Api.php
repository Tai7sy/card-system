<?php
namespace App\Library\Pay\QweBank; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function getAccessToken($sp9d4382) { $spd551e5 = str_random(5); $sp72c5f0 = time() . '00'; $sp964415 = strtoupper(md5('merchantNo=' . $sp9d4382['mchid'] . '&nonce=' . $spd551e5 . '&timestamp=' . $sp72c5f0 . '&key=' . $sp9d4382['key'])); $spc0e525 = json_encode(array('merchantNo' => $sp9d4382['mchid'], 'key' => $sp9d4382['key'], 'nonce' => $spd551e5, 'timestamp' => $sp72c5f0, 'sign' => $sp964415), JSON_FORCE_OBJECT); $sp42422c = CurlRequest::post('http://api.qwebank.top/open/v1/getAccessToken/merchant', $spc0e525, array('Content-Type' => 'application/json')); $sp9b52fe = @json_decode($sp42422c, true); if (!is_array($sp9b52fe) || !isset($sp9b52fe['value']) || !isset($sp9b52fe['value']['accessToken'])) { Log::error('Pay.QweBank.getAccessToken Error: ' . $sp42422c); throw new \Exception('获取支付渠道失败，请联系客服反馈'); } return $sp9b52fe['value']['accessToken']; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { if (!isset($sp9d4382['mchid'])) { throw new \Exception('请填写 mchid'); } if (!isset($sp9d4382['key'])) { throw new \Exception('请填写 key'); } $spf9ca0c = $sp9d4382['payway']; $spc0e525 = array('accessToken' => $this->getAccessToken($sp9d4382), 'param' => array('outTradeNo' => $sp2e47fc, 'money' => $sp076ec7, 'type' => 'T0', 'body' => $spd4e90d, 'detail' => $spd4e90d, 'notifyUrl' => $this->url_notify, 'successUrl' => $this->url_return, 'productId' => '12313', 'timestamp' => strval(time()), 'sign' => '1')); if ($spf9ca0c === 'wechatWapPay') { $spc0e525['param']['merchantIp'] = Helper::getIP(); } if ($spf9ca0c === 'bankPay') { if (!isset($sp9d4382['bankName'])) { throw new \Exception('请填写 bankName'); } $spc0e525['param']['bankName'] = $sp9d4382['bankName']; } $sp42422c = CurlRequest::post('http://api.qwebank.top/open/v1/order/' . $spf9ca0c, json_encode($spc0e525, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $sp9b52fe = @json_decode($sp42422c, true); if (!is_array($sp9b52fe) || !isset($sp9b52fe['success']) || !isset($sp9b52fe['value'])) { Log::error('Pay.QweBank.goPay Error: ' . $sp42422c); throw new \Exception('提交订单到支付渠道失败，请联系客服反馈'); } header('Location: ' . $sp9b52fe['value']); die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; $spb72f32 = false; if ($sp7b2182) { $sp14800d = 'merchantNo=' . $_REQUEST['merchantNo'] . '&no=' . $_REQUEST['no'] . '&nonce=' . $_REQUEST['nonce'] . '&timestamp=' . $_REQUEST['timestamp'] . '&key=' . $sp9d4382['key']; if (md5($sp14800d) !== $_REQUEST['sign']) { $spb72f32 = true; } echo $spb72f32 ? 'SUCCESS' : 'fail'; } else { $sp2e47fc = $_REQUEST['outTradeNo']; $spc0e525 = array('accessToken' => $this->getAccessToken($sp9d4382), 'param' => $sp2e47fc); $sp42422c = CurlRequest::post('http://api.qwebank.top/open/v1/order/getByCustomerNo', json_encode($spc0e525, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $sp9b52fe = @json_decode($sp42422c, true); if (!is_array($sp9b52fe) || !isset($sp9b52fe['success']) || !isset($sp9b52fe['value'])) { Log::error('Pay.QweBank.verify.getByCustomerNo Error: ' . $sp42422c); return false; } $spb72f32 = $sp9b52fe['value']['done'] === true; } if ($spb72f32) { $sp2e47fc = $_REQUEST['outTradeNo']; $spc686cf = $_REQUEST['money']; $sp02e5fb = $_REQUEST['no']; $sp9a4d97($sp2e47fc, $spc686cf, $sp02e5fb); return true; } return false; } }
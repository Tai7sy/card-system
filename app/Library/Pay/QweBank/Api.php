<?php
namespace App\Library\Pay\QweBank; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function getAccessToken($spbe80b7) { $sp89b050 = str_random(5); $spd60ac6 = time() . '00'; $spa109d2 = strtoupper(md5('merchantNo=' . $spbe80b7['mchid'] . '&nonce=' . $sp89b050 . '&timestamp=' . $spd60ac6 . '&key=' . $spbe80b7['key'])); $spa26894 = json_encode(array('merchantNo' => $spbe80b7['mchid'], 'key' => $spbe80b7['key'], 'nonce' => $sp89b050, 'timestamp' => $spd60ac6, 'sign' => $spa109d2), JSON_FORCE_OBJECT); $sp00a165 = CurlRequest::post('http://api.qwebank.top/open/v1/getAccessToken/merchant', $spa26894, array('Content-Type' => 'application/json')); $spb9589c = @json_decode($sp00a165, true); if (!is_array($spb9589c) || !isset($spb9589c['value']) || !isset($spb9589c['value']['accessToken'])) { Log::error('Pay.QweBank.getAccessToken Error: ' . $sp00a165); throw new \Exception('获取支付渠道失败，请联系客服反馈'); } return $spb9589c['value']['accessToken']; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { if (!isset($spbe80b7['mchid'])) { throw new \Exception('请填写 mchid'); } if (!isset($spbe80b7['key'])) { throw new \Exception('请填写 key'); } $spdc9a36 = $spbe80b7['payway']; $spa26894 = array('accessToken' => $this->getAccessToken($spbe80b7), 'param' => array('outTradeNo' => $spa3e681, 'money' => $sp5213ee, 'type' => 'T0', 'body' => $sp45f07e, 'detail' => $sp45f07e, 'notifyUrl' => $this->url_notify, 'successUrl' => $this->url_return, 'productId' => '12313', 'timestamp' => strval(time()), 'sign' => '1')); if ($spdc9a36 === 'wechatWapPay') { $spa26894['param']['merchantIp'] = Helper::getIP(); } if ($spdc9a36 === 'bankPay') { if (!isset($spbe80b7['bankName'])) { throw new \Exception('请填写 bankName'); } $spa26894['param']['bankName'] = $spbe80b7['bankName']; } $sp00a165 = CurlRequest::post('http://api.qwebank.top/open/v1/order/' . $spdc9a36, json_encode($spa26894, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $spb9589c = @json_decode($sp00a165, true); if (!is_array($spb9589c) || !isset($spb9589c['success']) || !isset($spb9589c['value'])) { Log::error('Pay.QweBank.goPay Error: ' . $sp00a165); throw new \Exception('提交订单到支付渠道失败，请联系客服反馈'); } header('Location: ' . $spb9589c['value']); die; } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; $spbbda25 = false; if ($sp3bce01) { $sp72201b = 'merchantNo=' . $_REQUEST['merchantNo'] . '&no=' . $_REQUEST['no'] . '&nonce=' . $_REQUEST['nonce'] . '&timestamp=' . $_REQUEST['timestamp'] . '&key=' . $spbe80b7['key']; if (md5($sp72201b) !== $_REQUEST['sign']) { $spbbda25 = true; } echo $spbbda25 ? 'SUCCESS' : 'fail'; } else { $spa3e681 = $_REQUEST['outTradeNo']; $spa26894 = array('accessToken' => $this->getAccessToken($spbe80b7), 'param' => $spa3e681); $sp00a165 = CurlRequest::post('http://api.qwebank.top/open/v1/order/getByCustomerNo', json_encode($spa26894, JSON_FORCE_OBJECT), array('Content-Type' => 'application/json')); $spb9589c = @json_decode($sp00a165, true); if (!is_array($spb9589c) || !isset($spb9589c['success']) || !isset($spb9589c['value'])) { Log::error('Pay.QweBank.verify.getByCustomerNo Error: ' . $sp00a165); return false; } $spbbda25 = $spb9589c['value']['done'] === true; } if ($spbbda25) { $spa3e681 = $_REQUEST['outTradeNo']; $sp9624ba = $_REQUEST['money']; $spf71d25 = $_REQUEST['no']; $sp04f0f8($spa3e681, $sp9624ba, $spf71d25); return true; } return false; } }
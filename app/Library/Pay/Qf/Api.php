<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { $sp908e43 = strtolower($spbe80b7['payway']); if (!isset($spbe80b7['id'])) { throw new \Exception('请设置 id'); } $sp28070b = array(); if ($sp908e43 == 'qq') { $sp28070b = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($sp908e43 == 'alipay') { $sp28070b = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $spba2d44 = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $spbe80b7['id'] . '&opuid=&reqid=' . $spa3e681, $sp28070b); $sp49dccd = static::str_between($spba2d44, 'reqid":"', '"'); $sp77e39b = static::str_between($spba2d44, 'currency":"', '"'); if ($sp49dccd == '' || $sp77e39b == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $spba2d44); throw new \Exception('获取支付请求id失败'); } $sp5c64ef = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp5213ee . '&openid=&appid=&huid=' . $spbe80b7['id'] . '&opuid=&reqid=' . $sp49dccd . '&balance=0&currency=' . $sp77e39b, $sp28070b); $spbbda25 = json_decode($sp5c64ef, true); $sp9bcaff = static::str_between($sp5c64ef, 'syssn":"', '"'); if (!$spbbda25 || $sp9bcaff == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp5c64ef); throw new \Exception('生成支付单号失败#1'); } if ($spbbda25['respcd'] !== '0000') { if (isset($spbbda25['respmsg']) && $spbbda25['respmsg'] !== '') { throw new \Exception($spbbda25['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp5c64ef); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($spa3e681)->update(array('pay_trade_no' => $sp9bcaff)); header('location: /qrcode/pay/' . $spa3e681 . '/qf_' . $sp908e43 . '?url=' . urlencode(json_encode($spbbda25['data']['pay_params']))); } function verify($spbe80b7, $sp04f0f8) { $sp4f4c0d = \App\Order::whereOrderNo($spbe80b7['out_trade_no'])->firstOrFail(); $sp9bcaff = $sp4f4c0d->pay_trade_no; $spc21b90 = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $sp9bcaff); $sp8abb03 = json_decode($spc21b90, true); if (!$spc21b90) { throw new \Exception('query error'); } if (!isset($sp8abb03['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $spc21b90); throw new \Exception('获取支付结果失败'); } if ($sp8abb03['respcd'] !== '0000') { return false; } $sp1953fc = (int) static::str_between($spc21b90, 'trade_amt":', ','); if ($sp1953fc === 0) { $sp1953fc = (int) static::str_between($spc21b90, 'txamt":', ','); if ($sp1953fc === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $spc21b90); throw new \Exception('获取支付金额失败'); } } if ($sp8abb03['respcd'] === '0000') { $sp04f0f8($spbe80b7['out_trade_no'], $sp1953fc, $sp9bcaff); return true; } return false; } public static function str_between($sp72201b, $sp518d68, $sp966620) { $spae03e3 = stripos($sp72201b, $sp518d68); if ($spae03e3 === false) { return ''; } $sp70b0e5 = stripos($sp72201b, $sp966620, $spae03e3 + strlen($sp518d68)); if ($sp70b0e5 === false || $spae03e3 >= $sp70b0e5) { return ''; } $sp19f67c = strlen($sp518d68); $spb9589c = substr($sp72201b, $spae03e3 + $sp19f67c, $sp70b0e5 - $spae03e3 - $sp19f67c); return $spb9589c; } }
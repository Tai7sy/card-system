<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { $spf9ad85 = strtolower($sp9d4382['payway']); if (!isset($sp9d4382['id'])) { throw new \Exception('请设置 id'); } $spc69671 = array(); if ($spf9ad85 == 'qq') { $spc69671 = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($spf9ad85 == 'alipay') { $spc69671 = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $sp63b8fa = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $sp9d4382['id'] . '&opuid=&reqid=' . $sp2e47fc, $spc69671); $sp099e22 = static::str_between($sp63b8fa, 'reqid":"', '"'); $sp74cf99 = static::str_between($sp63b8fa, 'currency":"', '"'); if ($sp099e22 == '' || $sp74cf99 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $sp63b8fa); throw new \Exception('获取支付请求id失败'); } $sp1ad0f6 = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp076ec7 . '&openid=&appid=&huid=' . $sp9d4382['id'] . '&opuid=&reqid=' . $sp099e22 . '&balance=0&currency=' . $sp74cf99, $spc69671); $spb72f32 = json_decode($sp1ad0f6, true); $spccd6e0 = static::str_between($sp1ad0f6, 'syssn":"', '"'); if (!$spb72f32 || $spccd6e0 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp1ad0f6); throw new \Exception('生成支付单号失败#1'); } if ($spb72f32['respcd'] !== '0000') { if (isset($spb72f32['respmsg']) && $spb72f32['respmsg'] !== '') { throw new \Exception($spb72f32['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp1ad0f6); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp2e47fc)->update(array('pay_trade_no' => $spccd6e0)); header('location: /qrcode/pay/' . $sp2e47fc . '/qf_' . $spf9ad85 . '?url=' . urlencode(json_encode($spb72f32['data']['pay_params']))); } function verify($sp9d4382, $sp9a4d97) { $spe0613f = \App\Order::whereOrderNo($sp9d4382['out_trade_no'])->firstOrFail(); $spccd6e0 = $spe0613f->pay_trade_no; $sp68346c = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $spccd6e0); $sp3fb247 = json_decode($sp68346c, true); if (!$sp68346c) { throw new \Exception('query error'); } if (!isset($sp3fb247['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $sp68346c); throw new \Exception('获取支付结果失败'); } if ($sp3fb247['respcd'] !== '0000') { return false; } $sp68a03b = (int) static::str_between($sp68346c, 'trade_amt":', ','); if ($sp68a03b === 0) { $sp68a03b = (int) static::str_between($sp68346c, 'txamt":', ','); if ($sp68a03b === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $sp68346c); throw new \Exception('获取支付金额失败'); } } if ($sp3fb247['respcd'] === '0000') { $sp9a4d97($sp9d4382['out_trade_no'], $sp68a03b, $spccd6e0); return true; } return false; } public static function str_between($sp14800d, $sp974326, $sp0480e1) { $spe3a4eb = stripos($sp14800d, $sp974326); if ($spe3a4eb === false) { return ''; } $sp368574 = stripos($sp14800d, $sp0480e1, $spe3a4eb + strlen($sp974326)); if ($sp368574 === false || $spe3a4eb >= $sp368574) { return ''; } $spc24183 = strlen($sp974326); $sp9b52fe = substr($sp14800d, $spe3a4eb + $spc24183, $sp368574 - $spe3a4eb - $spc24183); return $sp9b52fe; } }
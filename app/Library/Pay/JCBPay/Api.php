<?php
namespace App\Library\Pay\JCBPay; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { if (!isset($sp9d4382['url'])) { throw new \Exception('请填写支付网页 [url]'); } if (!isset($sp9d4382['app_id'])) { throw new \Exception('请填写APPID [app_id]'); } if (!isset($sp9d4382['app_key'])) { throw new \Exception('请填写APPKEY [app_key]'); } if (!isset($sp9d4382['key'])) { throw new \Exception('请填写接口key [key]'); } if (!isset($sp9d4382['md5key'])) { throw new \Exception('请填写校验key [md5key]'); } header('Location: ' . $sp9d4382['url'] . '/pay/pay.php?appid=' . $sp9d4382['app_id'] . '&payno=' . $sp2e47fc . '&typ=' . $sp9d4382['payway'] . '&money=' . sprintf('%.2f', $sp076ec7 / 100) . '&back_url=' . $this->url_return); die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; if ($sp7b2182) { $sp9bccca = $_REQUEST['key']; $spfacb4d = $_REQUEST['tno']; $spa7d731 = $_REQUEST['payno']; $sp09649b = $_REQUEST['money']; $sp964415 = $_REQUEST['sign']; $sp4d0ea0 = (int) $_REQUEST['typ']; if ($sp4d0ea0 == 1) { $sp55a9e5 = '手工充值'; } else { if ($sp4d0ea0 == 2) { $sp55a9e5 = '支付宝充值'; } else { if ($sp4d0ea0 == 3) { $sp55a9e5 = '财付通充值'; } else { if ($sp4d0ea0 == 4) { $sp55a9e5 = '手Q充值'; } else { if ($sp4d0ea0 == 5) { $sp55a9e5 = '微信充值'; } } } } } if (!$spfacb4d) { die('没有订单号'); } if (!$spa7d731) { die('没有付款说明'); } if ($sp9bccca !== $sp9d4382['key']) { die('KEY错误'); } if (strtoupper($sp964415) !== strtoupper(md5($spfacb4d . $spa7d731 . $sp09649b . $sp9d4382['md5key']))) { die('签名错误'); } $spe0613f = \App\Order::whereOrderNo($spa7d731)->first(); if (!$spe0613f) { die('订单不存在'); } $sp9a4d97($spa7d731, (int) round($sp09649b * 100), $spfacb4d); die('1'); } else { if (isset($sp9d4382['out_trade_no']) && $sp9d4382['out_trade_no']) { return false; } if (!isset($_REQUEST['appid']) || !isset($_REQUEST['tno']) || !isset($_REQUEST['payno']) || !isset($_REQUEST['money']) || !isset($_REQUEST['typ']) || !isset($_REQUEST['paytime']) || !isset($_REQUEST['sign'])) { return false; } $sp838bba = (int) $_REQUEST['appid']; $spfacb4d = $_REQUEST['tno']; $spa7d731 = $_REQUEST['payno']; $sp09649b = $_REQUEST['money']; $sp4d0ea0 = (int) $_REQUEST['typ']; $sp0f39aa = $_REQUEST['paytime']; $sp964415 = $_REQUEST['sign']; if (!$sp838bba || !$spfacb4d || !$spa7d731 || !$sp09649b || !$sp4d0ea0 || !$sp0f39aa || !$sp964415) { die('参数错误'); } if ($sp9d4382['app_id'] != $sp838bba) { die('appid error'); } if ($sp964415 != md5($sp838bba . '|' . $sp9d4382['app_key'] . '|' . $spfacb4d . '|' . $spa7d731 . '|' . $sp09649b . '|' . $sp0f39aa . '|' . $sp4d0ea0)) { die('签名错误'); } if ($sp4d0ea0 == 1) { $sp55a9e5 = '手工充值'; } else { if ($sp4d0ea0 == 2) { $sp55a9e5 = '支付宝充值'; } else { if ($sp4d0ea0 == 3) { $sp55a9e5 = '财付通充值'; } else { if ($sp4d0ea0 == 4) { $sp55a9e5 = '手Q充值'; } else { if ($sp4d0ea0 == 5) { $sp55a9e5 = '微信充值'; } } } } } $sp9a4d97($spa7d731, (int) round($sp09649b * 100), $spfacb4d); return true; } } }
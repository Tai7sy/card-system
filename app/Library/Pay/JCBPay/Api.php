<?php
namespace App\Library\Pay\JCBPay; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { if (!isset($spbe80b7['url'])) { throw new \Exception('请填写支付网页 [url]'); } if (!isset($spbe80b7['app_id'])) { throw new \Exception('请填写APPID [app_id]'); } if (!isset($spbe80b7['app_key'])) { throw new \Exception('请填写APPKEY [app_key]'); } if (!isset($spbe80b7['key'])) { throw new \Exception('请填写接口key [key]'); } if (!isset($spbe80b7['md5key'])) { throw new \Exception('请填写校验key [md5key]'); } header('Location: ' . $spbe80b7['url'] . '/pay/pay.php?appid=' . $spbe80b7['app_id'] . '&payno=' . $spa3e681 . '&typ=' . $spbe80b7['payway'] . '&money=' . sprintf('%.2f', $sp5213ee / 100) . '&back_url=' . $this->url_return); die; } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; if ($sp3bce01) { $sp71b14a = $_REQUEST['key']; $sp705a43 = $_REQUEST['tno']; $sp2a9948 = $_REQUEST['payno']; $sp821e1f = $_REQUEST['money']; $spa109d2 = $_REQUEST['sign']; $sp9c3d17 = (int) $_REQUEST['typ']; if ($sp9c3d17 == 1) { $sp033008 = '手工充值'; } else { if ($sp9c3d17 == 2) { $sp033008 = '支付宝充值'; } else { if ($sp9c3d17 == 3) { $sp033008 = '财付通充值'; } else { if ($sp9c3d17 == 4) { $sp033008 = '手Q充值'; } else { if ($sp9c3d17 == 5) { $sp033008 = '微信充值'; } } } } } if (!$sp705a43) { die('没有订单号'); } if (!$sp2a9948) { die('没有付款说明'); } if ($sp71b14a !== $spbe80b7['key']) { die('KEY错误'); } if (strtoupper($spa109d2) !== strtoupper(md5($sp705a43 . $sp2a9948 . $sp821e1f . $spbe80b7['md5key']))) { die('签名错误'); } $sp4f4c0d = \App\Order::whereOrderNo($sp2a9948)->first(); if (!$sp4f4c0d) { die('订单不存在'); } $sp04f0f8($sp2a9948, (int) round($sp821e1f * 100), $sp705a43); die('1'); } else { if (isset($spbe80b7['out_trade_no']) && $spbe80b7['out_trade_no']) { return false; } if (!isset($_REQUEST['appid']) || !isset($_REQUEST['tno']) || !isset($_REQUEST['payno']) || !isset($_REQUEST['money']) || !isset($_REQUEST['typ']) || !isset($_REQUEST['paytime']) || !isset($_REQUEST['sign'])) { return false; } $sp630d17 = (int) $_REQUEST['appid']; $sp705a43 = $_REQUEST['tno']; $sp2a9948 = $_REQUEST['payno']; $sp821e1f = $_REQUEST['money']; $sp9c3d17 = (int) $_REQUEST['typ']; $spcbb09b = $_REQUEST['paytime']; $spa109d2 = $_REQUEST['sign']; if (!$sp630d17 || !$sp705a43 || !$sp2a9948 || !$sp821e1f || !$sp9c3d17 || !$spcbb09b || !$spa109d2) { die('参数错误'); } if ($spbe80b7['app_id'] != $sp630d17) { die('appid error'); } if ($spa109d2 != md5($sp630d17 . '|' . $spbe80b7['app_key'] . '|' . $sp705a43 . '|' . $sp2a9948 . '|' . $sp821e1f . '|' . $spcbb09b . '|' . $sp9c3d17)) { die('签名错误'); } if ($sp9c3d17 == 1) { $sp033008 = '手工充值'; } else { if ($sp9c3d17 == 2) { $sp033008 = '支付宝充值'; } else { if ($sp9c3d17 == 3) { $sp033008 = '财付通充值'; } else { if ($sp9c3d17 == 4) { $sp033008 = '手Q充值'; } else { if ($sp9c3d17 == 5) { $sp033008 = '微信充值'; } } } } } $sp04f0f8($sp2a9948, (int) round($sp821e1f * 100), $sp705a43); return true; } } }
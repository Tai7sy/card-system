<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { $spf59c91 = sprintf('%.2f', $sp076ec7 / 100); $sp02f7d5 = $sp9d4382['id']; $spf91bac = $sp9d4382['key']; switch ($sp9d4382['payway']) { case 'alipay': $sp4f56c1 = 1; break; case 'qq': $sp4f56c1 = 2; break; case 'weixin': $sp4f56c1 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp6fd648 = array('id' => $sp02f7d5, 'pay_id' => $sp2e47fc, 'type' => $sp4f56c1, 'price' => $spf59c91, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp6fd648); $sp964415 = ''; $sp80efd3 = ''; foreach ($sp6fd648 as $spf1241f => $sp91e29b) { if ($sp91e29b == '' || $spf1241f == 'sign') { continue; } if ($sp964415 != '') { $sp964415 .= '&'; $sp80efd3 .= '&'; } $sp964415 .= "{$spf1241f}={$sp91e29b}"; $sp80efd3 .= "{$spf1241f}=" . urlencode($sp91e29b); } $sp5044a7 = $sp80efd3 . '&sign=' . md5($sp964415 . $spf91bac); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp5044a7); die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; $sp02f7d5 = $sp9d4382['id']; $spf91bac = $sp9d4382['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp964415 = ''; foreach ($_POST as $spf1241f => $sp91e29b) { if ($sp91e29b == '' || $spf1241f == 'sign') { continue; } if ($sp964415) { $sp964415 .= '&'; } $sp964415 .= "{$spf1241f}={$sp91e29b}"; } if (!isset($_POST['pay_no']) || md5($sp964415 . $spf91bac) != $_POST['sign']) { if ($sp7b2182) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp7b2182) { echo 'fail'; } return false; } $sp2e47fc = $_POST['pay_id']; $spc686cf = (int) round($_POST['price'] * 100); $sp565d18 = $_POST['pay_no']; $sp9a4d97($sp2e47fc, $spc686cf, $sp565d18); if ($sp7b2182) { echo 'success'; } return true; } } }
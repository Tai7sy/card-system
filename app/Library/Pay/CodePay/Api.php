<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $sp9b2bb6 = sprintf('%.2f', $sp6956b3 / 100); $sp1341ed = $spc27de0['id']; $spdc28b0 = $spc27de0['key']; switch ($spc27de0['payway']) { case 'alipay': $spdc3fe5 = 1; break; case 'qq': $spdc3fe5 = 2; break; case 'weixin': $spdc3fe5 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $spcb019a = array('id' => $sp1341ed, 'pay_id' => $spba04f6, 'type' => $spdc3fe5, 'price' => $sp9b2bb6, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($spcb019a); $sp75e4cc = ''; $spbf6a13 = ''; foreach ($spcb019a as $sp7b7024 => $spcb4459) { if ($spcb4459 == '' || $sp7b7024 == 'sign') { continue; } if ($sp75e4cc != '') { $sp75e4cc .= '&'; $spbf6a13 .= '&'; } $sp75e4cc .= "{$sp7b7024}={$spcb4459}"; $spbf6a13 .= "{$sp7b7024}=" . urlencode($spcb4459); } $spe440a8 = $spbf6a13 . '&sign=' . md5($sp75e4cc . $spdc28b0); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $spe440a8); die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; $sp1341ed = $spc27de0['id']; $spdc28b0 = $spc27de0['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp75e4cc = ''; foreach ($_POST as $sp7b7024 => $spcb4459) { if ($spcb4459 == '' || $sp7b7024 == 'sign') { continue; } if ($sp75e4cc) { $sp75e4cc .= '&'; } $sp75e4cc .= "{$sp7b7024}={$spcb4459}"; } if (!isset($_POST['pay_no']) || md5($sp75e4cc . $spdc28b0) != $_POST['sign']) { if ($spb2acff) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($spb2acff) { echo 'fail'; } return false; } $spba04f6 = $_POST['pay_id']; $sp36f78e = (int) round($_POST['price'] * 100); $spa24b71 = $_POST['pay_no']; $sp4294a3($spba04f6, $sp36f78e, $spa24b71); if ($spb2acff) { echo 'success'; } return true; } } }
<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { $sp429fcc = sprintf('%.2f', $sp5213ee / 100); $sp2f8f8a = $spbe80b7['id']; $spd436e0 = $spbe80b7['key']; switch ($spbe80b7['payway']) { case 'alipay': $sp8f5ac7 = 1; break; case 'qq': $sp8f5ac7 = 2; break; case 'weixin': $sp8f5ac7 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp5aa598 = array('id' => $sp2f8f8a, 'pay_id' => $spa3e681, 'type' => $sp8f5ac7, 'price' => $sp429fcc, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp5aa598); $spa109d2 = ''; $sp17d1a7 = ''; foreach ($sp5aa598 as $sp1ed429 => $sp36ecf9) { if ($sp36ecf9 == '' || $sp1ed429 == 'sign') { continue; } if ($spa109d2 != '') { $spa109d2 .= '&'; $sp17d1a7 .= '&'; } $spa109d2 .= "{$sp1ed429}={$sp36ecf9}"; $sp17d1a7 .= "{$sp1ed429}=" . urlencode($sp36ecf9); } $sp5786ca = $sp17d1a7 . '&sign=' . md5($spa109d2 . $spd436e0); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp5786ca); die; } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; $sp2f8f8a = $spbe80b7['id']; $spd436e0 = $spbe80b7['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $spa109d2 = ''; foreach ($_POST as $sp1ed429 => $sp36ecf9) { if ($sp36ecf9 == '' || $sp1ed429 == 'sign') { continue; } if ($spa109d2) { $spa109d2 .= '&'; } $spa109d2 .= "{$sp1ed429}={$sp36ecf9}"; } if (!isset($_POST['pay_no']) || md5($spa109d2 . $spd436e0) != $_POST['sign']) { if ($sp3bce01) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp3bce01) { echo 'fail'; } return false; } $spa3e681 = $_POST['pay_id']; $sp9624ba = (int) round($_POST['price'] * 100); $sp4d48a7 = $_POST['pay_no']; $sp04f0f8($spa3e681, $sp9624ba, $sp4d48a7); if ($sp3bce01) { echo 'success'; } return true; } } }
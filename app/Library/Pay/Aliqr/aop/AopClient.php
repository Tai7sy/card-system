<?php
require_once 'AopEncrypt.php'; class AopClient { public $appId; public $rsaPrivateKeyFilePath; public $rsaPrivateKey; public $gatewayUrl = 'https://openapi.alipay.com/gateway.do'; public $format = 'json'; public $apiVersion = '1.0'; public $postCharset = 'UTF-8'; public $alipayPublicKey = null; public $alipayrsaPublicKey; public $debugInfo = false; private $fileCharset = 'UTF-8'; private $RESPONSE_SUFFIX = '_response'; private $ERROR_RESPONSE = 'error_response'; private $SIGN_NODE_NAME = 'sign'; private $ENCRYPT_XML_NODE_NAME = 'response_encrypted'; private $needEncrypt = false; public $signType = 'RSA'; public $encryptKey; public $encryptType = 'AES'; protected $alipaySdkVersion = 'alipay-sdk-php-20161101'; public function generateSign($sp342eea, $sp6cf5f4 = 'RSA') { return $this->sign($this->getSignContent($sp342eea), $sp6cf5f4); } public function rsaSign($sp342eea, $sp6cf5f4 = 'RSA') { return $this->sign($this->getSignContent($sp342eea), $sp6cf5f4); } protected function getSignContent($sp342eea) { ksort($sp342eea); $sp8550e9 = ''; $sp218d20 = 0; foreach ($sp342eea as $sp783862 => $spce84f3) { if (false === $this->checkEmpty($spce84f3) && '@' != substr($spce84f3, 0, 1)) { $spce84f3 = $this->characet($spce84f3, $this->postCharset); if ($sp218d20 == 0) { $sp8550e9 .= "{$sp783862}" . '=' . "{$spce84f3}"; } else { $sp8550e9 .= '&' . "{$sp783862}" . '=' . "{$spce84f3}"; } $sp218d20++; } } unset($sp783862, $spce84f3); return $sp8550e9; } protected function sign($spbda5b4, $sp6cf5f4 = 'RSA') { if ($this->checkEmpty($this->rsaPrivateKeyFilePath)) { $sp4e391a = $this->rsaPrivateKey; $sp868884 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp4e391a, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; } else { $sp4e391a = file_get_contents($this->rsaPrivateKeyFilePath); $sp868884 = openssl_get_privatekey($sp4e391a); } $sp868884 or die('æ‚¨ä½¿ç”¨çš„ç§é’¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥RSAç§é’¥é…ç½®'); if ('RSA2' == $sp6cf5f4) { openssl_sign($spbda5b4, $spa0f4ca, $sp868884, OPENSSL_ALGO_SHA256); } else { openssl_sign($spbda5b4, $spa0f4ca, $sp868884); } if (!$this->checkEmpty($this->rsaPrivateKeyFilePath)) { openssl_free_key($sp868884); } $spa0f4ca = base64_encode($spa0f4ca); return $spa0f4ca; } protected function curl($sp81923e, $spa40ebd = null) { $spd7a82f = curl_init(); curl_setopt($spd7a82f, CURLOPT_URL, $sp81923e); curl_setopt($spd7a82f, CURLOPT_FAILONERROR, false); curl_setopt($spd7a82f, CURLOPT_RETURNTRANSFER, true); curl_setopt($spd7a82f, CURLOPT_SSL_VERIFYPEER, false); $sp51482f = ''; $spce7e12 = array(); $spc3fcb8 = false; if (is_array($spa40ebd) && 0 < count($spa40ebd)) { foreach ($spa40ebd as $sp783862 => $spce84f3) { if ('@' != substr($spce84f3, 0, 1)) { $sp51482f .= "{$sp783862}=" . urlencode($this->characet($spce84f3, $this->postCharset)) . '&'; $spce7e12[$sp783862] = $this->characet($spce84f3, $this->postCharset); } else { $spc3fcb8 = true; $spce7e12[$sp783862] = new \CURLFile(substr($spce84f3, 1)); } } unset($sp783862, $spce84f3); curl_setopt($spd7a82f, CURLOPT_POST, true); if ($spc3fcb8) { curl_setopt($spd7a82f, CURLOPT_POSTFIELDS, $spce7e12); } else { curl_setopt($spd7a82f, CURLOPT_POSTFIELDS, substr($sp51482f, 0, -1)); } } if ($spc3fcb8) { $sp79f0c2 = array('content-type: multipart/form-data;charset=' . $this->postCharset . ';boundary=' . $this->getMillisecond()); } else { $sp79f0c2 = array('content-type: application/x-www-form-urlencoded;charset=' . $this->postCharset); } curl_setopt($spd7a82f, CURLOPT_HTTPHEADER, $sp79f0c2); $spa65a8b = curl_exec($spd7a82f); if (curl_errno($spd7a82f)) { throw new Exception(curl_error($spd7a82f), 0); } else { $sp7a3326 = curl_getinfo($spd7a82f, CURLINFO_HTTP_CODE); if (200 !== $sp7a3326) { throw new Exception($spa65a8b, $sp7a3326); } } curl_close($spd7a82f); return $spa65a8b; } protected function getMillisecond() { list($sp03f864, $sp9b7007) = explode(' ', microtime()); return (double) sprintf('%.0f', (floatval($sp03f864) + floatval($sp9b7007)) * 1000); } protected function logCommunicationError($sp2ee2b2, $spb23b8c, $sp83f0ea, $spfcc97d) { $sp64387a = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : 'CLI'; $spbe95fa = new LtLogger(); $spbe95fa->conf['log_file'] = rtrim(AOP_SDK_WORK_DIR, '\\/') . '/' . 'logs/aop_comm_err_' . $this->appId . '_' . date('Y-m-d') . '.log'; $spbe95fa->conf['separator'] = '^_^'; $sp3dcf07 = array(date('Y-m-d H:i:s'), $sp2ee2b2, $this->appId, $sp64387a, PHP_OS, $this->alipaySdkVersion, $spb23b8c, $sp83f0ea, str_replace('
', '', $spfcc97d)); $spbe95fa->log($sp3dcf07); } public function sdkExecute($spf631e6) { $this->setupCharsets($spf631e6); $sp342eea['app_id'] = $this->appId; $sp342eea['method'] = $spf631e6->getApiMethodName(); $sp342eea['format'] = $this->format; $sp342eea['sign_type'] = $this->signType; $sp342eea['timestamp'] = date('Y-m-d H:i:s'); $sp342eea['alipay_sdk'] = $this->alipaySdkVersion; $sp342eea['charset'] = $this->postCharset; $sp348765 = $spf631e6->getApiVersion(); $sp342eea['version'] = $this->checkEmpty($sp348765) ? $this->apiVersion : $sp348765; if ($sp296301 = $spf631e6->getNotifyUrl()) { $sp342eea['notify_url'] = $sp296301; } $spfd1159 = $spf631e6->getApiParas(); $sp342eea['biz_content'] = $spfd1159['biz_content']; ksort($sp342eea); $sp342eea['sign'] = $this->generateSign($sp342eea, $this->signType); foreach ($sp342eea as &$sp12919e) { $sp12919e = $this->characet($sp12919e, $sp342eea['charset']); } return http_build_query($sp342eea); } public function pageExecute($spf631e6, $spd35087 = 'POST') { $this->setupCharsets($spf631e6); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp735c57 = null; if (!$this->checkEmpty($spf631e6->getApiVersion())) { $sp735c57 = $spf631e6->getApiVersion(); } else { $sp735c57 = $this->apiVersion; } $sp2bd9cd['app_id'] = $this->appId; $sp2bd9cd['version'] = $sp735c57; $sp2bd9cd['format'] = $this->format; $sp2bd9cd['sign_type'] = $this->signType; $sp2bd9cd['method'] = $spf631e6->getApiMethodName(); $sp2bd9cd['timestamp'] = date('Y-m-d H:i:s'); $sp2bd9cd['alipay_sdk'] = $this->alipaySdkVersion; $sp2bd9cd['terminal_type'] = $spf631e6->getTerminalType(); $sp2bd9cd['terminal_info'] = $spf631e6->getTerminalInfo(); $sp2bd9cd['prod_code'] = $spf631e6->getProdCode(); $sp2bd9cd['notify_url'] = $spf631e6->getNotifyUrl(); $sp2bd9cd['return_url'] = $spf631e6->getReturnUrl(); $sp2bd9cd['charset'] = $this->postCharset; $sp3b13cb = $spf631e6->getApiParas(); if (method_exists($spf631e6, 'getNeedEncrypt') && $spf631e6->getNeedEncrypt()) { $sp2bd9cd['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp3b13cb['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $sp3c4962 = aliqr_encrypt($sp3b13cb['biz_content'], $this->encryptKey); $sp3b13cb['biz_content'] = $sp3c4962; } $sp3d3d91 = array_merge($sp3b13cb, $sp2bd9cd); $sp849c5e = $this->getSignContent($sp3d3d91); $sp3d3d91['sign'] = $this->generateSign($sp3d3d91, $this->signType); if ('GET' == $spd35087) { $spb23b8c = $this->gatewayUrl . '?' . $sp849c5e . '&sign=' . urlencode($sp3d3d91['sign']); return $spb23b8c; } else { return $this->buildRequestForm($sp3d3d91); } } protected function buildRequestForm($sp95a7be) { $spdf4193 = '<form id=\'alipaysubmit\' name=\'alipaysubmit\' action=\'' . $this->gatewayUrl . '?charset=' . trim($this->postCharset) . '\' method=\'POST\'>'; while (list($spc37b44, $spfca62c) = each($sp95a7be)) { if (false === $this->checkEmpty($spfca62c)) { $spfca62c = str_replace('\'', '&apos;', $spfca62c); $spdf4193 .= '<input type=\'hidden\' name=\'' . $spc37b44 . '\' value=\'' . $spfca62c . '\'/>'; } } $spdf4193 = $spdf4193 . '<input type=\'submit\' value=\'ok\' style=\'display:none;\'\'></form>'; $spdf4193 = $spdf4193 . '<script>document.forms[\'alipaysubmit\'].submit();</script>'; return $spdf4193; } public function execute($spf631e6, $sp1ab79b = null, $spc6644a = null) { $this->setupCharsets($spf631e6); if (strcasecmp($this->fileCharset, $this->postCharset)) { throw new Exception('æ–‡ä»¶ç¼–ç ï¼š[' . $this->fileCharset . '] ä¸Žè¡¨å•æäº¤ç¼–ç ï¼š[' . $this->postCharset . ']ä¸¤è€…ä¸ä¸€è‡´!'); } $sp735c57 = null; if (!$this->checkEmpty($spf631e6->getApiVersion())) { $sp735c57 = $spf631e6->getApiVersion(); } else { $sp735c57 = $this->apiVersion; } $sp2bd9cd['app_id'] = $this->appId; $sp2bd9cd['version'] = $sp735c57; $sp2bd9cd['format'] = $this->format; $sp2bd9cd['sign_type'] = $this->signType; $sp2bd9cd['method'] = $spf631e6->getApiMethodName(); $sp2bd9cd['timestamp'] = date('Y-m-d H:i:s'); $sp2bd9cd['auth_token'] = $sp1ab79b; $sp2bd9cd['alipay_sdk'] = $this->alipaySdkVersion; $sp2bd9cd['terminal_type'] = $spf631e6->getTerminalType(); $sp2bd9cd['terminal_info'] = $spf631e6->getTerminalInfo(); $sp2bd9cd['prod_code'] = $spf631e6->getProdCode(); $sp2bd9cd['notify_url'] = $spf631e6->getNotifyUrl(); $sp2bd9cd['charset'] = $this->postCharset; $sp2bd9cd['app_auth_token'] = $spc6644a; $sp3b13cb = $spf631e6->getApiParas(); if (method_exists($spf631e6, 'getNeedEncrypt') && $spf631e6->getNeedEncrypt()) { $sp2bd9cd['encrypt_type'] = $this->encryptType; if ($this->checkEmpty($sp3b13cb['biz_content'])) { throw new Exception(' api request Fail! The reason : encrypt request is not supperted!'); } if ($this->checkEmpty($this->encryptKey) || $this->checkEmpty($this->encryptType)) { throw new Exception(' encryptType and encryptKey must not null! '); } if ('AES' != $this->encryptType) { throw new Exception('åŠ å¯†ç±»åž‹åªæ”¯æŒAES'); } $sp3c4962 = aliqr_encrypt($sp3b13cb['biz_content'], $this->encryptKey); $sp3b13cb['biz_content'] = $sp3c4962; } $sp2bd9cd['sign'] = $this->generateSign(array_merge($sp3b13cb, $sp2bd9cd), $this->signType); $spb23b8c = $this->gatewayUrl . '?'; foreach ($sp2bd9cd as $spfe7a58 => $sp600c1a) { $spb23b8c .= "{$spfe7a58}=" . urlencode($this->characet($sp600c1a, $this->postCharset)) . '&'; } $spb23b8c = substr($spb23b8c, 0, -1); try { $sp05994e = $this->curl($spb23b8c, $sp3b13cb); } catch (Exception $sp019ea9) { $this->logCommunicationError($sp2bd9cd['method'], $spb23b8c, 'HTTP_ERROR_' . $sp019ea9->getCode(), $sp019ea9->getMessage()); return false; } $sp17bbb1 = false; $spc92065 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp05994e); $sp5aaae3 = null; if ('json' == $this->format) { $sp6729b0 = json_decode($spc92065); if (null !== $sp6729b0) { $sp17bbb1 = true; $sp5aaae3 = $this->parserJSONSignData($spf631e6, $sp05994e, $sp6729b0); } } else { if ('xml' == $this->format) { $sp6729b0 = @simplexml_load_string($sp05994e); if (false !== $sp6729b0) { $sp17bbb1 = true; $sp5aaae3 = $this->parserXMLSignData($spf631e6, $sp05994e); } } } if (false === $sp17bbb1) { $this->logCommunicationError($sp2bd9cd['method'], $spb23b8c, 'HTTP_RESPONSE_NOT_WELL_FORMED', $sp05994e); return false; } $this->checkResponseSign($spf631e6, $sp5aaae3, $sp05994e, $sp6729b0); if (method_exists($spf631e6, 'getNeedEncrypt') && $spf631e6->getNeedEncrypt()) { if ('json' == $this->format) { $sp05994e = $this->encryptJSONSignSource($spf631e6, $sp05994e); $spc92065 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp05994e); $sp6729b0 = json_decode($spc92065); } else { $sp05994e = $this->encryptXMLSignSource($spf631e6, $sp05994e); $spc92065 = iconv($this->postCharset, $this->fileCharset . '//IGNORE', $sp05994e); $sp6729b0 = @simplexml_load_string($spc92065); } } return $sp6729b0; } function characet($spbda5b4, $spb3dfac) { if (!empty($spbda5b4)) { $sp3051d8 = $this->fileCharset; if (strcasecmp($sp3051d8, $spb3dfac) != 0) { $spbda5b4 = mb_convert_encoding($spbda5b4, $spb3dfac, $sp3051d8); } } return $spbda5b4; } public function exec($spc3d8db) { if (!isset($spc3d8db['method'])) { trigger_error('No api name passed'); } $sp4416de = new LtInflector(); $sp4416de->conf['separator'] = '.'; $spab437e = ucfirst($sp4416de->camelize(substr($spc3d8db['method'], 7))) . 'Request'; if (!class_exists($spab437e)) { trigger_error('No such api: ' . $spc3d8db['method']); } $sp41bc65 = isset($spc3d8db['session']) ? $spc3d8db['session'] : null; $sp086f28 = new $spab437e(); foreach ($spc3d8db as $spa4cab5 => $sp82cbc1) { $sp4416de->conf['separator'] = '_'; $sp58187c = $sp4416de->camelize($spa4cab5); $sp4416de->conf['separator'] = '.'; $sp58187c = 'set' . $sp4416de->camelize($sp58187c); if (method_exists($sp086f28, $sp58187c)) { $sp086f28->{$sp58187c}($sp82cbc1); } } return $this->execute($sp086f28, $sp41bc65); } protected function checkEmpty($sp12919e) { if (!isset($sp12919e)) { return true; } if ($sp12919e === null) { return true; } if (trim($sp12919e) === '') { return true; } return false; } public function rsaCheckV1($sp342eea, $spa078b5, $sp6cf5f4 = 'RSA') { $spa0f4ca = $sp342eea['sign']; $sp342eea['sign_type'] = null; $sp342eea['sign'] = null; return $this->verify($this->getSignContent($sp342eea), $spa0f4ca, $spa078b5, $sp6cf5f4); } public function rsaCheckV2($sp342eea, $spa078b5, $sp6cf5f4 = 'RSA') { print_r($sp342eea); $spa0f4ca = $sp342eea['sign']; $sp342eea['sign'] = null; return $this->verify($this->getSignContent($sp342eea), $spa0f4ca, $spa078b5, $sp6cf5f4); } function verify($spbda5b4, $spa0f4ca, $spa078b5, $sp6cf5f4 = 'RSA') { if ($this->checkEmpty($this->alipayPublicKey)) { $sp52536e = $this->alipayrsaPublicKey; $sp868884 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($sp52536e, 64, '
', true) . '
-----END PUBLIC KEY-----'; } else { $sp52536e = file_get_contents($spa078b5); $sp868884 = openssl_get_publickey($sp52536e); } $sp868884 or die('æ”¯ä»˜å®RSAå…¬é’¥é”™è¯¯ã€‚è¯·æ£€æŸ¥å…¬é’¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®'); if ('RSA2' == $sp6cf5f4) { $spe62cd8 = (bool) openssl_verify($spbda5b4, base64_decode($spa0f4ca), $sp868884, OPENSSL_ALGO_SHA256); } else { $spe62cd8 = (bool) openssl_verify($spbda5b4, base64_decode($spa0f4ca), $sp868884); } if (!$this->checkEmpty($this->alipayPublicKey)) { openssl_free_key($sp868884); } return $spe62cd8; } public function checkSignAndDecrypt($sp342eea, $spef56eb, $spbe6b90, $spf47790, $spbb4cc5) { $sp9046a3 = $sp342eea['charset']; $sp9c786b = $sp342eea['biz_content']; if ($spf47790) { if (!$this->rsaCheckV2($sp342eea, $spef56eb)) { echo '<br/>checkSign failure<br/>'; die; } } if ($spbb4cc5) { return $this->rsaDecrypt($sp9c786b, $spbe6b90, $sp9046a3); } return $sp9c786b; } public function encryptAndSign($sp9c786b, $spef56eb, $spbe6b90, $sp9046a3, $sp8b2ee2, $sp4a6d31) { if ($sp8b2ee2 && $sp4a6d31) { $spd3e2a7 = $this->rsaEncrypt($sp9c786b, $spef56eb, $sp9046a3); $spa0f4ca = $this->sign($sp9c786b); $spd6e0e5 = "<?xml version=\"1.0\" encoding=\"{$sp9046a3}\"?><alipay><response>{$spd3e2a7}</response><encryption_type>RSA</encryption_type><sign>{$spa0f4ca}</sign><sign_type>RSA</sign_type></alipay>"; return $spd6e0e5; } if ($sp8b2ee2 && !$sp4a6d31) { $spd3e2a7 = $this->rsaEncrypt($sp9c786b, $spef56eb, $sp9046a3); $spd6e0e5 = "<?xml version=\"1.0\" encoding=\"{$sp9046a3}\"?><alipay><response>{$spd3e2a7}</response><encryption_type>RSA</encryption_type></alipay>"; return $spd6e0e5; } if (!$sp8b2ee2 && $sp4a6d31) { $spa0f4ca = $this->sign($sp9c786b); $spd6e0e5 = "<?xml version=\"1.0\" encoding=\"{$sp9046a3}\"?><alipay><response>{$sp9c786b}</response><sign>{$spa0f4ca}</sign><sign_type>RSA</sign_type></alipay>"; return $spd6e0e5; } $spd6e0e5 = "<?xml version=\"1.0\" encoding=\"{$sp9046a3}\"?>{$sp9c786b}"; return $spd6e0e5; } public function rsaEncrypt($spbda5b4, $spef56eb, $sp9046a3) { $sp52536e = file_get_contents($spef56eb); $sp868884 = openssl_get_publickey($sp52536e); $spb02f2d = $this->splitCN($spbda5b4, 0, 30, $sp9046a3); $spaeffb2 = null; $spfd7393 = array(); foreach ($spb02f2d as $spff06dc => $spdb06cb) { if (!openssl_public_encrypt($spdb06cb, $spaeffb2, $sp868884)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $sp220a8c[] = $spaeffb2; } $sp287f33 = implode(',', $sp220a8c); return $sp287f33; } public function rsaDecrypt($spbda5b4, $spbe6b90, $sp9046a3) { $sp4e391a = file_get_contents($spbe6b90); $sp868884 = openssl_get_privatekey($sp4e391a); $speb2f63 = explode(',', $spbda5b4); $spd22626 = ''; $sp6cff03 = ''; foreach ($speb2f63 as $spff06dc => $sp80a69b) { if (!openssl_private_decrypt($sp80a69b, $sp6cff03, $sp868884)) { echo '<br/>' . openssl_error_string() . '<br/>'; } $spd22626 .= $sp6cff03; } return $spd22626; } function splitCN($sp6c1d02, $spff06dc = 0, $spbd5049, $sp9046a3) { $sp88f88a = array(); for ($sp218d20 = $spff06dc; $sp218d20 < strlen($sp6c1d02); $sp218d20 += $spbd5049) { $sp868884 = $this->subCNchar($sp6c1d02, $sp218d20, $spbd5049, $sp9046a3); if (!empty($sp868884)) { $sp88f88a[] = $sp868884; } } return $sp88f88a; } function subCNchar($sp4e169a, $sp0d27f4 = 0, $sp047f5a, $sp9046a3 = 'gbk') { if (strlen($sp4e169a) <= $sp047f5a) { return $sp4e169a; } $spe47fd2['utf-8'] = '/[-]|[Â-ß][€-¿]|[à-ï][€-¿]{2}|[ð-ÿ][€-¿]{3}/'; $spe47fd2['gb2312'] = '/[-]|[°-÷][ -þ]/'; $spe47fd2['gbk'] = '/[-]|[-þ][@-þ]/'; $spe47fd2['big5'] = '/[-]|[-þ]([@-~]|¡-þ])/'; preg_match_all($spe47fd2[$sp9046a3], $sp4e169a, $sp7dc386); $sp04bccb = join('', array_slice($sp7dc386[0], $sp0d27f4, $sp047f5a)); return $sp04bccb; } function parserResponseSubCode($spf631e6, $sp20c3c4, $sp6729b0, $sp667761) { if ('json' == $sp667761) { $sp2ee2b2 = $spf631e6->getApiMethodName(); $spe47652 = str_replace('.', '_', $sp2ee2b2) . $this->RESPONSE_SUFFIX; $sp2f40de = $this->ERROR_RESPONSE; $sp2eca8b = strpos($sp20c3c4, $spe47652); $sp9182c5 = strpos($sp20c3c4, $sp2f40de); if ($sp2eca8b > 0) { $sp3734f1 = $sp6729b0->{$spe47652}; } elseif ($sp9182c5 > 0) { $sp3734f1 = $sp6729b0->{$sp2f40de}; } else { return null; } if (isset($sp3734f1->sub_code)) { return $sp3734f1->sub_code; } else { return null; } } elseif ('xml' == $sp667761) { return $sp6729b0->sub_code; } } function parserJSONSignData($spf631e6, $sp20c3c4, $sp883d1f) { $sp5aaae3 = new SignData(); $sp5aaae3->sign = $this->parserJSONSign($sp883d1f); $sp5aaae3->signSourceData = $this->parserJSONSignSource($spf631e6, $sp20c3c4); return $sp5aaae3; } function parserJSONSignSource($spf631e6, $sp20c3c4) { $sp2ee2b2 = $spf631e6->getApiMethodName(); $spe47652 = str_replace('.', '_', $sp2ee2b2) . $this->RESPONSE_SUFFIX; $sp2eca8b = strpos($sp20c3c4, $spe47652); $sp9182c5 = strpos($sp20c3c4, $this->ERROR_RESPONSE); if ($sp2eca8b > 0) { return $this->parserJSONSource($sp20c3c4, $spe47652, $sp2eca8b); } else { if ($sp9182c5 > 0) { return $this->parserJSONSource($sp20c3c4, $this->ERROR_RESPONSE, $sp9182c5); } else { return null; } } } function parserJSONSource($sp20c3c4, $sp4040ad, $spf672b1) { $sp932684 = $spf672b1 + strlen($sp4040ad) + 2; $sp7c0f70 = strpos($sp20c3c4, '"' . $this->SIGN_NODE_NAME . '"'); $spe8e00c = $sp7c0f70 - 1; $spc1a525 = $spe8e00c - $sp932684; if ($spc1a525 < 0) { return null; } return substr($sp20c3c4, $sp932684, $spc1a525); } function parserJSONSign($sp153d4c) { return $sp153d4c->sign; } function parserXMLSignData($spf631e6, $sp20c3c4) { $sp5aaae3 = new SignData(); $sp5aaae3->sign = $this->parserXMLSign($sp20c3c4); $sp5aaae3->signSourceData = $this->parserXMLSignSource($spf631e6, $sp20c3c4); return $sp5aaae3; } function parserXMLSignSource($spf631e6, $sp20c3c4) { $sp2ee2b2 = $spf631e6->getApiMethodName(); $spe47652 = str_replace('.', '_', $sp2ee2b2) . $this->RESPONSE_SUFFIX; $sp2eca8b = strpos($sp20c3c4, $spe47652); $sp9182c5 = strpos($sp20c3c4, $this->ERROR_RESPONSE); if ($sp2eca8b > 0) { return $this->parserXMLSource($sp20c3c4, $spe47652, $sp2eca8b); } else { if ($sp9182c5 > 0) { return $this->parserXMLSource($sp20c3c4, $this->ERROR_RESPONSE, $sp9182c5); } else { return null; } } } function parserXMLSource($sp20c3c4, $sp4040ad, $spf672b1) { $sp932684 = $spf672b1 + strlen($sp4040ad) + 1; $sp7c0f70 = strpos($sp20c3c4, '<' . $this->SIGN_NODE_NAME . '>'); $spe8e00c = $sp7c0f70 - 1; $spc1a525 = $spe8e00c - $sp932684 + 1; if ($spc1a525 < 0) { return null; } return substr($sp20c3c4, $sp932684, $spc1a525); } function parserXMLSign($sp20c3c4) { $sp551790 = '<' . $this->SIGN_NODE_NAME . '>'; $sp596f13 = '</' . $this->SIGN_NODE_NAME . '>'; $spd77378 = strpos($sp20c3c4, $sp551790); $spe8bbd6 = strpos($sp20c3c4, $sp596f13); if ($spd77378 < 0 || $spe8bbd6 < 0) { return null; } $spf672b1 = $spd77378 + strlen($sp551790); $spc1a525 = $spe8bbd6 - $spf672b1; if ($spc1a525 < 0) { return null; } return substr($sp20c3c4, $spf672b1, $spc1a525); } public function checkResponseSign($spf631e6, $sp5aaae3, $sp05994e, $sp6729b0) { if (!$this->checkEmpty($this->alipayPublicKey) || !$this->checkEmpty($this->alipayrsaPublicKey)) { if ($sp5aaae3 == null || $this->checkEmpty($sp5aaae3->sign) || $this->checkEmpty($sp5aaae3->signSourceData)) { throw new Exception(' check sign Fail! The reason : signData is Empty'); } $sp289f16 = $this->parserResponseSubCode($spf631e6, $sp05994e, $sp6729b0, $this->format); if (!$this->checkEmpty($sp289f16) || $this->checkEmpty($sp289f16) && !$this->checkEmpty($sp5aaae3->sign)) { $spc6c00d = $this->verify($sp5aaae3->signSourceData, $sp5aaae3->sign, $this->alipayPublicKey, $this->signType); if (!$spc6c00d) { if (strpos($sp5aaae3->signSourceData, '\\/') > 0) { $sp5aaae3->signSourceData = str_replace('\\/', '/', $sp5aaae3->signSourceData); $spc6c00d = $this->verify($sp5aaae3->signSourceData, $sp5aaae3->sign, $this->alipayPublicKey, $this->signType); if (!$spc6c00d) { throw new Exception('check sign Fail! [sign=' . $sp5aaae3->sign . ', signSourceData=' . $sp5aaae3->signSourceData . ']'); } } else { throw new Exception('check sign Fail! [sign=' . $sp5aaae3->sign . ', signSourceData=' . $sp5aaae3->signSourceData . ']'); } } } } } private function setupCharsets($spf631e6) { if ($this->checkEmpty($this->postCharset)) { $this->postCharset = 'UTF-8'; } $sp4e169a = preg_match('/[\\x80-\\xff]/', $this->appId) ? $this->appId : print_r($spf631e6, true); $this->fileCharset = mb_detect_encoding($sp4e169a, 'UTF-8, GBK') == 'UTF-8' ? 'UTF-8' : 'GBK'; } private function encryptJSONSignSource($spf631e6, $sp20c3c4) { $sp58fdad = $this->parserEncryptJSONSignSource($spf631e6, $sp20c3c4); $spa98eba = substr($sp20c3c4, 0, $sp58fdad->startIndex); $sp8fe6e7 = substr($sp20c3c4, $sp58fdad->endIndex, strlen($sp20c3c4) + 1 - $sp58fdad->endIndex); $sp9c786b = aliqr_decrypt($sp58fdad->encryptContent, $this->encryptKey); return $spa98eba . $sp9c786b . $sp8fe6e7; } private function parserEncryptJSONSignSource($spf631e6, $sp20c3c4) { $sp2ee2b2 = $spf631e6->getApiMethodName(); $spe47652 = str_replace('.', '_', $sp2ee2b2) . $this->RESPONSE_SUFFIX; $sp2eca8b = strpos($sp20c3c4, $spe47652); $sp9182c5 = strpos($sp20c3c4, $this->ERROR_RESPONSE); if ($sp2eca8b > 0) { return $this->parserEncryptJSONItem($sp20c3c4, $spe47652, $sp2eca8b); } else { if ($sp9182c5 > 0) { return $this->parserEncryptJSONItem($sp20c3c4, $this->ERROR_RESPONSE, $sp9182c5); } else { return null; } } } private function parserEncryptJSONItem($sp20c3c4, $sp4040ad, $spf672b1) { $sp932684 = $spf672b1 + strlen($sp4040ad) + 2; $sp7c0f70 = strpos($sp20c3c4, '"' . $this->SIGN_NODE_NAME . '"'); $spe8e00c = $sp7c0f70 - 1; if ($spe8e00c < 0) { $spe8e00c = strlen($sp20c3c4) - 1; } $spc1a525 = $spe8e00c - $sp932684; $spe30e2d = substr($sp20c3c4, $sp932684 + 1, $spc1a525 - 2); $sp4dfbc9 = new EncryptParseItem(); $sp4dfbc9->encryptContent = $spe30e2d; $sp4dfbc9->startIndex = $sp932684; $sp4dfbc9->endIndex = $spe8e00c; return $sp4dfbc9; } private function encryptXMLSignSource($spf631e6, $sp20c3c4) { $sp58fdad = $this->parserEncryptXMLSignSource($spf631e6, $sp20c3c4); $spa98eba = substr($sp20c3c4, 0, $sp58fdad->startIndex); $sp8fe6e7 = substr($sp20c3c4, $sp58fdad->endIndex, strlen($sp20c3c4) + 1 - $sp58fdad->endIndex); $sp9c786b = aliqr_decrypt($sp58fdad->encryptContent, $this->encryptKey); return $spa98eba . $sp9c786b . $sp8fe6e7; } private function parserEncryptXMLSignSource($spf631e6, $sp20c3c4) { $sp2ee2b2 = $spf631e6->getApiMethodName(); $spe47652 = str_replace('.', '_', $sp2ee2b2) . $this->RESPONSE_SUFFIX; $sp2eca8b = strpos($sp20c3c4, $spe47652); $sp9182c5 = strpos($sp20c3c4, $this->ERROR_RESPONSE); if ($sp2eca8b > 0) { return $this->parserEncryptXMLItem($sp20c3c4, $spe47652, $sp2eca8b); } else { if ($sp9182c5 > 0) { return $this->parserEncryptXMLItem($sp20c3c4, $this->ERROR_RESPONSE, $sp9182c5); } else { return null; } } } private function parserEncryptXMLItem($sp20c3c4, $sp4040ad, $spf672b1) { $sp932684 = $spf672b1 + strlen($sp4040ad) + 1; $sp5dd502 = '<' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp94c065 = '</' . $this->ENCRYPT_XML_NODE_NAME . '>'; $sp0dde8b = strpos($sp20c3c4, $sp94c065); if ($sp0dde8b < 0) { $spe1403c = new EncryptParseItem(); $spe1403c->encryptContent = null; $spe1403c->startIndex = 0; $spe1403c->endIndex = 0; return $spe1403c; } $spdfa609 = $sp932684 + strlen($sp5dd502); $sp1bc8b0 = $sp0dde8b - $spdfa609; $sp9c786b = substr($sp20c3c4, $spdfa609, $sp1bc8b0); $sp4dfbc9 = new EncryptParseItem(); $sp4dfbc9->encryptContent = $sp9c786b; $sp4dfbc9->startIndex = $sp932684; $sp4dfbc9->endIndex = $sp0dde8b + strlen($sp94c065); return $sp4dfbc9; } function echoDebug($sp3e892f) { if ($this->debugInfo) { echo '<br/>' . $sp3e892f; } } }
<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } private function getAccessToken($spc27de0) { $sp4706af = $spc27de0['client_id']; $spf13c9a = $spc27de0['client_secret']; $sp5962e1 = array('kdt_id' => $spc27de0['kdt_id']); $spb34b01 = (new Open\Token($sp4706af, $spf13c9a))->getToken('self', $sp5962e1); if (!isset($spb34b01['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($spb34b01)); throw new \Exception('平台支付Token获取失败'); } return $spb34b01['access_token']; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $spef6530 = strtolower($spc27de0['payway']); try { $spa9766a = $this->getAccessToken($spc27de0); $sp352925 = new Open\Client($spa9766a); } catch (\Exception $spece20f) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $spece20f)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp3e77f9 = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp6956b3, 'qr_name' => $sp9f49de, 'qr_source' => $spba04f6); $spb34b01 = $sp352925->get('youzan.pay.qrcode.create', '3.0.0', $sp3e77f9); $spb34b01 = isset($spb34b01['response']) ? $spb34b01['response'] : $spb34b01; if (!isset($spb34b01['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($spb34b01)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($spba04f6)->update(array('pay_trade_no' => $spb34b01['qr_id'])); header('location: /qrcode/pay/' . $spba04f6 . '/youzan_' . strtolower($spef6530) . '?url=' . urlencode($spb34b01['qr_url'])); die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; $sp4706af = $spc27de0['client_id']; $spf13c9a = $spc27de0['client_secret']; if ($spb2acff) { $spdaab2e = file_get_contents('php://input'); $spcb019a = json_decode($spdaab2e, true); if (@$spcb019a['test']) { echo 'test success'; return false; } try { $sp2af324 = $spcb019a['msg']; } catch (\Exception $spece20f) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $spece20f, 'post_raw' => $spdaab2e)); echo 'fatal error'; return false; } $sp71f612 = $sp4706af . '' . $sp2af324 . '' . $spf13c9a; $sp75e4cc = md5($sp71f612); if ($sp75e4cc != $spcb019a['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $sp71f612 . ', $sign' . $sp75e4cc); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $sp2af324 = json_decode(urldecode($sp2af324), true); if ($spcb019a['type'] === 'TRADE_ORDER_STATE' && $sp2af324['status'] === 'TRADE_SUCCESS') { try { $spa9766a = $this->getAccessToken($spc27de0); $sp352925 = new Open\Client($spa9766a); } catch (\Exception $spece20f) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $spece20f)); echo 'fatal error'; return false; } $sp3e77f9 = array('tid' => $sp2af324['tid']); $spb34b01 = $sp352925->get('youzan.trade.get', '3.0.0', $sp3e77f9); if (isset($spb34b01['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $spb34b01['error_response']['msg']); echo 'fatal error'; return false; } $sp8c399a = $spb34b01['response']['trade']; $sp7dcca7 = \App\Order::where('pay_trade_no', $sp8c399a['qr_id'])->first(); if ($sp7dcca7) { $spefaf7d = $sp2af324['tid']; $sp4294a3($sp7dcca7->order_no, (int) round($sp8c399a['payment'] * 100), $spefaf7d); } } return true; } else { $spba04f6 = @$spc27de0['out_trade_no']; if (strlen($spba04f6) < 5) { throw new \Exception('交易单号未传入'); } $sp7dcca7 = \App\Order::whereOrderNo($spba04f6)->firstOrFail(); if (!$sp7dcca7->pay_trade_no || !strlen($sp7dcca7->pay_trade_no)) { return false; } try { $spa9766a = $this->getAccessToken($spc27de0); $sp352925 = new Open\Client($spa9766a); } catch (\Exception $spece20f) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $spece20f)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp3e77f9 = array('qr_id' => $sp7dcca7->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $spb34b01 = $sp352925->get('youzan.trades.qr.get', '3.0.0', $sp3e77f9); $sp5631a3 = isset($spb34b01['response']) ? $spb34b01['response'] : $spb34b01; if (!isset($sp5631a3['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $spb34b01)); return false; } if ($sp5631a3['total_results'] > 0 && count($sp5631a3['qr_trades']) > 0 && isset($sp5631a3['qr_trades'][0]['qr_id']) && $sp5631a3['qr_trades'][0]['qr_id'] === $sp7dcca7->pay_trade_no) { $sp475728 = $sp5631a3['qr_trades'][0]; $spefaf7d = $sp475728['tid']; $sp4294a3($spba04f6, (int) round($sp475728['real_price'] * 100), $spefaf7d); return true; } else { return false; } } } }
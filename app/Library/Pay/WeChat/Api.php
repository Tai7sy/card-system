<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { $sp429fcc = $sp5213ee; $spdc9a36 = strtoupper($spbe80b7['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $spdc9a36 = 'JSAPI'; $spa8234d = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $spa3e681; $sp136fa6 = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $spbe80b7['APPID'] . '&redirect_uri=' . urlencode($spa8234d) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $sp136fa6); die; } $sp8e5de6 = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $spbe80b7['APPID'] . '&secret=' . $spbe80b7['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $spb9589c = @json_decode(CurlRequest::get($sp8e5de6), true); if (!is_array($spb9589c) || empty($spb9589c['openid'])) { if (isset($spb9589c['errcode']) && $spb9589c['errcode'] === 40163) { header('Location: ' . $sp136fa6); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($spb9589c['errcode']) ? $spb9589c['errcode'] : $spb9589c) . '<br>' . (isset($spb9589c['errmsg']) ? $spb9589c['errmsg'] : $spb9589c) . '<br>请返回重试</h1>'); } $sp0b37ee = $spb9589c['openid']; } else { if ($spdc9a36 === 'JSAPI') { $spa8234d = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $spa3e681; header('Location: /qrcode/pay/' . $spa3e681 . '/wechat?url=' . urlencode($spa8234d)); die; } } $this->defineWxConfig($spbe80b7); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'WxLog.php'; $sp80ce90 = new \NativePay(); $sp134454 = new \WxPayUnifiedOrder(); $sp134454->SetBody($sp45f07e); $sp134454->SetAttach($spa3e681); $sp134454->SetOut_trade_no($spa3e681); $sp134454->SetTotal_fee($sp429fcc); $sp134454->SetTime_start(date('YmdHis')); $sp134454->SetTime_expire(date('YmdHis', time() + 600)); $sp134454->SetGoods_tag('pay'); $sp134454->SetTrade_type($spdc9a36); if ($spdc9a36 === 'MWEB') { $sp134454->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($spdc9a36 === 'JSAPI') { $sp134454->SetOpenid($sp0b37ee); } $sp134454->SetProduct_id($spa3e681); $sp134454->SetSpbill_create_ip(Helper::getIP()); $sp134454->SetNotify_url($this->url_notify); $spbbda25 = $sp80ce90->unifiedOrder($sp134454); function getValue($spa3e681, $spbbda25, $sp1ed429) { if (!isset($spbbda25[$sp1ed429])) { Log::error('Pay.WeChat.goPay, order_no:' . $spa3e681 . ', error:' . json_encode($spbbda25)); if (isset($spbbda25['err_code_des'])) { throw new \Exception($spbbda25['err_code_des']); } if (isset($spbbda25['return_msg'])) { throw new \Exception($spbbda25['return_msg']); } throw new \Exception('获取支付数据失败'); } return $spbbda25[$sp1ed429]; } if ($spdc9a36 === 'NATIVE') { $sp3db1b2 = getValue($spa3e681, $spbbda25, 'code_url'); header('Location: /qrcode/pay/' . $spa3e681 . '/wechat?url=' . urlencode($sp3db1b2)); } elseif ($spdc9a36 === 'JSAPI') { $spa26894 = array('appId' => $spbe80b7['APPID'], 'timeStamp' => strval(time()), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($spa3e681, $spbbda25, 'prepay_id'), 'signType' => 'MD5'); $sp5aa598 = new \WxPayJsApiPay(); $sp5aa598->FromArray($spa26894); $spa26894['paySign'] = $sp5aa598->MakeSign(); header('Location: /qrcode/pay/' . $spa3e681 . '/wechat?url=' . urlencode(json_encode($spa26894))); } elseif ($spdc9a36 === 'MWEB') { $sp3db1b2 = getValue($spa3e681, $spbbda25, 'mweb_url'); $sp978358 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $spa3e681 . '/wechat?url=query'; echo view('utils.redirect', array('url' => $sp3db1b2 . '&redirect_url=' . urlencode($sp978358))); } die; } private function defineWxConfig($spbe80b7) { if (!defined('wx_APPID')) { define('wx_APPID', $spbe80b7['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $spbe80b7['MCHID']); } if (!defined('wx_SUBAPPID')) { define('wx_SUBAPPID', @$spbe80b7['sub_appid']); } if (!defined('wx_SUBMCHID')) { define('wx_SUBMCHID', @$spbe80b7['sub_mch_id']); } if (!defined('wx_KEY')) { define('wx_KEY', $spbe80b7['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $spbe80b7['APPSECRET']); } } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; $this->defineWxConfig($spbe80b7); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxLog.php'; if ($sp3bce01) { return (new PayNotifyCallBack($sp04f0f8))->Handle(false); } else { $spa3e681 = @$spbe80b7['out_trade_no']; $sp134454 = new \WxPayOrderQuery(); $sp134454->SetOut_trade_no($spa3e681); if (isset($spbe80b7['sub_mch_id'])) { $sp134454->SetSub_mch_id($spa3e681); } try { $spbbda25 = \WxPayApi::orderQuery($sp134454); if (array_key_exists('trade_state', $spbbda25) && $spbbda25['trade_state'] == 'SUCCESS') { call_user_func_array($sp04f0f8, array($spbbda25['out_trade_no'], $spbbda25['total_fee'], $spbbda25['transaction_id'])); return true; } else { Log::debug('Pay.WeChat.verify, orderQuery failed. ' . json_encode($spbbda25)); return false; } } catch (\Throwable $sp81eee8) { Log::error('Pay.WeChat.verify, orderQuery exception:. ' . $sp81eee8->getMessage(), array('exception' => $sp81eee8)); return false; } } } }
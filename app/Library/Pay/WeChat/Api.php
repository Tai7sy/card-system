<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { $sp9b2bb6 = $sp6956b3; $spd53b1c = strtoupper($spc27de0['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $spd53b1c = 'JSAPI'; $sp6cc11c = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $spba04f6; $spbb3f80 = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $spc27de0['APPID'] . '&redirect_uri=' . urlencode($sp6cc11c) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $spbb3f80); die; } $sp064fed = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $spc27de0['APPID'] . '&secret=' . $spc27de0['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp29a775 = @json_decode(CurlRequest::get($sp064fed), true); if (!$sp29a775 || !isset($sp29a775['openid'])) { if (isset($sp29a775['errcode']) && $sp29a775['errcode'] === 40163) { header('Location: ' . $spbb3f80); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp29a775['errcode']) ? $sp29a775['errcode'] : $sp29a775) . '<br>' . (isset($sp29a775['errmsg']) ? $sp29a775['errmsg'] : $sp29a775) . '<br>请返回重试</h1>'); } $sp2a473b = $sp29a775['openid']; } else { if ($spd53b1c === 'JSAPI') { $sp6cc11c = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $spba04f6; header('Location: /qrcode/pay/' . $spba04f6 . '/wechat?url=' . urlencode($sp6cc11c)); die; } } $this->defineWxConfig($spc27de0); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'WxLog.php'; $sp3da441 = new \NativePay(); $spd72f9e = new \WxPayUnifiedOrder(); $spd72f9e->SetBody($sp9f49de); $spd72f9e->SetAttach($spba04f6); $spd72f9e->SetOut_trade_no($spba04f6); $spd72f9e->SetTotal_fee($sp9b2bb6); $spd72f9e->SetTime_start(date('YmdHis')); $spd72f9e->SetTime_expire(date('YmdHis', time() + 600)); $spd72f9e->SetGoods_tag('pay'); $spd72f9e->SetTrade_type($spd53b1c); if ($spd53b1c === 'MWEB') { $spd72f9e->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($spd53b1c === 'JSAPI') { $spd72f9e->SetOpenid($sp2a473b); } $spd72f9e->SetProduct_id($spba04f6); $spd72f9e->SetSpbill_create_ip(Helper::getIP()); $spd72f9e->SetNotify_url($this->url_notify); $spb34b01 = $sp3da441->unifiedOrder($spd72f9e); function getValue($spba04f6, $spb34b01, $sp7b7024) { if (!isset($spb34b01[$sp7b7024])) { Log::error('Pay.WeChat.goPay, order_no:' . $spba04f6 . ', error:' . json_encode($spb34b01)); if (isset($spb34b01['err_code_des'])) { throw new \Exception($spb34b01['err_code_des']); } if (isset($spb34b01['return_msg'])) { throw new \Exception($spb34b01['return_msg']); } throw new \Exception('获取支付数据失败'); } return $spb34b01[$sp7b7024]; } if ($spd53b1c === 'NATIVE') { $sp3ae187 = getValue($spba04f6, $spb34b01, 'code_url'); header('Location: /qrcode/pay/' . $spba04f6 . '/wechat?url=' . urlencode($sp3ae187)); } elseif ($spd53b1c === 'JSAPI') { $sp3e77f9 = array('appId' => $spc27de0['APPID'], 'timeStamp' => strval(time()), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($spba04f6, $spb34b01, 'prepay_id'), 'signType' => 'MD5'); $spcb019a = new \WxPayJsApiPay(); $spcb019a->FromArray($sp3e77f9); $sp3e77f9['paySign'] = $spcb019a->MakeSign(); header('Location: /qrcode/pay/' . $spba04f6 . '/wechat?url=' . urlencode(json_encode($sp3e77f9))); } elseif ($spd53b1c === 'MWEB') { $sp3ae187 = getValue($spba04f6, $spb34b01, 'mweb_url'); $spcc8d68 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $spba04f6 . '/wechat?url=query'; echo view('utils.redirect', array('url' => $sp3ae187 . '&redirect_url=' . urlencode($spcc8d68))); } die; } private function defineWxConfig($spc27de0) { if (!defined('wx_APPID')) { define('wx_APPID', $spc27de0['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $spc27de0['MCHID']); } if (!defined('wx_SUBAPPID')) { define('wx_SUBAPPID', @$spc27de0['sub_appid']); } if (!defined('wx_SUBMCHID')) { define('wx_SUBMCHID', @$spc27de0['sub_mch_id']); } if (!defined('wx_KEY')) { define('wx_KEY', $spc27de0['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $spc27de0['APPSECRET']); } } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; $this->defineWxConfig($spc27de0); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxLog.php'; if ($spb2acff) { return (new PayNotifyCallBack($sp4294a3))->Handle(false); } else { $spba04f6 = @$spc27de0['out_trade_no']; $spd72f9e = new \WxPayOrderQuery(); $spd72f9e->SetOut_trade_no($spba04f6); if (isset($spc27de0['sub_mch_id'])) { $spd72f9e->SetSub_mch_id($spba04f6); } try { $spb34b01 = \WxPayApi::orderQuery($spd72f9e); if (array_key_exists('trade_state', $spb34b01) && $spb34b01['trade_state'] == 'SUCCESS') { call_user_func_array($sp4294a3, array($spb34b01['out_trade_no'], $spb34b01['total_fee'], $spb34b01['transaction_id'])); return true; } else { Log::debug('Pay.WeChat.verify, orderQuery failed. ' . json_encode($spb34b01)); return false; } } catch (\Throwable $spece20f) { Log::error('Pay.WeChat.verify, orderQuery exception:. ' . $spece20f->getMessage(), array('exception' => $spece20f)); return false; } } } }
<?php
namespace App\Library\Pay\WeChat; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { $spf59c91 = $sp076ec7; $spf9ca0c = strtoupper($sp9d4382['payway']); if (strpos(@$_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) { $spf9ca0c = 'JSAPI'; $spaa5fe3 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp2e47fc; $sp9faa2b = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' . $sp9d4382['APPID'] . '&redirect_uri=' . urlencode($spaa5fe3) . '&response_type=code&scope=snsapi_base#wechat_redirect'; if (!isset($_GET['code'])) { header('Location: ' . $sp9faa2b); die; } $sp653463 = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=' . $sp9d4382['APPID'] . '&secret=' . $sp9d4382['APPSECRET'] . '&code=' . $_GET['code'] . '&grant_type=authorization_code'; $sp9b52fe = @json_decode(CurlRequest::get($sp653463), true); if (!is_array($sp9b52fe) || empty($sp9b52fe['openid'])) { if (isset($sp9b52fe['errcode']) && $sp9b52fe['errcode'] === 40163) { header('Location: ' . $sp9faa2b); die; } die('<h1>获取微信OPENID<br>错误信息: ' . (isset($sp9b52fe['errcode']) ? $sp9b52fe['errcode'] : $sp9b52fe) . '<br>' . (isset($sp9b52fe['errmsg']) ? $sp9b52fe['errmsg'] : $sp9b52fe) . '<br>请返回重试</h1>'); } $sp549d4c = $sp9b52fe['openid']; } else { if ($spf9ca0c === 'JSAPI') { $spaa5fe3 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/pay/' . $sp2e47fc; header('Location: /qrcode/pay/' . $sp2e47fc . '/wechat?url=' . urlencode($spaa5fe3)); die; } } $this->defineWxConfig($sp9d4382); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxPay.NativePay.php'; require_once 'WxLog.php'; $sp10223c = new \NativePay(); $spfaaf1d = new \WxPayUnifiedOrder(); $spfaaf1d->SetBody($spd4e90d); $spfaaf1d->SetAttach($sp2e47fc); $spfaaf1d->SetOut_trade_no($sp2e47fc); $spfaaf1d->SetTotal_fee($spf59c91); $spfaaf1d->SetTime_start(date('YmdHis')); $spfaaf1d->SetTime_expire(date('YmdHis', time() + 600)); $spfaaf1d->SetGoods_tag('pay'); $spfaaf1d->SetTrade_type($spf9ca0c); if ($spf9ca0c === 'MWEB') { $spfaaf1d->SetScene_info('{"h5_info": {"type":"Wap","wap_url": "' . SYS_URL . '","wap_name": "发卡平台"}}'); } if ($spf9ca0c === 'JSAPI') { $spfaaf1d->SetOpenid($sp549d4c); } $spfaaf1d->SetProduct_id($sp2e47fc); $spfaaf1d->SetSpbill_create_ip(Helper::getIP()); $spfaaf1d->SetNotify_url($this->url_notify); $spb72f32 = $sp10223c->unifiedOrder($spfaaf1d); function getValue($sp2e47fc, $spb72f32, $spf1241f) { if (!isset($spb72f32[$spf1241f])) { Log::error('Pay.WeChat.goPay, order_no:' . $sp2e47fc . ', error:' . json_encode($spb72f32)); if (isset($spb72f32['err_code_des'])) { throw new \Exception($spb72f32['err_code_des']); } if (isset($spb72f32['return_msg'])) { throw new \Exception($spb72f32['return_msg']); } throw new \Exception('获取支付数据失败'); } return $spb72f32[$spf1241f]; } if ($spf9ca0c === 'NATIVE') { $spd2457c = getValue($sp2e47fc, $spb72f32, 'code_url'); header('Location: /qrcode/pay/' . $sp2e47fc . '/wechat?url=' . urlencode($spd2457c)); } elseif ($spf9ca0c === 'JSAPI') { $spc0e525 = array('appId' => $sp9d4382['APPID'], 'timeStamp' => strval(time()), 'nonceStr' => md5(time() . 'nonceStr'), 'package' => 'prepay_id=' . getValue($sp2e47fc, $spb72f32, 'prepay_id'), 'signType' => 'MD5'); $sp6fd648 = new \WxPayJsApiPay(); $sp6fd648->FromArray($spc0e525); $spc0e525['paySign'] = $sp6fd648->MakeSign(); header('Location: /qrcode/pay/' . $sp2e47fc . '/wechat?url=' . urlencode(json_encode($spc0e525))); } elseif ($spf9ca0c === 'MWEB') { $spd2457c = getValue($sp2e47fc, $spb72f32, 'mweb_url'); $sp499c52 = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') . "://{$_SERVER['HTTP_HOST']}" . '/qrcode/pay/' . $sp2e47fc . '/wechat?url=query'; echo view('utils.redirect', array('url' => $spd2457c . '&redirect_url=' . urlencode($sp499c52))); } die; } private function defineWxConfig($sp9d4382) { if (!defined('wx_APPID')) { define('wx_APPID', $sp9d4382['APPID']); } if (!defined('wx_MCHID')) { define('wx_MCHID', $sp9d4382['MCHID']); } if (!defined('wx_SUBAPPID')) { define('wx_SUBAPPID', @$sp9d4382['sub_appid']); } if (!defined('wx_SUBMCHID')) { define('wx_SUBMCHID', @$sp9d4382['sub_mch_id']); } if (!defined('wx_KEY')) { define('wx_KEY', $sp9d4382['KEY']); } if (!defined('wx_APPSECRET')) { define('wx_APPSECRET', $sp9d4382['APPSECRET']); } } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; $this->defineWxConfig($sp9d4382); require_once __DIR__ . '/lib/WxPay.Api.php'; require_once 'WxLog.php'; if ($sp7b2182) { return (new PayNotifyCallBack($sp9a4d97))->Handle(false); } else { $sp2e47fc = @$sp9d4382['out_trade_no']; $spfaaf1d = new \WxPayOrderQuery(); $spfaaf1d->SetOut_trade_no($sp2e47fc); if (isset($sp9d4382['sub_mch_id'])) { $spfaaf1d->SetSub_mch_id($sp2e47fc); } try { $spb72f32 = \WxPayApi::orderQuery($spfaaf1d); if (array_key_exists('trade_state', $spb72f32) && $spb72f32['trade_state'] == 'SUCCESS') { call_user_func_array($sp9a4d97, array($spb72f32['out_trade_no'], $spb72f32['total_fee'], $spb72f32['transaction_id'])); return true; } else { Log::debug('Pay.WeChat.verify, orderQuery failed. ' . json_encode($spb72f32)); return false; } } catch (\Throwable $sp3f4aab) { Log::error('Pay.WeChat.verify, orderQuery exception:. ' . $sp3f4aab->getMessage(), array('exception' => $sp3f4aab)); return false; } } } }
<?php
namespace App\Library\Pay\HLPay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { if (!isset($spc27de0['id'])) { throw new \Exception('请填写id'); } if (!isset($spc27de0['key'])) { throw new \Exception('请填写key'); } $sp9b2bb6 = sprintf('%.2f', $sp6956b3 / 100); $spd53b1c = $spc27de0['payway']; switch ($spd53b1c) { case '901': case '902': $spef6530 = 'wechat'; break; case '903': case '904': $spef6530 = 'aliqr'; break; default: throw new \Exception('支付渠道错误'); } $spe6f749 = SYS_URL . '/qrcode/pay/' . $spba04f6 . '/query'; $sp3e77f9 = array('pay_memberid' => $spc27de0['id'], 'pay_orderid' => $spba04f6, 'pay_applydate' => date('Y-m-d H:i:s'), 'pay_bankcode' => $spd53b1c, 'pay_notifyurl' => $this->url_notify, 'pay_callbackurl' => $spe6f749, 'pay_amount' => $sp9b2bb6, 'pay_productname' => $sp9f49de); $sp4aa83c = $this->getPostData($sp3e77f9, $spc27de0['key']); $sp4187a7 = $this->curl_post('http://henglpay.com/Pay_Index.html', $sp4aa83c); $sp29a775 = @json_decode($sp4187a7, true); if (!$sp29a775 || !isset($sp29a775['status'])) { Log::error('Pay.HLPay.goPay.order Error#1: ' . $sp4187a7); throw new \Exception('获取付款信息超时, 请刷新重试'); } if ($sp29a775['status'] !== '200' || !isset($sp29a775['data']['QRCodeUrl'])) { Log::error('Pay.HLPay.goPay.order Error#2: ' . $sp4187a7); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } if (@$sp29a775['data']['type'] === 'qrcode') { header('location: /qrcode/pay/' . $spba04f6 . '/' . strtolower($spef6530) . '?url=' . urlencode($sp29a775['data']['QRCodeUrl'])); } elseif ($sp29a775['type'] === 'page') { echo $sp29a775['data']['QRCodeUrl']; } elseif ($sp29a775['type'] === 'jsapi') { var_dump('未启用此方式: '); var_dump($sp29a775['data']['QRCodeUrl']); } else { Log::error('Pay.HLPay.goPay.order Error#3: ' . $sp4187a7); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; if ($spb2acff) { $spbf6b8b = array('memberid', 'orderid', 'transaction_id', 'amount', 'datetime', 'returncode'); $sp3e77f9 = array(); foreach ($spbf6b8b as $sp1a98b7) { $sp3e77f9[$sp1a98b7] = $_POST[$sp1a98b7]; } if ($this->getSign($sp3e77f9, $spc27de0['key']) !== $_POST['sign']) { Log::error('Pay.HLPay.verify, sign error $post:' . json_encode($_POST)); echo 'sign error'; return false; } $spd56469 = $_POST['orderid']; $spefaf7d = $_POST['transaction_id']; $sp4294a3($spd56469, (int) round($_POST['amount'] * 100), $spefaf7d); echo 'ok'; return true; } else { return false; } } private function getPostData($sp3e77f9, $sp7b7024) { ksort($sp3e77f9); $sp822fce = array(); foreach ($sp3e77f9 as $spe3274c => $spd7786b) { if ($spd7786b !== '' && !is_array($spd7786b)) { array_push($sp822fce, "{$spe3274c}={$spd7786b}"); } } $sp3e77f9 = implode('&', $sp822fce); $sp03f84e = $sp3e77f9 . '&key=' . $sp7b7024; return $sp3e77f9 . '&pay_md5sign=' . strtoupper(md5($sp03f84e)); } private function getSign($sp3e77f9, $sp7b7024) { ksort($sp3e77f9); $sp822fce = array(); foreach ($sp3e77f9 as $spe3274c => $spd7786b) { if ($spd7786b !== '' && !is_array($spd7786b)) { array_push($sp822fce, "{$spe3274c}={$spd7786b}"); } } $sp3e77f9 = implode('&', $sp822fce); $sp03f84e = $sp3e77f9 . '&key=' . $sp7b7024; return strtoupper(md5($sp03f84e)); } private function curl_post($sp3ae187, $sp4aa83c = '') { $spdf7b97['Accept'] = '*/*'; $spdf7b97['Referer'] = $sp3ae187; $spdf7b97['Content-Type'] = 'application/x-www-form-urlencoded'; $sp3c23e5 = array(); foreach ($spdf7b97 as $spee3fdf => $sp3c80c1) { $sp3c23e5[] = $spee3fdf . ': ' . $sp3c80c1; } $sp4e752c = curl_init(); curl_setopt($sp4e752c, CURLOPT_URL, $sp3ae187); curl_setopt($sp4e752c, CURLOPT_POST, 1); curl_setopt($sp4e752c, CURLOPT_POSTFIELDS, $sp4aa83c); curl_setopt($sp4e752c, CURLOPT_TIMEOUT, 10); curl_setopt($sp4e752c, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp4e752c, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp4e752c, CURLOPT_HEADER, 1); curl_setopt($sp4e752c, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp4e752c, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp4e752c, CURLOPT_HTTPHEADER, $sp3c23e5); $spad32e6 = curl_exec($sp4e752c); $sp5ec78e = curl_getinfo($sp4e752c, CURLINFO_HEADER_SIZE); $sp224c81 = substr($spad32e6, $sp5ec78e); curl_close($sp4e752c); return $sp224c81; } }
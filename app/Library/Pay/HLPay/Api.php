<?php
namespace App\Library\Pay\HLPay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp53f8aa) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp53f8aa; $this->url_return = SYS_URL . '/pay/return/' . $sp53f8aa; } function goPay($spbe80b7, $spa3e681, $sp45f07e, $sp873488, $sp5213ee) { if (!isset($spbe80b7['id'])) { throw new \Exception('请填写id'); } if (!isset($spbe80b7['key'])) { throw new \Exception('请填写key'); } $sp429fcc = sprintf('%.2f', $sp5213ee / 100); $spdc9a36 = $spbe80b7['payway']; switch ($spdc9a36) { case '901': case '902': $sp908e43 = 'wechat'; break; case '903': case '904': $sp908e43 = 'aliqr'; break; default: throw new \Exception('支付渠道错误'); } $sp2c8827 = SYS_URL . '/qrcode/pay/' . $spa3e681 . '/query'; $spa26894 = array('pay_memberid' => $spbe80b7['id'], 'pay_orderid' => $spa3e681, 'pay_applydate' => date('Y-m-d H:i:s'), 'pay_bankcode' => $spdc9a36, 'pay_notifyurl' => $this->url_notify, 'pay_callbackurl' => $sp2c8827, 'pay_amount' => $sp429fcc, 'pay_productname' => $sp45f07e); $sp0e98cb = $this->getPostData($spa26894, $spbe80b7['key']); $sp00a165 = $this->curl_post('http://henglpay.com/Pay_Index.html', $sp0e98cb); $spb9589c = @json_decode($sp00a165, true); if (!$spb9589c || !isset($spb9589c['status'])) { Log::error('Pay.HLPay.goPay.order Error#1: ' . $sp00a165); throw new \Exception('获取付款信息超时, 请刷新重试'); } if ($spb9589c['status'] !== '200' || !isset($spb9589c['data']['QRCodeUrl'])) { Log::error('Pay.HLPay.goPay.order Error#2: ' . $sp00a165); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } if (@$spb9589c['data']['type'] === 'qrcode') { header('location: /qrcode/pay/' . $spa3e681 . '/' . strtolower($sp908e43) . '?url=' . urlencode($spb9589c['data']['QRCodeUrl'])); } elseif ($spb9589c['type'] === 'page') { echo $spb9589c['data']['QRCodeUrl']; } elseif ($spb9589c['type'] === 'jsapi') { var_dump('未启用此方式: '); var_dump($spb9589c['data']['QRCodeUrl']); } else { Log::error('Pay.HLPay.goPay.order Error#3: ' . $sp00a165); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } die; } function verify($spbe80b7, $sp04f0f8) { $sp3bce01 = isset($spbe80b7['isNotify']) && $spbe80b7['isNotify']; if ($sp3bce01) { $sp595393 = array('memberid', 'orderid', 'transaction_id', 'amount', 'datetime', 'returncode'); $spa26894 = array(); foreach ($sp595393 as $spf39863) { $spa26894[$spf39863] = $_POST[$spf39863]; } if ($this->getSign($spa26894, $spbe80b7['key']) !== $_POST['sign']) { Log::error('Pay.HLPay.verify, sign error $post:' . json_encode($_POST)); echo 'sign error'; return false; } $sp7c88f3 = $_POST['orderid']; $spd63ffb = $_POST['transaction_id']; $sp04f0f8($sp7c88f3, (int) round($_POST['amount'] * 100), $spd63ffb); echo 'ok'; return true; } else { return false; } } private function getPostData($spa26894, $sp1ed429) { ksort($spa26894); $sp654541 = array(); foreach ($spa26894 as $spce2336 => $sp39a929) { if ($sp39a929 !== '' && !is_array($sp39a929)) { array_push($sp654541, "{$spce2336}={$sp39a929}"); } } $spa26894 = implode('&', $sp654541); $spa8f96c = $spa26894 . '&key=' . $sp1ed429; return $spa26894 . '&pay_md5sign=' . strtoupper(md5($spa8f96c)); } private function getSign($spa26894, $sp1ed429) { ksort($spa26894); $sp654541 = array(); foreach ($spa26894 as $spce2336 => $sp39a929) { if ($sp39a929 !== '' && !is_array($sp39a929)) { array_push($sp654541, "{$spce2336}={$sp39a929}"); } } $spa26894 = implode('&', $sp654541); $spa8f96c = $spa26894 . '&key=' . $sp1ed429; return strtoupper(md5($spa8f96c)); } private function curl_post($sp3db1b2, $sp0e98cb = '') { $sp28070b['Accept'] = '*/*'; $sp28070b['Referer'] = $sp3db1b2; $sp28070b['Content-Type'] = 'application/x-www-form-urlencoded'; $sp263179 = array(); foreach ($sp28070b as $sp0a9b77 => $spf9847c) { $sp263179[] = $sp0a9b77 . ': ' . $spf9847c; } $sp9b0943 = curl_init(); curl_setopt($sp9b0943, CURLOPT_URL, $sp3db1b2); curl_setopt($sp9b0943, CURLOPT_POST, 1); curl_setopt($sp9b0943, CURLOPT_POSTFIELDS, $sp0e98cb); curl_setopt($sp9b0943, CURLOPT_TIMEOUT, 10); curl_setopt($sp9b0943, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp9b0943, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp9b0943, CURLOPT_HEADER, 1); curl_setopt($sp9b0943, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp9b0943, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp9b0943, CURLOPT_HTTPHEADER, $sp263179); $sp3ac4e3 = curl_exec($sp9b0943); $sp70c798 = curl_getinfo($sp9b0943, CURLINFO_HEADER_SIZE); $sp873488 = substr($sp3ac4e3, $sp70c798); curl_close($sp9b0943); return $sp873488; } }
<?php
namespace App\Library\Pay\HLPay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { if (!isset($sp9d4382['id'])) { throw new \Exception('请填写id'); } if (!isset($sp9d4382['key'])) { throw new \Exception('请填写key'); } $spf59c91 = sprintf('%.2f', $sp076ec7 / 100); $spf9ca0c = $sp9d4382['payway']; switch ($spf9ca0c) { case '901': case '902': $spf9ad85 = 'wechat'; break; case '903': case '904': $spf9ad85 = 'aliqr'; break; default: throw new \Exception('支付渠道错误'); } $spd4aa96 = SYS_URL . '/qrcode/pay/' . $sp2e47fc . '/query'; $spc0e525 = array('pay_memberid' => $sp9d4382['id'], 'pay_orderid' => $sp2e47fc, 'pay_applydate' => date('Y-m-d H:i:s'), 'pay_bankcode' => $spf9ca0c, 'pay_notifyurl' => $this->url_notify, 'pay_callbackurl' => $spd4aa96, 'pay_amount' => $spf59c91, 'pay_productname' => $spd4e90d); $spe25017 = $this->getPostData($spc0e525, $sp9d4382['key']); $sp42422c = $this->curl_post('http://henglpay.com/Pay_Index.html', $spe25017); $sp9b52fe = @json_decode($sp42422c, true); if (!$sp9b52fe || !isset($sp9b52fe['status'])) { Log::error('Pay.HLPay.goPay.order Error#1: ' . $sp42422c); throw new \Exception('获取付款信息超时, 请刷新重试'); } if ($sp9b52fe['status'] !== '200' || !isset($sp9b52fe['data']['QRCodeUrl'])) { Log::error('Pay.HLPay.goPay.order Error#2: ' . $sp42422c); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } if (@$sp9b52fe['data']['type'] === 'qrcode') { header('location: /qrcode/pay/' . $sp2e47fc . '/' . strtolower($spf9ad85) . '?url=' . urlencode($sp9b52fe['data']['QRCodeUrl'])); } elseif ($sp9b52fe['type'] === 'page') { echo $sp9b52fe['data']['QRCodeUrl']; } elseif ($sp9b52fe['type'] === 'jsapi') { var_dump('未启用此方式: '); var_dump($sp9b52fe['data']['QRCodeUrl']); } else { Log::error('Pay.HLPay.goPay.order Error#3: ' . $sp42422c); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; if ($sp7b2182) { $sp55ae9a = array('memberid', 'orderid', 'transaction_id', 'amount', 'datetime', 'returncode'); $spc0e525 = array(); foreach ($sp55ae9a as $sp77f92d) { $spc0e525[$sp77f92d] = $_POST[$sp77f92d]; } if ($this->getSign($spc0e525, $sp9d4382['key']) !== $_POST['sign']) { Log::error('Pay.HLPay.verify, sign error $post:' . json_encode($_POST)); echo 'sign error'; return false; } $sp845b45 = $_POST['orderid']; $spca4fc7 = $_POST['transaction_id']; $sp9a4d97($sp845b45, (int) round($_POST['amount'] * 100), $spca4fc7); echo 'ok'; return true; } else { return false; } } private function getPostData($spc0e525, $spf1241f) { ksort($spc0e525); $spee4521 = array(); foreach ($spc0e525 as $sp17f3a7 => $sp75c248) { if ($sp75c248 !== '' && !is_array($sp75c248)) { array_push($spee4521, "{$sp17f3a7}={$sp75c248}"); } } $spc0e525 = implode('&', $spee4521); $sp04d007 = $spc0e525 . '&key=' . $spf1241f; return $spc0e525 . '&pay_md5sign=' . strtoupper(md5($sp04d007)); } private function getSign($spc0e525, $spf1241f) { ksort($spc0e525); $spee4521 = array(); foreach ($spc0e525 as $sp17f3a7 => $sp75c248) { if ($sp75c248 !== '' && !is_array($sp75c248)) { array_push($spee4521, "{$sp17f3a7}={$sp75c248}"); } } $spc0e525 = implode('&', $spee4521); $sp04d007 = $spc0e525 . '&key=' . $spf1241f; return strtoupper(md5($sp04d007)); } private function curl_post($spd2457c, $spe25017 = '') { $spc69671['Accept'] = '*/*'; $spc69671['Referer'] = $spd2457c; $spc69671['Content-Type'] = 'application/x-www-form-urlencoded'; $sp3db035 = array(); foreach ($spc69671 as $sp517f03 => $sp438dc5) { $sp3db035[] = $sp517f03 . ': ' . $sp438dc5; } $sp9f83d6 = curl_init(); curl_setopt($sp9f83d6, CURLOPT_URL, $spd2457c); curl_setopt($sp9f83d6, CURLOPT_POST, 1); curl_setopt($sp9f83d6, CURLOPT_POSTFIELDS, $spe25017); curl_setopt($sp9f83d6, CURLOPT_TIMEOUT, 10); curl_setopt($sp9f83d6, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp9f83d6, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp9f83d6, CURLOPT_HEADER, 1); curl_setopt($sp9f83d6, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp9f83d6, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp9f83d6, CURLOPT_HTTPHEADER, $sp3db035); $spdc5091 = curl_exec($sp9f83d6); $sp4c5a1f = curl_getinfo($sp9f83d6, CURLINFO_HEADER_SIZE); $spd0789a = substr($spdc5091, $sp4c5a1f); curl_close($sp9f83d6); return $spd0789a; } }
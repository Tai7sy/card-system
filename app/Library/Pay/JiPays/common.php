<?php
function create_link_string($sp012ade) { $sp822fce = array(); foreach ($sp012ade as $spe3274c => $spd7786b) { if ($spe3274c == 'sign' || $spe3274c == 'sign_type' || strval($spd7786b) === '') { continue; } $sp822fce[$spe3274c] = $spd7786b; } ksort($sp822fce); reset($sp822fce); $spe3a1c2 = ''; foreach ($sp822fce as $spe3274c => $spd7786b) { $spe3a1c2 .= $spe3274c . '=' . strval($spd7786b) . '&'; } $spe3a1c2 = trim($spe3a1c2, '&'); if (get_magic_quotes_gpc()) { $spe3a1c2 = stripslashes($spe3a1c2); } return $spe3a1c2; } function curl_http($sp3ae187, $sp3e77f9 = '', $sp888af6 = 'GET', $sp7b1947 = array()) { $sp4fabd4 = array(CURLOPT_TIMEOUT => 5, CURLOPT_RETURNTRANSFER => 1, CURLOPT_HEADER => 0, CURLOPT_FOLLOWLOCATION => 1, CURLOPT_SSL_VERIFYPEER => 0, CURLOPT_SSL_VERIFYHOST => 0, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_0, CURLOPT_IPRESOLVE => CURL_IPRESOLVE_V4); if ($sp7b1947) { $sp4fabd4[CURLOPT_HTTPHEADER] = $sp7b1947; } if (is_array($sp3e77f9)) { $sp3e77f9 = http_build_query($sp3e77f9); } switch (strtoupper($sp888af6)) { case 'GET': $sp4fabd4[CURLOPT_URL] = $sp3e77f9 ? $sp3ae187 . '?' . $sp3e77f9 : $sp3ae187; $sp4fabd4[CURLOPT_CUSTOMREQUEST] = 'GET'; break; case 'POST': $sp4fabd4[CURLOPT_URL] = $sp3ae187; $sp4fabd4[CURLOPT_POST] = 1; $sp4fabd4[CURLOPT_POSTFIELDS] = $sp3e77f9; break; default: break; } $sp4e752c = curl_init(); curl_setopt_array($sp4e752c, $sp4fabd4); $spb34b01 = curl_exec($sp4e752c); if ($spb34b01) { curl_close($sp4e752c); return $spb34b01; } else { $sp095a96 = curl_errno($sp4e752c); curl_close($sp4e752c); die('请求发起失败,错误码:' . $sp095a96); } } function create_rsa_sign($spd6e61f) { require './config.php'; $sp64a344 or die('私钥信息尚未配置,请检查'); $spcbc983 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($sp64a344, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; openssl_sign($spd6e61f, $sp75e4cc, $spcbc983, OPENSSL_ALGO_SHA256); $sp75e4cc = base64_encode($sp75e4cc); return $sp75e4cc; } function check_sign($sp3e77f9, $sp7b7024) { if (empty($sp3e77f9)) { return false; } if (!is_array($sp3e77f9)) { return false; } if (!isset($sp3e77f9['sign'])) { return false; } $spd6e61f = create_link_string($sp3e77f9); switch (strtoupper($sp3e77f9['sign_type'])) { case 'RSA2': $sp956999 or die('尚未设置网关RSA公钥'); $sp75e4cc = str_replace(' ', '+', $sp3e77f9['sign']); $sp719099 = '-----BEGIN PUBLIC KEY-----
' . wordwrap($sp956999, 64, '
', true) . '
-----END PUBLIC KEY-----'; $spb34b01 = (bool) openssl_verify($spd6e61f, base64_decode($sp75e4cc), $sp719099, OPENSSL_ALGO_SHA256); return $spb34b01; break; case 'SHA256': $sp75e4cc = hash('sha256', $spd6e61f . '&key=' . $sp3809aa); return boolval($sp75e4cc == $sp3e77f9['sign']); break; default: case 'MD5': $sp75e4cc = md5($spd6e61f . '&key=' . $sp3809aa); return boolval($sp75e4cc == $sp3e77f9['sign']); break; } } function is_weixin() { $sp1b63f1 = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : ''; if (strpos($sp1b63f1, 'MicroMessenger') !== false) { return true; } else { return false; } } function is_mobile() { if (isset($_SERVER['HTTP_VIA']) && stristr($_SERVER['HTTP_VIA'], 'wap')) { return true; } elseif (isset($_SERVER['HTTP_ACCEPT']) && strpos(strtoupper($_SERVER['HTTP_ACCEPT']), 'VND.WAP.WML')) { return true; } elseif (isset($_SERVER['HTTP_X_WAP_PROFILE']) || isset($_SERVER['HTTP_PROFILE'])) { return true; } elseif (isset($_SERVER['HTTP_USER_AGENT']) && preg_match('/(blackberry|configuration\\/cldc|hp |hp-|htc |htc_|htc-|iemobile|kindle|midp|mmp|motorola|mobile|nokia|opera mini|opera |Googlebot-Mobile|YahooSeeker\\/M1A1-R2D2|android|iphone|ipod|mobi|palm|palmos|pocket|portalmmm|ppc;|smartphone|sonyericsson|sqh|spv|symbian|treo|up.browser|up.link|vodafone|windows ce|xda |xda_)/i', $_SERVER['HTTP_USER_AGENT'])) { return true; } else { return false; } }
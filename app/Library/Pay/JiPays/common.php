<?php
function create_link_string($sp4b405d) { $sp654541 = array(); foreach ($sp4b405d as $spce2336 => $sp39a929) { if ($spce2336 == 'sign' || $spce2336 == 'sign_type' || strval($sp39a929) === '') { continue; } $sp654541[$spce2336] = $sp39a929; } ksort($sp654541); reset($sp654541); $spc05966 = ''; foreach ($sp654541 as $spce2336 => $sp39a929) { $spc05966 .= $spce2336 . '=' . strval($sp39a929) . '&'; } $spc05966 = trim($spc05966, '&'); if (get_magic_quotes_gpc()) { $spc05966 = stripslashes($spc05966); } return $spc05966; } function curl_http($sp3db1b2, $spa26894 = '', $sp2e8ea8 = 'GET', $sp79148a = array()) { $spcef4b3 = array(CURLOPT_TIMEOUT => 5, CURLOPT_RETURNTRANSFER => 1, CURLOPT_HEADER => 0, CURLOPT_FOLLOWLOCATION => 1, CURLOPT_SSL_VERIFYPEER => 0, CURLOPT_SSL_VERIFYHOST => 0, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_0, CURLOPT_IPRESOLVE => CURL_IPRESOLVE_V4); if ($sp79148a) { $spcef4b3[CURLOPT_HTTPHEADER] = $sp79148a; } if (is_array($spa26894)) { $spa26894 = http_build_query($spa26894); } switch (strtoupper($sp2e8ea8)) { case 'GET': $spcef4b3[CURLOPT_URL] = $spa26894 ? $sp3db1b2 . '?' . $spa26894 : $sp3db1b2; $spcef4b3[CURLOPT_CUSTOMREQUEST] = 'GET'; break; case 'POST': $spcef4b3[CURLOPT_URL] = $sp3db1b2; $spcef4b3[CURLOPT_POST] = 1; $spcef4b3[CURLOPT_POSTFIELDS] = $spa26894; break; default: break; } $sp9b0943 = curl_init(); curl_setopt_array($sp9b0943, $spcef4b3); $spbbda25 = curl_exec($sp9b0943); if ($spbbda25) { curl_close($sp9b0943); return $spbbda25; } else { $sp13aa4d = curl_errno($sp9b0943); curl_close($sp9b0943); die('请求发起失败,错误码:' . $sp13aa4d); } } function create_rsa_sign($sp9ad127) { require './config.php'; $spb2cd11 or die('私钥信息尚未配置,请检查'); $spe57db5 = '-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spb2cd11, 64, '
', true) . '
-----END RSA PRIVATE KEY-----'; openssl_sign($sp9ad127, $spa109d2, $spe57db5, OPENSSL_ALGO_SHA256); $spa109d2 = base64_encode($spa109d2); return $spa109d2; } function check_sign($spa26894, $sp1ed429) { if (empty($spa26894)) { return false; } if (!is_array($spa26894)) { return false; } if (!isset($spa26894['sign'])) { return false; } $sp9ad127 = create_link_string($spa26894); switch (strtoupper($spa26894['sign_type'])) { case 'RSA2': $spef873b or die('尚未设置网关RSA公钥'); $spa109d2 = str_replace(' ', '+', $spa26894['sign']); $spe1a8ef = '-----BEGIN PUBLIC KEY-----
' . wordwrap($spef873b, 64, '
', true) . '
-----END PUBLIC KEY-----'; $spbbda25 = (bool) openssl_verify($sp9ad127, base64_decode($spa109d2), $spe1a8ef, OPENSSL_ALGO_SHA256); return $spbbda25; break; case 'SHA256': $spa109d2 = hash('sha256', $sp9ad127 . '&key=' . $sp836c3d); return boolval($spa109d2 == $spa26894['sign']); break; default: case 'MD5': $spa109d2 = md5($sp9ad127 . '&key=' . $sp836c3d); return boolval($spa109d2 == $spa26894['sign']); break; } } function is_weixin() { $spf660f8 = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : ''; if (strpos($spf660f8, 'MicroMessenger') !== false) { return true; } else { return false; } } function is_mobile() { if (isset($_SERVER['HTTP_VIA']) && stristr($_SERVER['HTTP_VIA'], 'wap')) { return true; } elseif (isset($_SERVER['HTTP_ACCEPT']) && strpos(strtoupper($_SERVER['HTTP_ACCEPT']), 'VND.WAP.WML')) { return true; } elseif (isset($_SERVER['HTTP_X_WAP_PROFILE']) || isset($_SERVER['HTTP_PROFILE'])) { return true; } elseif (isset($_SERVER['HTTP_USER_AGENT']) && preg_match('/(blackberry|configuration\\/cldc|hp |hp-|htc |htc_|htc-|iemobile|kindle|midp|mmp|motorola|mobile|nokia|opera mini|opera |Googlebot-Mobile|YahooSeeker\\/M1A1-R2D2|android|iphone|ipod|mobi|palm|palmos|pocket|portalmmm|ppc;|smartphone|sonyericsson|sqh|spv|symbian|treo|up.browser|up.link|vodafone|windows ce|xda |xda_)/i', $_SERVER['HTTP_USER_AGENT'])) { return true; } else { return false; } }
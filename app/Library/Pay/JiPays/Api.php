<?php
namespace App\Library\Pay\JiPays; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; include_once 'common.php'; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3c46ab) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3c46ab; $this->url_return = SYS_URL . '/pay/return/' . $sp3c46ab; } function goPay($sp9d4382, $sp2e47fc, $spd4e90d, $spd0789a, $sp076ec7) { if (!isset($sp9d4382['id'])) { throw new \Exception('请填写id'); } if (!isset($sp9d4382['key'])) { throw new \Exception('请填写key'); } $spf59c91 = sprintf('%.2f', $sp076ec7 / 100); $spf9ca0c = $sp9d4382['payway']; switch ($spf9ca0c) { case '8001': case '8002': $spf9ad85 = 'wechat'; break; case '8004': case '8006': $spf9ad85 = 'aliqr'; break; default: throw new \Exception('支付渠道错误'); } $spd4aa96 = SYS_URL . '/qrcode/pay/' . $sp2e47fc . '/query'; $spc0e525 = array('mch_id' => $sp9d4382['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'timestamp' => date('Y-m-d H:i:s'), 'notify_url' => $this->url_notify, 'payment_code' => $spf9ca0c, 'out_trade_no' => $sp2e47fc, 'total_fee' => $spf59c91, 'body' => $spd0789a); $sp29fcf1 = create_link_string($spc0e525); $spc0e525['sign'] = md5($sp29fcf1 . '&key=' . $sp9d4382['key']); $sp06401d = array('Content-Type:application/x-www-form-urlencoded;charset=utf-8', 'X-Requested-With:XMLHttpRequest'); $spbccc31 = 'http://pay.jipays.com/gateway'; $spd2457c = rtrim($spbccc31, '/'); $sp42422c = curl_http(rtrim($spd2457c, '/'), $spc0e525, 'post', $sp06401d); $sp9b52fe = @json_decode($sp42422c, true); if (!$sp9b52fe || !isset($sp9b52fe['state'])) { Log::error('Pay.JiPays.goPay.order Error#1: ' . $sp42422c); throw new \Exception('获取付款信息超时, 请刷新重试'); } if ($sp9b52fe['state'] == '0') { Log::error('Pay.JiPays.goPay.order Error#2: ' . $sp42422c); throw new \Exception($sp9b52fe['msg']); } if (is_mobile() && is_weixin()) { header('Location:' . $sp9b52fe['data']['jump_url']); die; } $spd2457c = @strlen($sp9b52fe['data']['qrcode_url']) ? $sp9b52fe['data']['qrcode_url'] : $sp9b52fe['data']['jump_url']; if (strlen($spd2457c)) { header('location: /qrcode/pay/' . $sp2e47fc . '/' . strtolower($spf9ad85) . '?url=' . urlencode($spd2457c)); } else { Log::error('Pay.JiPays.goPay.order Error#3: ' . $sp42422c); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } die; } function verify($sp9d4382, $sp9a4d97) { $sp7b2182 = isset($sp9d4382['isNotify']) && $sp9d4382['isNotify']; if ($sp7b2182) { $spc0e525 = array('mch_id' => $sp9d4382['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'out_trade_no' => $_POST['out_trade_no'], 'timestamp' => $_POST['timestamp'], 'payment_code' => $_POST['payment_code'], 'body' => $_POST['body'], 'attach' => $_POST['attach'], 'total_fee' => $_POST['total_fee'], 'trade_no' => $_POST['trade_no'], 'channel_trade_no' => $_POST['channel_trade_no'], 'trade_status' => $_POST['trade_status'], 'payment_time' => $_POST['payment_time'], 'sign' => $_POST['sign']); if (md5(create_link_string($spc0e525) . '&key=' . $sp9d4382['key']) !== $spc0e525['sign']) { Log::error('Pay.JiPays.verify, sign error $post:' . json_encode($_POST)); echo 'fail'; return false; } if ($_POST['trade_status'] === 'TRADE_FINISHED') { $sp845b45 = $_POST['out_trade_no']; $spca4fc7 = $_POST['trade_no']; $sp9a4d97($sp845b45, (int) round($_POST['total_fee'] * 100), $spca4fc7); } echo 'success'; return true; } else { $sp2e47fc = @$sp9d4382['out_trade_no']; if (strlen($sp2e47fc) < 5) { throw new \Exception('交易单号未传入'); } $spc0e525 = array('mch_id' => $sp9d4382['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'timestamp' => date('Y-m-d H:i:s'), 'out_trade_no' => $sp2e47fc); $spc0e525['sign'] = md5(create_link_string($spc0e525) . '&key=' . $sp9d4382['key']); $sp06401d = array('Content-Type:application/x-www-form-urlencoded;charset=utf-8', 'X-Requested-With:XMLHttpRequest'); $spbccc31 = 'http://pay.jipays.com/gateway'; $spd2457c = rtrim($spbccc31, '/') . '/trade_query'; $sp42422c = curl_http(rtrim($spd2457c, '/'), $spc0e525, 'post', $sp06401d); $sp9b52fe = @json_decode($sp42422c, true); if (!$sp9b52fe || !isset($sp9b52fe['state'])) { Log::error('Pay.JiPays.verify Error#1: ' . $sp42422c); throw new \Exception('查询超时, 请刷新重试'); } if ($sp9b52fe['state'] == '0') { Log::error('Pay.JiPays.verify.verify Error#2: ' . $sp42422c); throw new \Exception($sp9b52fe['msg']); } if ($sp9b52fe['data']['trade_status'] === 'TRADE_FINISHED') { $sp845b45 = $sp9b52fe['data']['out_trade_no']; $spca4fc7 = $sp9b52fe['data']['trade_no']; $sp9a4d97($sp845b45, (int) round($sp9b52fe['data']['total_fee'] * 100), $spca4fc7); return true; } return false; } } }
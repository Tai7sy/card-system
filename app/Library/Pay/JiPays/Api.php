<?php
namespace App\Library\Pay\JiPays; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; include_once 'common.php'; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe00284) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe00284; $this->url_return = SYS_URL . '/pay/return/' . $spe00284; } function goPay($spc27de0, $spba04f6, $sp9f49de, $sp224c81, $sp6956b3) { if (!isset($spc27de0['id'])) { throw new \Exception('请填写id'); } if (!isset($spc27de0['key'])) { throw new \Exception('请填写key'); } $sp9b2bb6 = sprintf('%.2f', $sp6956b3 / 100); $spd53b1c = $spc27de0['payway']; switch ($spd53b1c) { case '8001': case '8002': $spef6530 = 'wechat'; break; case '8004': case '8006': $spef6530 = 'aliqr'; break; default: throw new \Exception('支付渠道错误'); } $spe6f749 = SYS_URL . '/qrcode/pay/' . $spba04f6 . '/query'; $sp3e77f9 = array('mch_id' => $spc27de0['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'timestamp' => date('Y-m-d H:i:s'), 'notify_url' => $this->url_notify, 'payment_code' => $spd53b1c, 'out_trade_no' => $spba04f6, 'total_fee' => $sp9b2bb6, 'body' => $sp224c81); $spd6e61f = create_link_string($sp3e77f9); $sp3e77f9['sign'] = md5($spd6e61f . '&key=' . $spc27de0['key']); $sp7b1947 = array('Content-Type:application/x-www-form-urlencoded;charset=utf-8', 'X-Requested-With:XMLHttpRequest'); $sp669180 = 'http://pay.jipays.com/gateway'; $sp3ae187 = rtrim($sp669180, '/'); $sp4187a7 = curl_http(rtrim($sp3ae187, '/'), $sp3e77f9, 'post', $sp7b1947); $sp29a775 = @json_decode($sp4187a7, true); if (!$sp29a775 || !isset($sp29a775['state'])) { Log::error('Pay.JiPays.goPay.order Error#1: ' . $sp4187a7); throw new \Exception('获取付款信息超时, 请刷新重试'); } if ($sp29a775['state'] == '0') { Log::error('Pay.JiPays.goPay.order Error#2: ' . $sp4187a7); throw new \Exception($sp29a775['msg']); } if (is_mobile() && is_weixin()) { header('Location:' . $sp29a775['data']['jump_url']); die; } $sp3ae187 = @strlen($sp29a775['data']['qrcode_url']) ? $sp29a775['data']['qrcode_url'] : $sp29a775['data']['jump_url']; if (strlen($sp3ae187)) { header('location: /qrcode/pay/' . $spba04f6 . '/' . strtolower($spef6530) . '?url=' . urlencode($sp3ae187)); } else { Log::error('Pay.JiPays.goPay.order Error#3: ' . $sp4187a7); throw new \Exception('获取付款信息失败, 请联系客服反馈'); } die; } function verify($spc27de0, $sp4294a3) { $spb2acff = isset($spc27de0['isNotify']) && $spc27de0['isNotify']; if ($spb2acff) { $sp3e77f9 = array('mch_id' => $spc27de0['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'out_trade_no' => $_POST['out_trade_no'], 'timestamp' => $_POST['timestamp'], 'payment_code' => $_POST['payment_code'], 'body' => $_POST['body'], 'attach' => $_POST['attach'], 'total_fee' => $_POST['total_fee'], 'trade_no' => $_POST['trade_no'], 'channel_trade_no' => $_POST['channel_trade_no'], 'trade_status' => $_POST['trade_status'], 'payment_time' => $_POST['payment_time'], 'sign' => $_POST['sign']); if (md5(create_link_string($sp3e77f9) . '&key=' . $spc27de0['key']) !== $sp3e77f9['sign']) { Log::error('Pay.JiPays.verify, sign error $post:' . json_encode($_POST)); echo 'fail'; return false; } if ($_POST['trade_status'] === 'TRADE_FINISHED') { $spd56469 = $_POST['out_trade_no']; $spefaf7d = $_POST['trade_no']; $sp4294a3($spd56469, (int) round($_POST['total_fee'] * 100), $spefaf7d); } echo 'success'; return true; } else { $spba04f6 = @$spc27de0['out_trade_no']; if (strlen($spba04f6) < 5) { throw new \Exception('交易单号未传入'); } $sp3e77f9 = array('mch_id' => $spc27de0['id'], 'sign_type' => 'MD5', 'charset' => 'utf-8', 'version' => '1.0', 'timestamp' => date('Y-m-d H:i:s'), 'out_trade_no' => $spba04f6); $sp3e77f9['sign'] = md5(create_link_string($sp3e77f9) . '&key=' . $spc27de0['key']); $sp7b1947 = array('Content-Type:application/x-www-form-urlencoded;charset=utf-8', 'X-Requested-With:XMLHttpRequest'); $sp669180 = 'http://pay.jipays.com/gateway'; $sp3ae187 = rtrim($sp669180, '/') . '/trade_query'; $sp4187a7 = curl_http(rtrim($sp3ae187, '/'), $sp3e77f9, 'post', $sp7b1947); $sp29a775 = @json_decode($sp4187a7, true); if (!$sp29a775 || !isset($sp29a775['state'])) { Log::error('Pay.JiPays.verify Error#1: ' . $sp4187a7); throw new \Exception('查询超时, 请刷新重试'); } if ($sp29a775['state'] == '0') { Log::error('Pay.JiPays.verify.verify Error#2: ' . $sp4187a7); throw new \Exception($sp29a775['msg']); } if ($sp29a775['data']['trade_status'] === 'TRADE_FINISHED') { $spd56469 = $sp29a775['data']['out_trade_no']; $spefaf7d = $sp29a775['data']['trade_no']; $sp4294a3($spd56469, (int) round($sp29a775['data']['total_fee'] * 100), $spefaf7d); return true; } return false; } } }
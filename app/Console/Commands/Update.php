<?php
namespace App\Console\Commands; use App\Library\CurlRequest; use function DeepCopy\deep_copy; use Illuminate\Console\Command; use Illuminate\Support\Str; class Update extends Command { protected $signature = 'update {--proxy=} {--proxy-auth=}'; protected $description = 'check update'; public function __construct() { parent::__construct(); } private function download_progress($spd2457c, $sp98dd00) { $sp26c226 = fopen($sp98dd00, 'w+'); if (!$sp26c226) { return false; } $sp9f83d6 = curl_init(); curl_setopt($sp9f83d6, CURLOPT_URL, $spd2457c); curl_setopt($sp9f83d6, CURLOPT_FOLLOWLOCATION, true); curl_setopt($sp9f83d6, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp9f83d6, CURLOPT_FILE, $sp26c226); curl_setopt($sp9f83d6, CURLOPT_PROGRESSFUNCTION, function ($sp1facb6, $spfddf8d, $sp32b55b, $spc41e48, $sp0e22a3) { if ($spfddf8d > 0) { echo '    download: ' . sprintf('%.2f', $sp32b55b / $spfddf8d * 100) . '%'; } }); curl_setopt($sp9f83d6, CURLOPT_NOPROGRESS, false); curl_setopt($sp9f83d6, CURLOPT_HEADER, 0); curl_setopt($sp9f83d6, CURLOPT_USERAGENT, 'card update'); curl_exec($sp9f83d6); curl_close($sp9f83d6); echo '
'; return true; } public function handle() { set_time_limit(0); $spa0fa4a = $this->option('proxy'); if (!empty($spa0fa4a)) { define('MY_PROXY', $spa0fa4a); } $spa75587 = $this->option('proxy-auth'); if (!empty($spa75587)) { define('MY_PROXY_PASS', $spa75587); } \Artisan::call('cache:clear'); \Artisan::call('config:clear'); echo '
'; $this->comment('检查更新中...'); $this->info('当前版本: ' . config('app.version')); $sp4d0456 = @json_decode(CurlRequest::get('https://raw.githubusercontent.com/Tai7sy/card-system/master/.version'), true); if (!@$sp4d0456['version']) { $this->warn('检查更新失败!'); $this->warn('Error: ' . ($sp4d0456 ? json_encode($sp4d0456) : 'Network error')); goto LABEL_EXIT; } if (config('app.version') >= $sp4d0456['version']) { $this->comment('您的版本已是最新!'); goto LABEL_EXIT; } $this->info('最新版本: ' . $sp4d0456['version']); $this->info('版本说明: ' . (@$sp4d0456['description'] ?? '无')); $sp5eeb86 = strtolower($this->ask('是否现在更新 (yes/no)', 'no')); if ($sp5eeb86 !== 'yes') { goto LABEL_EXIT; } $spe1433d = realpath(sys_get_temp_dir()); if (strlen($spe1433d) < 3) { $this->warn('获取临时目录失败!'); goto LABEL_EXIT; } $spe1433d .= DIRECTORY_SEPARATOR . Str::random(16); if (!mkdir($spe1433d) || !is_writable($spe1433d) || !is_readable($spe1433d)) { $this->warn('临时目录不可读写!'); goto LABEL_EXIT; } if (!function_exists('exec')) { $this->warn('函数 exec 已被禁用, 无法继续更新!'); goto LABEL_EXIT; } if (PHP_OS === 'WINNT') { $sp2003b5 = 'C:\\Program Files\\7-Zip\\7z.exe'; if (!is_file($sp2003b5)) { $sp2003b5 = strtolower($this->ask('未找到7-Zip, 请手动输入7zG.exe路径', $sp2003b5)); } if (!is_file($sp2003b5)) { $this->warn('7-Zip不可用, 请安装7-Zip后重试'); goto LABEL_EXIT; } $sp2003b5 = '"' . $sp2003b5 . '"'; } else { exec('tar --version', $spad2be8, $sp1bf350); if ($sp1bf350) { $this->warn('Error: tar --version 
' . join('
', $spad2be8)); goto LABEL_EXIT; } } $this->comment('正在下载新版本...'); $sp98dd00 = $spe1433d . DIRECTORY_SEPARATOR . 'ka_update_' . Str::random(16) . '.tmp'; if (!$this->download_progress($sp4d0456['url'], $sp98dd00)) { $this->warn('写入临时文件失败!'); goto LABEL_EXIT; } $sp565d4d = md5_file($sp98dd00); if ($sp565d4d !== $sp4d0456['md5']) { $this->warn('更新文件md5校验失败!, file:' . $sp565d4d . ', require:' . $sp4d0456['md5']); goto LABEL_EXIT; } $this->comment('正在解压...'); unset($spad2be8); if (PHP_OS === 'WINNT') { exec("{$sp2003b5} x -so {$sp98dd00} | {$sp2003b5} x -aoa -si -ttar -o{$spe1433d}", $spad2be8, $sp1bf350); } else { exec("tar -zxf {$sp98dd00} -C {$spe1433d}", $spad2be8, $sp1bf350); } if ($sp1bf350) { $this->warn('Error: 解压失败 
' . join('
', $spad2be8)); goto LABEL_EXIT; } $this->comment('正在关闭主站...'); \Artisan::call('down'); sleep(5); $this->comment(' --> 正在清理旧文件...'); $spbdeee3 = base_path(); foreach (array('app', 'bootstrap', 'config', 'public/dist', 'database', 'routes', 'vendor') as $sp14400e) { \File::deleteDirectory($spbdeee3 . DIRECTORY_SEPARATOR . $sp14400e); } $this->comment(' --> 正在复制新文件...'); \File::copyDirectory($spe1433d . DIRECTORY_SEPARATOR . 'card_system_free_dist', $spbdeee3); $this->comment(' --> 正在创建缓存...'); \Artisan::call('cache:clear'); \Artisan::call('route:cache'); \Artisan::call('config:cache'); $this->comment(' --> 正在更新数据库...'); \Artisan::call('migrate'); if (PHP_OS === 'WINNT') { echo '
'; $this->alert('请注意手动设置目录权限'); $this->comment('    storage 可读可写             '); $this->comment('    bootstrap/cache/ 可读可写    '); echo '

'; } else { $this->comment(' --> 正在设置目录权限...'); exec('rm -rf storage/framework/cache/data/*'); exec('chmod -R 777 storage/'); exec('chmod -R 777 bootstrap/cache/'); } $this->comment('正在启用主站...'); \Artisan::call('up'); \Artisan::call('queue:restart'); $spe23ad8 = true; LABEL_EXIT: if (isset($spe1433d) && strlen($spe1433d) > 19) { $this->comment('清理临时目录...'); \File::deleteDirectory($spe1433d); } if (isset($spe23ad8) && $spe23ad8) { $this->info('更新成功!'); } if (PHP_OS === 'WINNT') { } else { exec('rm -rf storage/framework/cache/data/*'); exec('chmod -R 777 storage/'); exec('chmod -R 777 bootstrap/cache/'); } echo '
'; die; } }
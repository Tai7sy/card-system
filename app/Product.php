<?php
namespace App; use App\Library\Helper; use Illuminate\Database\Eloquent\Model; class Product extends Model { protected $guarded = array(); protected $hidden = array(); const ID_API = -1001; const DELIVERY_AUTO = 0; const DELIVERY_MANUAL = 1; function getUrlAttribute() { return config('app.url') . '/p/' . Helper::id_encode($this->id, Helper::ID_TYPE_PRODUCT); } function getCountAttribute() { return $this->count_all - $this->count_sold; } function category() { return $this->belongsTo(Category::class); } function cards() { return $this->hasMany(Card::class); } function coupons() { return $this->hasMany(Coupon::class); } function orders() { return $this->hasMany(Order::class); } function user() { return $this->belongsTo(User::class); } public static function refreshCount($spd05c92) { \App\Card::where('user_id', $spd05c92->id)->selectRaw('`product_id`,SUM(`count_sold`) as `count_sold`,SUM(`count_all`) as `count_all`')->groupBy('product_id')->orderByRaw('`product_id`')->chunk(1000, function ($spa1cb2d) { foreach ($spa1cb2d as $spd384ba) { $spddd5a8 = \App\Product::where('id', $spd384ba->product_id)->first(); if ($spddd5a8->delivery === \App\Product::DELIVERY_AUTO) { $spddd5a8->update(array('count_sold' => $spd384ba->count_sold, 'count_all' => $spd384ba->count_all)); } else { $spddd5a8->update(array('count_sold' => $spd384ba->count_sold)); } } }); } function setForShop($spd05c92 = null) { $spddd5a8 = $this; $sp3bfbd2 = $spddd5a8->count; $spf3d646 = $spddd5a8->inventory; if ($spf3d646 == User::INVENTORY_AUTO) { $spf3d646 = System::_getInt('shop_inventory'); } if ($spf3d646 == User::INVENTORY_RANGE) { if ($sp3bfbd2 <= 0) { $spfdf3b5 = '不足'; } elseif ($sp3bfbd2 <= 10) { $spfdf3b5 = '少量'; } elseif ($sp3bfbd2 <= 20) { $spfdf3b5 = '一般'; } else { $spfdf3b5 = '大量'; } $spddd5a8->setAttribute('count2', $spfdf3b5); } else { $spddd5a8->setAttribute('count2', $sp3bfbd2); } $spddd5a8->setAttribute('count', $sp3bfbd2); $spddd5a8->setVisible(array('id', 'name', 'description', 'fields', 'delivery', 'count', 'count2', 'buy_min', 'buy_max', 'support_coupon', 'password_open', 'price', 'price_whole')); } }
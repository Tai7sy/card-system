<?php
namespace App\Http\Controllers; use App\Category; use App\Library\Helper; use App\Pay; use App\Product; use App\System; use App\User; use App\UserDomain; use Illuminate\Database\Eloquent\Relations\Relation; use Illuminate\Http\Request; use App\Library\Geetest; use Illuminate\Support\Facades\Auth; use Illuminate\Support\Facades\Cookie; class HomeController extends Controller { private function _shop_render($sp91cc0b, $sp6e5e3d = null, $sp886a9b = null) { $sp3125db = array('url' => config('app.url'), 'company' => config('app.company'), 'name' => config('app.name'), 'logo' => config('app.logo'), 'functions' => array()); if (System::_getInt('product_manual')) { $sp3125db['functions'][] = 'product_manual'; } if (System::_getInt('mail_send_order')) { $sp3125db['functions'][] = 'mail_send_order'; if (System::_getInt('mail_send_order_use_contact')) { $sp3125db['functions'][] = 'mail_send_order_use_contact'; } } if (System::_getInt('sms_send_order')) { $sp3125db['functions'][] = 'sms_send_order'; $sp3125db['sms_send_order'] = array('sms_price' => System::_getInt('sms_price')); } $sp3125db['captcha'] = array('driver' => System::_get('vcode_driver'), 'config' => array(), 'scene' => array('shop' => array('buy' => System::_getInt('vcode_shop_buy'), 'search' => System::_getInt('vcode_shop_search')))); if ($sp3125db['captcha']['driver'] === 'geetest') { $sp3125db['captcha']['config'] = Geetest\API::get(); } $spd3051c = Cookie::get('customer'); $sp112213 = Cookie::make('customer', strlen($spd3051c) !== 32 ? md5(str_random(16)) : $spd3051c, 43200, null, null, false, false); $spe4e7d2 = null; if (isset($_GET['theme'])) { $spe4e7d2 = \App\ShopTheme::whereName($_GET['theme'])->first(); } if ($sp91cc0b) { $sp3125db['shop'] = array('name' => config('app.name'), 'qq' => System::_get('shop_qq'), 'ann' => System::_get('shop_ann'), 'ann_pop' => System::_get('shop_ann_pop'), 'inventory' => System::_getInt('shop_inventory')); if ($sp886a9b) { $sp6e5e3d->setVisible(array('id', 'name', 'password_open')); if ($sp6e5e3d->password_open) { $sp6e5e3d->setAttribute('password', $sp6e5e3d->getTmpPassword()); $sp6e5e3d->addVisible(array('password')); } $sp886a9b->setForShop($sp91cc0b); $sp3125db['categories'] = array($sp6e5e3d); $sp3125db['product'] = $sp886a9b; $sp7fb7ec = $sp886a9b->name . ' - ' . $sp3125db['name']; $sp5e4978 = $sp886a9b->description; if (@$sp5e4978[0] === '{') { $sp58a80e = array(); preg_match_all('/"insert":"(.+?)"/', $sp5e4978, $sp58a80e); $sp5e4978 = str_replace('\\n', ' ', @join(' ', $sp58a80e[1])); } } elseif ($sp6e5e3d) { $sp6e5e3d->setVisible(array('id', 'name', 'password_open')); $sp3125db['categories'] = array($sp6e5e3d); $sp3125db['product'] = null; $sp7fb7ec = $sp6e5e3d->name . ' - ' . $sp3125db['name']; $sp5e4978 = $sp6e5e3d->name; } else { $sp173eab = Category::where('user_id', $sp91cc0b->id)->orderBy('sort')->where('enabled', 1)->get(); foreach ($sp173eab as $sp6e5e3d) { $sp6e5e3d->setVisible(array('id', 'name', 'password_open')); } $sp3125db['categories'] = $sp173eab; $sp7fb7ec = $sp3125db['name']; $sp5e4978 = $sp3125db['shop']['ann']; if (@$sp5e4978[0] === '{') { $sp58a80e = array(); preg_match_all('/"insert":"(.+?)"/', $sp5e4978, $sp58a80e); $sp5e4978 = str_replace('\\n', ' ', @join(' ', $sp58a80e[1])); } } $sp3125db['pays'] = \App\PayWay::gets($sp91cc0b, function ($sp479bde) { $sp479bde->where('type', \App\PayWay::TYPE_SHOP)->whereRaw('enabled&' . (Helper::is_mobile() ? \App\PayWay::ENABLED_MOBILE : \App\PayWay::ENABLED_PC) . '!=0'); }); if (!$spe4e7d2) { $spe4e7d2 = \App\ShopTheme::defaultTheme(); } $sp3125db['theme'] = $sp91cc0b->theme_config && isset($sp91cc0b->theme_config[$spe4e7d2->name]) ? $sp91cc0b->theme_config[$spe4e7d2->name] : $spe4e7d2->config; $sp7faadb = preg_replace('/[、，；。！？]/', ', ', $sp7fb7ec); } else { throw new \Exception('不可能到这'); } if (isset($sp3125db['theme']['background']) && $sp3125db['theme']['background'] === '内置1') { $sp3125db['theme']['background'] = Helper::b1_rand_background(); } if ($sp91cc0b && $sp886a9b === null) { if (@$sp3125db['theme']['list_type'] === 'list') { foreach ($sp3125db['categories'] as $sp33b130) { if (!$sp33b130->password_open) { $sp33b130->getProductsForShop(); } } } else { if (count($sp3125db['categories']) === 1) { $sp33b130 = $sp3125db['categories'][0]; if (!$sp33b130->password_open) { $sp33b130->getProductsForShop(); } } } } return response()->view('shop_theme.' . $spe4e7d2->name . '.index', array('name' => $sp7fb7ec, 'title' => config('app.title'), 'keywords' => $sp7faadb, 'description' => $sp5e4978, 'js_tj' => System::_get('js_tj'), 'js_kf' => System::_get('js_kf'), 'config' => $sp3125db))->cookie($sp112213); } public function shop_default(Request $spccbfb6) { $this->checkIsInMaintain(); $sp466c95 = $spccbfb6->get('tab', ''); return response()->redirectTo('/?theme=Material#/record?tab=' . $sp466c95); } private function _shop_404() { $this->checkIsInMaintain(); return view('message', array('title' => '404 NotFound', 'message' => '该链接不存在<br>
<a style="font-size: 18px" href="/?theme=Material#/record">查询订单</a>')); } public function shop_category($sp7c95c3) { $this->checkIsInMaintain(); $sp6e5e3d = Category::whereId(Helper::id_decode($sp7c95c3, Helper::ID_TYPE_CATEGORY))->with('user')->first(); if (!$sp6e5e3d && is_numeric($sp6e5e3d)) { $sp6e5e3d = Category::whereId($sp7c95c3)->where('created_at', '<', \Carbon\Carbon::createFromDate(2019, 1, 1))->with('user')->first(); } if (!$sp6e5e3d) { return $this->_shop_404(); } return $this->_shop_render($sp6e5e3d->user, $sp6e5e3d); } public function shop_product(Request $spccbfb6, $spe2ebc9) { $this->checkIsInMaintain(); $sp886a9b = Product::whereId(Helper::id_decode($spe2ebc9, Helper::ID_TYPE_PRODUCT))->with(array('user', 'category'))->first(); if (!$sp886a9b && is_numeric($spe2ebc9)) { $sp886a9b = Product::whereId($spe2ebc9)->where('created_at', '<', \Carbon\Carbon::createFromDate(2019, 1, 1))->with(array('user', 'category'))->first(); } if (!$sp886a9b || !$sp886a9b->category) { return $this->_shop_404(); } if ($sp886a9b->password_open && $sp886a9b->password !== $spccbfb6->input('p')) { return view('message', array('title' => '当前商品需要密码', 'message' => ($spccbfb6->has('p') ? '密码错误，请重新输入' : '请输入商品密码') . '<br>
<style type="text/css">
.content{ width: 100%;}
.password{display: block;margin: 8px auto;font-size: 14px;width: 90%;max-width: 340px;height: 30px;border: 1px solid #666; outline: none;padding: 0 10px;vertical-align: top;border-radius: 0;}
.confirm-btn{display: inline-block;width: 136px;height: 35px;line-height: 35px;border: none;text-align: center;font-size: 14px;text-decoration: none;cursor: pointer;margin-bottom: 15px;}
</style>
<div style="font-size: 14px">
<input id="password" type="password" class="password">
<button class="confirm-btn" onclick="location.href=location.href.split(\'?\')[0]+\'?p=\'+encodeURI(document.getElementById(\'password\').value)" style="">确认</button>
</div><br>
<a style="font-size: 18px" href="/s#/record">查询订单</a>&nbsp;&nbsp;
<a style="font-size: 18px" href="/s#/report">投诉订单</a>\'
')); } return $this->_shop_render($sp886a9b->user, $sp886a9b->category, $sp886a9b); } public function shop() { $this->checkIsInMaintain(); $sp91cc0b = User::firstOrFail(); return $this->_shop_render($sp91cc0b); } public function admin() { $sp3125db = array(); $sp3125db['url'] = config('app.url'); $sp3125db['captcha'] = array('driver' => System::_get('vcode_driver'), 'config' => array(), 'scene' => array('auth' => array('login' => System::_getInt('vcode_login_admin')))); if ($sp3125db['captcha']['driver'] === 'geetest') { $sp3125db['captcha']['config'] = Geetest\API::get(); } if (System::_getInt('product_manual')) { $sp3125db['functions'] = array('product_manual'); } return view('admin', array('config' => $sp3125db)); } }
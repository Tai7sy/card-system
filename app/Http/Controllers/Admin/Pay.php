<?php
namespace App\Http\Controllers\Admin; use App\Library\Helper; use Carbon\Carbon; use function foo\func; use Illuminate\Http\Request; use App\Http\Controllers\Controller; use App\Library\Response; class Pay extends Controller { function get(Request $sp0aae4c) { $spb0a50e = \App\Pay::orderBy('sort'); $sp22895e = $sp0aae4c->post('enabled'); if (strlen($sp22895e)) { $spb0a50e->whereIn('enabled', explode(',', $sp22895e)); } $spb66be1 = $sp0aae4c->post('search', false); $spc82c62 = $sp0aae4c->post('val', false); if ($spb66be1 && $spc82c62) { if ($spb66be1 == 'simple') { return Response::success($spb0a50e->get(array('id', 'name'))); } elseif ($spb66be1 == 'id') { $spb0a50e->where('id', $spc82c62); } else { $spb0a50e->where($spb66be1, 'like', '%' . $spc82c62 . '%'); } } $sp4e4cfe = $spb0a50e->get(); return Response::success(array('list' => $sp4e4cfe, 'urls' => array('url' => config('app.url'), 'url_api' => config('app.url_api')))); } function stat(Request $sp0aae4c) { $this->validate($sp0aae4c, array('day' => 'required|integer|between:1,30')); $sp05bd2e = (int) $sp0aae4c->input('day'); if ($sp05bd2e === 30) { $sp3adccd = Carbon::now()->addMonths(-1); } else { $sp3adccd = Carbon::now()->addDays(-$sp05bd2e); } $sp4e4cfe = $this->authQuery($sp0aae4c, \App\Order::class)->where(function ($spb0a50e) { $spb0a50e->where('status', \App\Order::STATUS_PAID)->orWhere('status', \App\Order::STATUS_SUCCESS); })->where('paid_at', '>=', $sp3adccd)->with(array('pay' => function ($spb0a50e) { $spb0a50e->select(array('id', 'name')); }))->groupBy('pay_id')->selectRaw('`pay_id`,COUNT(*) as "count",SUM(`paid`) as "sum"')->get()->toArray(); $spf96e67 = array(); foreach ($sp4e4cfe as $sp1a74be) { if (isset($sp1a74be['pay']) && isset($sp1a74be['pay']['name'])) { $sp23432e = $sp1a74be['pay']['name']; } else { $sp23432e = '未知方式#' . $sp1a74be['pay_id']; } $spf96e67[$sp23432e] = array((int) $sp1a74be['count'], (int) $sp1a74be['sum']); } return Response::success($spf96e67); } function edit(Request $sp0aae4c) { $this->validate($sp0aae4c, array('id' => 'required|integer', 'name' => 'required|string', 'img' => 'required|string', 'driver' => 'required|string', 'way' => 'required|string', 'config' => 'required|string')); $spaaa5c2 = (int) $sp0aae4c->post('id'); $sp023357 = $sp0aae4c->post('name'); $sp3c0e49 = $sp0aae4c->post('img'); $sp0ec8ac = $sp0aae4c->post('comment'); $spbce479 = $sp0aae4c->post('driver'); $sp87805f = $sp0aae4c->post('way'); $sp85fcba = $sp0aae4c->post('config'); $sp22895e = (int) $sp0aae4c->post('enabled'); $sp7023fd = \App\Pay::find($spaaa5c2); if (!$sp7023fd) { $sp7023fd = new \App\Pay(); } $sp7023fd->name = $sp023357; $sp7023fd->img = $sp3c0e49; $sp7023fd->comment = $sp0ec8ac; $sp7023fd->driver = $spbce479; $sp7023fd->way = $sp87805f; $sp7023fd->config = $sp85fcba; $sp7023fd->enabled = $sp22895e; $sp7023fd->fee_system = $sp0aae4c->post('fee_system'); $sp7023fd->saveOrFail(); return Response::success(); } function comment(Request $sp0aae4c) { $this->validate($sp0aae4c, array('id' => 'required|integer')); $spaaa5c2 = (int) $sp0aae4c->post('id'); $sp7023fd = \App\Pay::findOrFail($spaaa5c2); $sp7023fd->comment = $sp0aae4c->post('comment'); $sp7023fd->save(); return Response::success(); } function sort(Request $sp0aae4c) { $this->validate($sp0aae4c, array('id' => 'required|integer')); $spaaa5c2 = (int) $sp0aae4c->post('id'); $sp7023fd = \App\Pay::findOrFail($spaaa5c2); $sp7023fd->sort = (int) $sp0aae4c->post('sort', 1000); $sp7023fd->save(); return Response::success(); } function fee_system(Request $sp0aae4c) { $this->validate($sp0aae4c, array('id' => 'required|integer')); $spaaa5c2 = (int) $sp0aae4c->post('id'); $sp7023fd = \App\Pay::findOrFail($spaaa5c2); $sp7023fd->fee_system = $sp0aae4c->post('fee_system'); $sp7023fd->saveOrFail(); return Response::success(); } function enable(Request $sp0aae4c) { $this->validate($sp0aae4c, array('ids' => 'required|string', 'enabled' => 'required|integer|between:0,3')); $spcffd00 = $sp0aae4c->post('ids'); $sp22895e = (int) $sp0aae4c->post('enabled'); \App\Pay::whereIn('id', explode(',', $spcffd00))->update(array('enabled' => $sp22895e)); return Response::success(); } function delete(Request $sp0aae4c) { $this->validate($sp0aae4c, array('id' => 'required|integer')); $spaaa5c2 = (int) $sp0aae4c->post('id'); \App\Pay::whereId($spaaa5c2)->delete(); return Response::success(); } }
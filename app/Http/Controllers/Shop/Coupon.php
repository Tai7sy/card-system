<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp3c91bd) { $sp8af541 = (int) $sp3c91bd->post('category_id', -1); $sp5d967e = (int) $sp3c91bd->post('product_id', -1); $spda423d = $sp3c91bd->post('coupon'); if (!$spda423d) { return Response::fail('请输入优惠券'); } if ($sp8af541 > 0) { $spa74819 = Category::findOrFail($sp8af541); $spdad372 = $spa74819->user_id; } elseif ($sp5d967e > 0) { $spe7d79d = Product::findOrFail($sp5d967e); $spdad372 = $spe7d79d->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp5984c3 = \App\Coupon::where('user_id', $spdad372)->where('coupon', $spda423d)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp5984c3 as $spda423d) { if ($spda423d->category_id === -1 || $spda423d->category_id === $sp8af541 && ($spda423d->product_id === -1 || $spda423d->product_id === $sp5d967e)) { $spda423d->setVisible(array('discount_type', 'discount_val')); return Response::success($spda423d); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spbaac90) { $sp35f37e = (int) $spbaac90->post('category_id', -1); $sp1849cc = (int) $spbaac90->post('product_id', -1); $spdfcf19 = $spbaac90->post('coupon'); if (!$spdfcf19) { return Response::fail('请输入优惠券'); } if ($sp35f37e > 0) { $sp7a6bf9 = Category::findOrFail($sp35f37e); $sp45cf7f = $sp7a6bf9->user_id; } elseif ($sp1849cc > 0) { $sp73d110 = Product::findOrFail($sp1849cc); $sp45cf7f = $sp73d110->user_id; } else { return Response::fail('请先选择分类或商品'); } $spb38f3f = \App\Coupon::where('user_id', $sp45cf7f)->where('coupon', $spdfcf19)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spb38f3f as $spdfcf19) { if ($spdfcf19->category_id === -1 || $spdfcf19->category_id === $sp35f37e && ($spdfcf19->product_id === -1 || $spdfcf19->product_id === $sp1849cc)) { $spdfcf19->setVisible(array('discount_type', 'discount_val')); return Response::success($spdfcf19); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp26e527) { $sp735ffa = (int) $sp26e527->post('category_id', -1); $sp517398 = (int) $sp26e527->post('product_id', -1); $sp698fdf = $sp26e527->post('coupon'); if (!$sp698fdf) { return Response::fail(trans('shop.coupon.required')); } if ($sp735ffa > 0) { $sp08b465 = Category::findOrFail($sp735ffa); $sp699450 = $sp08b465->user_id; } elseif ($sp517398 > 0) { $sp222f58 = Product::findOrFail($sp517398); $sp699450 = $sp222f58->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $sp7aa1e0 = \App\Coupon::where('user_id', $sp699450)->where('coupon', $sp698fdf)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp7aa1e0 as $sp698fdf) { if ($sp698fdf->category_id === -1 || $sp698fdf->category_id === $sp735ffa && ($sp698fdf->product_id === -1 || $sp698fdf->product_id === $sp517398)) { $sp698fdf->setVisible(array('discount_type', 'discount_val')); return Response::success($sp698fdf); } } return Response::fail(trans('shop.coupon.invalid')); } }
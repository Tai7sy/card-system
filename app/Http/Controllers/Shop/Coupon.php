<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spa20801) { $sp664160 = (int) $spa20801->post('category_id', -1); $sp17d280 = (int) $spa20801->post('product_id', -1); $sp845919 = $spa20801->post('coupon'); if (!$sp845919) { return Response::fail('请输入优惠券'); } if ($sp664160 > 0) { $spdd6a6c = Category::findOrFail($sp664160); $sp6fe8b9 = $spdd6a6c->user_id; } elseif ($sp17d280 > 0) { $sp0a72f9 = Product::findOrFail($sp17d280); $sp6fe8b9 = $sp0a72f9->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp57c3d1 = \App\Coupon::where('user_id', $sp6fe8b9)->where('coupon', $sp845919)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp57c3d1 as $sp845919) { if ($sp845919->category_id === -1 || $sp845919->category_id === $sp664160 && ($sp845919->product_id === -1 || $sp845919->product_id === $sp17d280)) { $sp845919->setVisible(array('discount_type', 'discount_val')); return Response::success($sp845919); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
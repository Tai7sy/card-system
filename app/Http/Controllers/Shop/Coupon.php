<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spf09a96) { $sp8e3d37 = (int) $spf09a96->post('category_id', -1); $spb43b27 = (int) $spf09a96->post('product_id', -1); $sp14e5be = $spf09a96->post('coupon'); if (!$sp14e5be) { return Response::fail(trans('shop.coupon.required')); } if ($sp8e3d37 > 0) { $spf5ac2c = Category::findOrFail($sp8e3d37); $sp6738b1 = $spf5ac2c->user_id; } elseif ($spb43b27 > 0) { $sp551a82 = Product::findOrFail($spb43b27); $sp6738b1 = $sp551a82->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $sp21c0b9 = \App\Coupon::where('user_id', $sp6738b1)->where('coupon', $sp14e5be)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp21c0b9 as $sp14e5be) { if ($sp14e5be->category_id === -1 || $sp14e5be->category_id === $sp8e3d37 && ($sp14e5be->product_id === -1 || $sp14e5be->product_id === $spb43b27)) { $sp14e5be->setVisible(array('discount_type', 'discount_val')); return Response::success($sp14e5be); } } return Response::fail(trans('shop.coupon.invalid')); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp7fb11a) { $sp2dac50 = (int) $sp7fb11a->post('category_id', -1); $spac20cb = (int) $sp7fb11a->post('product_id', -1); $spdc4d06 = $sp7fb11a->post('coupon'); if (!$spdc4d06) { return Response::fail('请输入优惠券'); } if ($sp2dac50 > 0) { $spbbde80 = Category::findOrFail($sp2dac50); $sp95525e = $spbbde80->user_id; } elseif ($spac20cb > 0) { $spb0646a = Product::findOrFail($spac20cb); $sp95525e = $spb0646a->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp8bee14 = \App\Coupon::where('user_id', $sp95525e)->where('coupon', $spdc4d06)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp8bee14 as $spdc4d06) { if ($spdc4d06->category_id === -1 || $spdc4d06->category_id === $sp2dac50 && ($spdc4d06->product_id === -1 || $spdc4d06->product_id === $spac20cb)) { $spdc4d06->setVisible(array('discount_type', 'discount_val')); return Response::success($spdc4d06); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
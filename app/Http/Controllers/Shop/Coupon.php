<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp510ef3) { $sp40435f = (int) $sp510ef3->post('category_id', -1); $sp2f9632 = (int) $sp510ef3->post('product_id', -1); $spa1dd92 = $sp510ef3->post('coupon'); if (!$spa1dd92) { return Response::fail(trans('shop.coupon.required')); } if ($sp40435f > 0) { $sp577aae = Category::findOrFail($sp40435f); $sp3546ff = $sp577aae->user_id; } elseif ($sp2f9632 > 0) { $spd39704 = Product::findOrFail($sp2f9632); $sp3546ff = $spd39704->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $sp16f28c = \App\Coupon::where('user_id', $sp3546ff)->where('coupon', $spa1dd92)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp16f28c as $spa1dd92) { if ($spa1dd92->category_id === -1 || $spa1dd92->category_id === $sp40435f && ($spa1dd92->product_id === -1 || $spa1dd92->product_id === $sp2f9632)) { $spa1dd92->setVisible(array('discount_type', 'discount_val')); return Response::success($spa1dd92); } } return Response::fail(trans('shop.coupon.invalid')); } }
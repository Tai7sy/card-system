<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spccbfb6) { $sp76eadf = (int) $spccbfb6->post('category_id', -1); $spa981f6 = (int) $spccbfb6->post('product_id', -1); $spa389e8 = $spccbfb6->post('coupon'); if (!$spa389e8) { return Response::fail('请输入优惠券'); } if ($sp76eadf > 0) { $sp6e5e3d = Category::findOrFail($sp76eadf); $spe58da5 = $sp6e5e3d->user_id; } elseif ($spa981f6 > 0) { $sp886a9b = Product::findOrFail($spa981f6); $spe58da5 = $sp886a9b->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp44a76a = \App\Coupon::where('user_id', $spe58da5)->where('coupon', $spa389e8)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp44a76a as $spa389e8) { if ($spa389e8->category_id === -1 || $spa389e8->category_id === $sp76eadf && ($spa389e8->product_id === -1 || $spa389e8->product_id === $spa981f6)) { $spa389e8->setVisible(array('discount_type', 'discount_val')); return Response::success($spa389e8); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
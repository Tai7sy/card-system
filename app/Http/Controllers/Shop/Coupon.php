<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp517903) { $spc4a21e = (int) $sp517903->post('category_id', -1); $spb429e3 = (int) $sp517903->post('product_id', -1); $sp53e03c = $sp517903->post('coupon'); if (!$sp53e03c) { return Response::fail(trans('shop.coupon.required')); } if ($spc4a21e > 0) { $spe223d2 = Category::findOrFail($spc4a21e); $spacf00d = $spe223d2->user_id; } elseif ($spb429e3 > 0) { $sp427eba = Product::findOrFail($spb429e3); $spacf00d = $sp427eba->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $sp1da1a4 = \App\Coupon::where('user_id', $spacf00d)->where('coupon', $sp53e03c)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp1da1a4 as $sp53e03c) { if ($sp53e03c->category_id === -1 || $sp53e03c->category_id === $spc4a21e && ($sp53e03c->product_id === -1 || $sp53e03c->product_id === $spb429e3)) { $sp53e03c->setVisible(array('discount_type', 'discount_val')); return Response::success($sp53e03c); } } return Response::fail(trans('shop.coupon.invalid')); } }
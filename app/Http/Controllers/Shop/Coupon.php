<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp16eb02) { $sp2d88a9 = (int) $sp16eb02->post('category_id', -1); $spc53a3f = (int) $sp16eb02->post('product_id', -1); $sp6b2261 = $sp16eb02->post('coupon'); if (!$sp6b2261) { return Response::fail('请输入优惠券'); } if ($sp2d88a9 > 0) { $sp1012fd = Category::findOrFail($sp2d88a9); $spaa7e02 = $sp1012fd->user_id; } elseif ($spc53a3f > 0) { $sp48b1b0 = Product::findOrFail($spc53a3f); $spaa7e02 = $sp48b1b0->user_id; } else { return Response::fail('请先选择分类或商品'); } $spe553d3 = \App\Coupon::where('user_id', $spaa7e02)->where('coupon', $sp6b2261)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spe553d3 as $sp6b2261) { if ($sp6b2261->category_id === -1 || $sp6b2261->category_id === $sp2d88a9 && ($sp6b2261->product_id === -1 || $sp6b2261->product_id === $spc53a3f)) { $sp6b2261->setVisible(array('discount_type', 'discount_val')); return Response::success($sp6b2261); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spe5a184) { $sp23779d = (int) $spe5a184->post('category_id', -1); $sp89bb44 = (int) $spe5a184->post('product_id', -1); $sp133cc3 = $spe5a184->post('coupon'); if (!$sp133cc3) { return Response::fail(trans('shop.coupon.required')); } if ($sp23779d > 0) { $spf6286b = Category::findOrFail($sp23779d); $sp7aa9af = $spf6286b->user_id; } elseif ($sp89bb44 > 0) { $spb395ca = Product::findOrFail($sp89bb44); $sp7aa9af = $spb395ca->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $sp6219a1 = \App\Coupon::where('user_id', $sp7aa9af)->where('coupon', $sp133cc3)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp6219a1 as $sp133cc3) { if ($sp133cc3->category_id === -1 || $sp133cc3->category_id === $sp23779d && ($sp133cc3->product_id === -1 || $sp133cc3->product_id === $sp89bb44)) { $sp133cc3->setVisible(array('discount_type', 'discount_val')); return Response::success($sp133cc3); } } return Response::fail(trans('shop.coupon.invalid')); } }
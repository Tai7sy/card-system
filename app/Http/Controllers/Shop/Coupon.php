<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spba756f) { $sp55f32c = (int) $spba756f->post('category_id', -1); $sp1b83a8 = (int) $spba756f->post('product_id', -1); $sp8bf4fa = $spba756f->post('coupon'); if (!$sp8bf4fa) { return Response::fail('请输入优惠券'); } if ($sp55f32c > 0) { $sp1cd1e4 = Category::findOrFail($sp55f32c); $spf5ae13 = $sp1cd1e4->user_id; } elseif ($sp1b83a8 > 0) { $sp9dfc99 = Product::findOrFail($sp1b83a8); $spf5ae13 = $sp9dfc99->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp97692a = \App\Coupon::where('user_id', $spf5ae13)->where('coupon', $sp8bf4fa)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp97692a as $sp8bf4fa) { if ($sp8bf4fa->category_id === -1 || $sp8bf4fa->category_id === $sp55f32c && ($sp8bf4fa->product_id === -1 || $sp8bf4fa->product_id === $sp1b83a8)) { $sp8bf4fa->setVisible(array('discount_type', 'discount_val')); return Response::success($sp8bf4fa); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
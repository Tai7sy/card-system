<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spd5cc4d) { $sp7b7cc9 = (int) $spd5cc4d->post('category_id', -1); $spad8100 = (int) $spd5cc4d->post('product_id', -1); $sp8c149f = $spd5cc4d->post('coupon'); if (!$sp8c149f) { return Response::fail('请输入优惠券'); } if ($sp7b7cc9 > 0) { $sp2e76be = Category::findOrFail($sp7b7cc9); $spfaef2f = $sp2e76be->user_id; } elseif ($spad8100 > 0) { $spaeec37 = Product::findOrFail($spad8100); $spfaef2f = $spaeec37->user_id; } else { return Response::fail('请先选择分类或商品'); } $spa0d41d = \App\Coupon::where('user_id', $spfaef2f)->where('coupon', $sp8c149f)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spa0d41d as $sp8c149f) { if ($sp8c149f->category_id === -1 || $sp8c149f->category_id === $sp7b7cc9 && ($sp8c149f->product_id === -1 || $sp8c149f->product_id === $spad8100)) { $sp8c149f->setVisible(array('discount_type', 'discount_val')); return Response::success($sp8c149f); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
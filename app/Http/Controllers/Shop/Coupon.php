<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp0aae4c) { $sp18887c = (int) $sp0aae4c->post('category_id', -1); $sp2baf03 = (int) $sp0aae4c->post('product_id', -1); $spe01d85 = $sp0aae4c->post('coupon'); if (!$spe01d85) { return Response::fail('请输入优惠券'); } if ($sp18887c > 0) { $spe1f015 = Category::findOrFail($sp18887c); $sp9935c9 = $spe1f015->user_id; } elseif ($sp2baf03 > 0) { $spddd5a8 = Product::findOrFail($sp2baf03); $sp9935c9 = $spddd5a8->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp124ce4 = \App\Coupon::where('user_id', $sp9935c9)->where('coupon', $spe01d85)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp124ce4 as $spe01d85) { if ($spe01d85->category_id === -1 || $spe01d85->category_id === $sp18887c && ($spe01d85->product_id === -1 || $spe01d85->product_id === $sp2baf03)) { $spe01d85->setVisible(array('discount_type', 'discount_val')); return Response::success($spe01d85); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
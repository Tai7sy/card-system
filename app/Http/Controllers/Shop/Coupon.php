<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spdf16c9) { $spf26f7e = (int) $spdf16c9->post('category_id', -1); $spfb3e15 = (int) $spdf16c9->post('product_id', -1); $spd85029 = $spdf16c9->post('coupon'); if (!$spd85029) { return Response::fail(trans('shop.coupon.required')); } if ($spf26f7e > 0) { $spb98da4 = Category::findOrFail($spf26f7e); $spf93fb1 = $spb98da4->user_id; } elseif ($spfb3e15 > 0) { $sp94204a = Product::findOrFail($spfb3e15); $spf93fb1 = $sp94204a->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $spd84bc1 = \App\Coupon::where('user_id', $spf93fb1)->where('coupon', $spd85029)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spd84bc1 as $spd85029) { if ($spd85029->category_id === -1 || $spd85029->category_id === $spf26f7e && ($spd85029->product_id === -1 || $spd85029->product_id === $spfb3e15)) { $spd85029->setVisible(array('discount_type', 'discount_val')); return Response::success($spd85029); } } return Response::fail(trans('shop.coupon.invalid')); } }
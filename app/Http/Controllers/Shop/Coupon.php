<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp179c14) { $sp2521ab = (int) $sp179c14->post('category_id', -1); $spc00b16 = (int) $sp179c14->post('product_id', -1); $sp7109e6 = $sp179c14->post('coupon'); if (!$sp7109e6) { return Response::fail('请输入优惠券'); } if ($sp2521ab > 0) { $sp555b23 = Category::findOrFail($sp2521ab); $spf36aa8 = $sp555b23->user_id; } elseif ($spc00b16 > 0) { $sp434ec8 = Product::findOrFail($spc00b16); $spf36aa8 = $sp434ec8->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp1618d0 = \App\Coupon::where('user_id', $spf36aa8)->where('coupon', $sp7109e6)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp1618d0 as $sp7109e6) { if ($sp7109e6->category_id === -1 || $sp7109e6->category_id === $sp2521ab && ($sp7109e6->product_id === -1 || $sp7109e6->product_id === $spc00b16)) { $sp7109e6->setVisible(array('discount_type', 'discount_val')); return Response::success($sp7109e6); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spf066f3) { $spe478dd = (int) $spf066f3->post('category_id', -1); $spbb5d29 = (int) $spf066f3->post('product_id', -1); $sp38c2cc = $spf066f3->post('coupon'); if (!$sp38c2cc) { return Response::fail('请输入优惠券'); } if ($spe478dd > 0) { $sped57d9 = Category::findOrFail($spe478dd); $sp15a746 = $sped57d9->user_id; } elseif ($spbb5d29 > 0) { $sp2cf004 = Product::findOrFail($spbb5d29); $sp15a746 = $sp2cf004->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp659504 = \App\Coupon::where('user_id', $sp15a746)->where('coupon', $sp38c2cc)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp659504 as $sp38c2cc) { if ($sp38c2cc->category_id === -1 || $sp38c2cc->category_id === $spe478dd && ($sp38c2cc->product_id === -1 || $sp38c2cc->product_id === $spbb5d29)) { $sp38c2cc->setVisible(array('discount_type', 'discount_val')); return Response::success($sp38c2cc); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
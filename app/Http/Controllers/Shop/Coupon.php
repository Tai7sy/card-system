<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp13451b) { $sp3955fa = (int) $sp13451b->post('category_id', -1); $spcaeba2 = (int) $sp13451b->post('product_id', -1); $spdabd4e = $sp13451b->post('coupon'); if (!$spdabd4e) { return Response::fail(trans('shop.coupon.required')); } if ($sp3955fa > 0) { $spd58c4f = Category::findOrFail($sp3955fa); $spc2138c = $spd58c4f->user_id; } elseif ($spcaeba2 > 0) { $sp863814 = Product::findOrFail($spcaeba2); $spc2138c = $sp863814->user_id; } else { return Response::fail(trans('shop.please_select_category_or_product')); } $spd4c074 = \App\Coupon::where('user_id', $spc2138c)->where('coupon', $spdabd4e)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($spd4c074 as $spdabd4e) { if ($spdabd4e->category_id === -1 || $spdabd4e->category_id === $sp3955fa && ($spdabd4e->product_id === -1 || $spdabd4e->product_id === $spcaeba2)) { $spdabd4e->setVisible(array('discount_type', 'discount_val')); return Response::success($spdabd4e); } } return Response::fail(trans('shop.coupon.invalid')); } }
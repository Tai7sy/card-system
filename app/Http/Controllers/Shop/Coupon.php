<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spfb5ae3) { $sp66458a = (int) $spfb5ae3->post('category_id', -1); $sp3edfae = (int) $spfb5ae3->post('product_id', -1); $sp81431c = $spfb5ae3->post('coupon'); if (!$sp81431c) { return Response::fail('请输入优惠券'); } if ($sp66458a > 0) { $sp0ff930 = Category::findOrFail($sp66458a); $sp134e80 = $sp0ff930->user_id; } elseif ($sp3edfae > 0) { $sp7eba0d = Product::findOrFail($sp3edfae); $sp134e80 = $sp7eba0d->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp7cc331 = \App\Coupon::where('user_id', $sp134e80)->where('coupon', $sp81431c)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp7cc331 as $sp81431c) { if ($sp81431c->category_id === -1 || $sp81431c->category_id === $sp66458a && ($sp81431c->product_id === -1 || $sp81431c->product_id === $sp3edfae)) { $sp81431c->setVisible(array('discount_type', 'discount_val')); return Response::success($sp81431c); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }
<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp7f7104) { $sp92ffbb = (int) $sp7f7104->post('category_id', -1); $sp727288 = (int) $sp7f7104->post('product_id', -1); $sp48f854 = $sp7f7104->post('coupon'); if (!$sp48f854) { return Response::fail('请输入优惠券'); } if ($sp92ffbb > 0) { $sp45344f = Category::findOrFail($sp92ffbb); $sp279789 = $sp45344f->user_id; } elseif ($sp727288 > 0) { $spfa410d = Product::findOrFail($sp727288); $sp279789 = $spfa410d->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp832842 = \App\Coupon::where('user_id', $sp279789)->where('coupon', $sp48f854)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp832842 as $sp48f854) { if ($sp48f854->category_id === -1 || $sp48f854->category_id === $sp92ffbb && ($sp48f854->product_id === -1 || $sp48f854->product_id === $sp727288)) { $sp48f854->setVisible(array('discount_type', 'discount_val')); return Response::success($sp48f854); } } return Response::fail('您输入的优惠券信息无效<br>如果没有优惠券请不要填写'); } }